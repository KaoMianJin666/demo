var e=Object.defineProperty,t=(t,a,l)=>((t,a,l)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[a]=l)(t,"symbol"!=typeof a?a+"":a,l);import{X as a,G as l,Y as s,T as i,Q as n,r,k as o,m as d,n as u,C as c,O as h,B as m,u as v,H as p,y as g,F as y,A as f,D as w,I as b,o as D,j as k,p as x,w as I,L as C,E as _,v as T,x as M,K as S,M as E,J as L,Z as A,_ as O,$ as z,a0 as U,N as R}from"./lib-CKDAqxUM.js";import{a as G,z as N,A as P,B as j,s as F,C as H,v as Y,D as W,E as X,x as B,F as $,G as J,H as Z,I as V,y as Q,l as q,J as K,K as ee,L as te}from"./index-ozdrtwfE.js";import{m as ae,r as le,b as se,d as ie,u as ne}from"./index-QuXMKZDh.js";import{u as re,f as oe,a as de,b as ue,c as ce,j as he,r as me,d as ve}from"./file-BA4XvZMH.js";import{u as pe,o as ge}from"./opInput-BG7l2a3t.js";import{s as ye,u as fe,a as we}from"./promptSetting-DYZR4Zy5.js";import{s as be,u as De}from"./artwork-DCQ-_8A2.js";import{T as ke}from"./TLoading-DiViiRSi.js";import{_ as xe}from"./_plugin-vue_export-helper-BCo6x5W8.js";/* empty css                                                                 */import{m as Ie}from"./menu-B85Lp49n.js";const Ce="操作",_e={NOMAL:"定位花",AGENT_X:"横向二方连续",AGENT_Y:"纵向二方连续",AGENT_F:"四方连续"},Te={NOMAL:{name:"定位花",value:null},AGENT_X:{name:"横向二方连续",value:"tile_x"},AGENT_Y:{name:"纵向二方连续",value:"tile_y"},AGENT_F:{name:"四方连续",value:"tile_xy"}},Me="editor",Se="explosion",Ee={statics:"静态层",prompts:"动态层",colors:"纯色层",texts:"文本层"};class Le{constructor(e,t,a="",l=0){this.name=a,this.uuid=e,this.parentUuid=t,this.isShow=!0,this.children=[],this.zIndex=l}addChild(e){this.children.push(e)}changeParent(e){this.parentUuid=e}updateData(e={}){Object.keys(e).forEach((t=>{this[t]=e[t]}))}hide(){this.isShow=!1}show(){this.isShow=!0}}const Ae=["add_layer","update_layer","delete_layer","add_element","update_element","delete_element","bind_group","unbind_group","delete_group","update_zindex","generate","copy"];let Oe=a([]);const ze=e=>{const t=Object.keys(Wt.groups).find((t=>Wt.groups[t].name===e)),a=Object.keys(Wt.layers).find((t=>Wt.layers[t].name===e)),l=Object.keys(Wt.elements).find((t=>Wt.elements[t].name===e));return t?{uuid:t,type:"group",data:Wt.findData("group",t)}:a?{uuid:a,type:"layer",data:Wt.findData("layer",a)}:l?{uuid:l,type:"element",data:Wt.findData("element",l)}:void 0},Ue=async({atom:e,parameters:t})=>{const a=(e=>{let t=!0,a="检测通过";return Ae.find((t=>t===e))||(t=!1,a="错误的操作类型"),{status:t,msg:a}})(e);if(a.status)switch(e){case"add_layer":if(!(await(async e=>{const{name:t,tileType:a,type:l,resourceId:s}=e;e.imageUrl&&(e.image=await re(e.imageUrl),delete e.imageUrl),await Wt.add("layer",null,t,{tileType:a,type:l,resourceId:s},null,null),Wt.reDraw()})(t)))return!1;break;case"update_layer":if(!(await(async e=>{const{name:t}=e,a=Object.keys(Wt.layers).find((e=>Wt.layers[e].name===t)),l=Wt.findData("layer",a);e.imageUrl&&(e.image=await re(e.imageUrl),delete e.imageUrl),l.setData(e),Wt.reDraw()})(t)))return!1;break;case"delete_layer":if(!(e=>{const{name:t}=e,a=Object.keys(Wt.layers).find((e=>Wt.layers[e].name===t));Wt.delete("layer",a),Wt.reDraw()})(t))return!1;break;case"add_element":if(!(await(async e=>{const{name:t,parentName:a,x:l,y:s,width:i,height:n,opacity:r}=e;e.imageUrl&&(e.image=await re(e.imageUrl),delete e.imageUrl);const o=Object.keys(Wt.layers).find((e=>Wt.layers[e].name===a));await Wt.add("element",o,t,{x:l,y:s,width:i,height:n,opacity:r,image:e.image||null},null,null),Wt.reDraw()})(t)))return!1;break;case"update_element":if(!(await(async e=>{const{name:t}=e,a=Object.keys(Wt.elements).find((e=>Wt.elements[e].name===t)),l=Wt.findData("element",a);e.imageUrl&&(e.image=await re(e.imageUrl),delete e.imageUrl),l.setData(e),Wt.reDraw()})(t)))return!1;break;case"delete_element":if(!(e=>{const{name:t}=e,a=Object.keys(Wt.elements).find((e=>Wt.elements[e].name===t));Wt.delete("element",a),Wt.reDraw()})(t))return!1;break;case"bind_group":if(!(await(async e=>{const{name:t,layerNames:a}=e;Object.keys(Wt.groups).find((e=>Wt.groups[e].name===t))||2!==a.length?1===a.length&&await Wt.bindGroup({fromData:ze(a[0]),toData:ze(t)},null):await Wt.bindGroup({fromData:ze(a[0]),toData:ze(a[1])},t)})(t)))return!1;break;case"unbind_group":if(!(e=>{const{layerName:t}=e,a=ze(t);Wt.unbindGroup(a)})(t))return!1;break;case"delete_group":if(!(e=>{const{name:t}=e,a=Object.keys(Wt.groups).find((e=>Wt.groups[e].name===t));Wt.delete("group",a)})(t))return!1;break;case"update_zindex":if(!(e=>{const{fromName:t,toName:a}=e,l=ze(t),s=ze(a),i=s.zIndex;Wt.bindGroup({fromData:l,toData:s,zIndex:i},null)})(t))return!1;break;case"generate":break;case"copy":if(!(e=>{const{name:t}=e,{type:a,uuid:l,data:s}=ze(t);Wt.copyData(l,a,s.parentUuid)})(t))return!1}else ae.error(a.msg)},Re=({atom:e,parameters:t})=>{Object.keys(t).forEach((e=>{t[e]||delete t[e]})),t.image&&(t.imageUrl=t.image.src,delete t.image),Oe.push({atom:e,parameters:t})},Ge=()=>{Oe=[]};const Ne=(e,t)=>t===e.length,Pe=(e,t=0,a=0,l=[])=>{const s=e[t];return new Promise((i=>{var n;(n=s,le.post("/oplus/query_task",{task_id:n})).then((s=>{"error"===s.data.task_status?(a=0,t+=1,l.push("")):"processing"===s.data.task_status?++a>=30&&(a=0,t+=1,l.push("")):(a=0,t+=1,l.push(s.data)),Ne(e,t)?i(l):setTimeout((()=>{i(Pe(e,t,a,l))}),2e3)})).catch((s=>{Ne(e,t+=1)?i(l):setTimeout((()=>{i(Pe(e,t,a,l))}),2e3)}))}))},je=(e,t)=>{switch(e){case"prompts":return function(e){return le.post("/oplus/generate_prompts",e)}(t);case"statics":return function(e){return le.post("/oplus/generate_statics",e)}(t);case"colors":return function(e){return le.post("/oplus/generate_colors",e)}(t)}};class Fe{constructor(e=null,a=null){t(this,"getGenerateResult",(e=>Pe(e))),this.name=e,this.template_id=a}getGenrateTaskId(e,t,a){return new Promise((l=>{je(e,Object.assign({resource_id:t.resource_id,resource_name:t.resource_name,prompt:t.prompt},{num_images:a})).then((e=>{l(e.data)})).catch((e=>{l(null)}))}))}getGroupTaskResult(e=[],t=0,a={}){const l=e[t],{children:s}=l;return new Promise((i=>{this.getGenrateTaskId(l.dataType,l,s.length).then((l=>{this.getGenerateResult(l).then((l=>{s.forEach(((e,t)=>{a[e]=l[t]})),++t===e.length?i(a):i(this.getGroupTaskResult(e,t,a))}))})).catch((e=>{i(a)}))}))}getLayerTaskResult(e){const{uuid:t}=e;return new Promise((a=>{this.getGenrateTaskId(e.dataType,e,1).then((e=>{this.getGenerateResult(e).then((([e])=>{a({[t]:e})}))})).catch((e=>{a({})}))}))}getElementTaskResult(e,t,a=0){return new Promise((a=>{this.getGenrateTaskId(t.dataType,t,1).then((t=>{this.getGenerateResult(t).then((([t])=>{a({[e]:t})})).catch((()=>{a({[e]:null})}))}))}))}imgGenerateImg(e,t){return new Promise((a=>{(function(e,t){return le.post(`/oplus/img2img?image_url=${e}&similarity=${t}`)})(e,t).then((e=>{this.getGenerateResult(e.data).then((([e])=>{a({image:e})})).catch((()=>{a({image:null})}))}))}))}setName(e){this.name=e}setId(e){this.template_id=e}}const He=(e,t)=>{const a=document.createElement("a");a.href=e,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a)},Ye=ae,We={All:"全部生成",Layer:"单层生成",Element:"单元素生成",Group:"单组生成",Artwork:"导出作品",Template:"导出模板"},Xe="正常模式",Be="图生图",$e="导出psd";const Je=new class{constructor(){this.taskList=a([]),this.activeUuid=null}addTask(e,t,s,i=[],n=Xe){const r=l(),o=se.currentRoute,d=a({uuid:r,template_id:e,template_name:t,name:`${t||"暂存文件"}-${n===Xe||n===$e?We[s]:Be}`,taskType:s,progress:0,subTaskIndex:0,generateType:n,isFinish:!1,fromPath:o.value.path});i.length?(i.forEach((e=>{e.result=null})),d.subTask=i):(d.subTask=[d],d.subTask[0].result=null),this.taskList.push(d),this.activeUuid||(this.activeUuid=r,this.startTask()),Ye.success("任务已添加至队列")}async startTask(){if(!this.activeUuid)return;const e=this.taskList.find((({uuid:e})=>e===this.activeUuid)),{generateType:t,subTask:a,template_id:l,template_name:s}=e,i=new Fe(s,l);for(let d=0;d<a.length;d++){e.subTaskIndex=d;const{type:l}=a[d];let s=null;if(t===Xe){if("Group"===l)try{s=await i.getGroupTaskResult([a[d]])}catch(o){}else if("Layer"===l)try{s=await i.getLayerTaskResult(a[d])}catch(o){}else if("Element"===l)try{s=await i.getElementTaskResult(a[d].uuid,a[d])}catch(o){}}else if(t===Be){const e=a[d],{imageUrl:t,similarity:l}=e;s=await i.imgGenerateImg(t,l)}else if(t===$e){const e=a[d],t=(await(n=e,le.post("/oplus/export_psd",n))).data;s=(await Pe([t]))[0].task_result}a[d].result=s,e.progress=Math.round((d+1)/a.length*100)}var n;e.isFinish=!0;const r=this.taskList.findIndex((({uuid:e})=>e===this.activeUuid));r<this.taskList.length-1?(this.activeUuid=this.taskList[r+1].uuid,this.startTask()):this.activeUuid=null,await this.setTaskResult([e])}async setTaskResult(e=this.taskList){let t=[];for(let a=0;a<e.length;a++){const l=e[a],{generateType:s,subTask:i,template_id:n,uuid:r}=l,o=se.currentRoute;if(!l.isFinish)break;if(s===Xe){if(!("/basic/modelEditor"!==o.value.path&&"/basic/generateImage"!==o.value.path&&"/basic/artWorkEditor"!==o.value.path&&"/basic/updateModel"!==o.value.path&&"/basic/artWorkInfo"!==o.value.path||o.value.query.template_id!==n&&Xt.templateId!==n)){Ye.success(`${l.name} 生成完成，更新页面`);for(let e=0;e<i.length;e++){const{type:t}=i[e];switch(t){case"Group":await Yt.setGroupGenerateResult(i[e].result);break;case"Layer":await Yt.setLayerGenerateResult(i[e].result);break;case"Element":await Yt.setElemenyGenerateResult(i[e].result,i[e].uuid)}}Xt.changeHandleType(Ce),t.push(r)}}else if(s===Be){if(!("/basic/modelEditor"!==o.value.path&&"/basic/generateImage"!==o.value.path&&"/basic/artWorkEditor"!==o.value.path&&"/basic/updateModel"!==o.value.path&&"/basic/artWorkInfo"!==o.value.path||o.value.query.template_id!==n&&Xt.templateId!==n)){Ye.success(`${l.name} 生成完成，更新页面`);const[e]=i,{uuid:a,result:s}=e,n=Wt.findData("element",a);t.push(a),Xt.contextMenu({},n,"prompts",s.image.task_result),Xt.changeHandleType(Ce)}}else if(s===$e){Ye.success(`${l.name} 导出完成，开始下载`);for(let e=0;e<i.length;e++){const{result:a}=i[e];He(a,`${l.name}.psd`),t.push(r)}}}t.forEach((e=>{const t=this.taskList.findIndex((t=>t.uuid=e));this.taskList.splice(t,1)}))}checkInTask(){const e=se.currentRoute;return("/basic/modelEditor"===e.value.path||"/basic/generateImage"===e.value.path||"/basic/artWorkEditor"===e.value.path||"/basic/updateModel"===e.value.path||"/basic/modelEditor"===e.value.path)&&Boolean(this.taskList.length&&this.taskList.find((({template_id:e})=>Xt.templateId===e)))}getTaskList(){return this.taskList}},Ze=ae,Ve={group:class extends Le{constructor(e,t,a,l={}){super(e,t,a),this.resource_id=l.resource_id,this.resource_name=l.resource_name}setData(e={},t=0){if(0===t){const t={name:this.name};e.name&&e.name!==this.name&&(t.newName=e.name),Object.keys(e).forEach((a=>{e[a]!==this[a]&&(t[a]=e[a])})),Re({atom:"update_group",parameters:t})}this.updateData(e)}},layer:class extends Le{constructor(e,t,a,l={}){super(e,t,a),this.resource_id=l.resource_id,this.resource_name=l.resource_name,this.image=l.image||null,this.type=l.type||null,this.tileType=l.tileType||null,this.prompt=l.prompt||"",this.fontSetting=l.fontSetting||{content:"默认文本",font:"",fontFamily:"PingFangSC",font_color:[255,255,255,1],font_size:64}}setData(e={},t=0){if(0===t){const t={name:this.name};e.name&&e.name!==this.name&&(t.newName=e.name),Object.keys(e).forEach((a=>{e[a]!==this[a]&&(t[a]=e[a])})),e.image&&(t.imageUrl=e.image.src),Re({atom:"update_layer",parameters:t})}this.updateData(e)}},element:class extends Le{constructor(e,t,a,l={}){super(e,t,a),this.x=l.x,this.y=l.y,this.width=l.width,this.height=l.height,this.image=l.image,this.rotate=l.rotate||0,this.type=l.type||null,this.tileType=l.tileType||null,this.lightness=l.lightness||0,this.opacity=l.opacity||1,this.xOverturn=l.xOverturn||!1,this.yOverturn=l.yOverturn||!1,this.colorGradation=l.colorGradation||null,this.hue=Array.isArray(l.hue)?l.hue:null,this.saturation=l.saturation||1,this.edgeFeather=l.edgeFeather||0,this.fontSetting=l.fontSetting||{content:"默认文本",font:"",fontFamily:"PingFangSC",font_color:[255,255,255,1],font_size:64},this.color=l.color||[0,0,0,1],this.handleImage=l.handleImage||null,this.virtuallyElements=l.virtuallyElements||[]}setData(e={},t=1,a=null){const l=a||this;if(a&&((e=JSON.parse(JSON.stringify(this))).image=this.image,e.handleImage=this.handleImage),t){const t={name:l.name};e.name&&e.name!==l.name&&(t.newName=e.name),Object.keys(e).forEach((a=>{String(e[a])!==String(l[a])&&(t[a]=e[a])})),e.image&&(t.imageUrl=e.image.src),Re({atom:"update_element",parameters:t})}this.updateData(e)}}},Qe={group:{parentType:null,childrenType:"layer"},layer:{parentType:"group",childrenType:"element"},element:{parentType:"layer",childrenType:null}};class qe{constructor(){this.groups=a({}),this.layers=a({}),this.elements=a({}),this.showMap=a({groups:new Set,layers:new Set}),this.selectedMap=a({group:null,layer:null,element:null})}async add(e,t,a,s={},i=null,n=null,r=0){const o=Ve[e],d=this.findParent(t),u=this[`${e}s`];if(!o)throw new Error(`Unknown type: ${e}`);if(i){if(u[i]=new o(i,t,a,s),0===r&&Re({atom:`add_${e}`,parameters:Object.assign(s,{name:a,parentName:d?d.name:null})}),t)d&&(d.addChild(i),u[i].zIndex=n||d.children.length);else{const e=this.getAllList();u[i].zIndex=n||e.length}if("element"===e){const e=this.findParent(t);a=`${e.name}-${e.children.length+1}`,s=Object.assign(s,{image:e.image,type:e.type})}}else{if(i=l(),"element"===e){const e=this.findParent(t);a=`${e.name}-${e.children.length+1}`,s=Object.assign(s,{image:s.image||e.image,type:e.type})}if(u[i]=new o(i,t,a,s),0===r&&Re({atom:`add_${e}`,parameters:Object.assign(s,{name:a,parentName:d?d.name:null})}),t)d&&(d.addChild(i),u[i].zIndex=n||d.children.length);else{const e=this.getAllList();u[i].zIndex=n||e.length+1}"layer"===e&&"colors"===s.type&&(a=`${a}`,await this.add("element",i,a,Object.assign({width:100,height:100,x:0,y:0},s),null,null,1),this.reDraw()),"layer"===e&&"statics"===s.type&&s.tileType&&(a=`${a}`,await this.add("element",i,a,Object.assign({width:100,height:100,x:0,y:0},s),null,null,1),this.reDraw())}return i}setData(e,t,a={}){if(this[`${e}s`][t].setData(a),"layer"===e&&a.image){this.findData(e,t).children.forEach((e=>{this.setData("element",e,{image:a.image})}))}}delete(e,t,a=0){if(Je.checkInTask())return void Ze.error("该模板当前有在进行中的生成队列请在队列完成后操作");const l=this.findData(e,t);if(!l)return;0===a&&Re({atom:`delete_${e}`,parameters:{name:l.name}});const s=l.children;s.length&&s.forEach((t=>{this.delete(Qe[e].childrenType,t,a+1)}));const i=this[`${e}s`];if(l.parentUuid){const a=this.findParent(l.parentUuid,`${Qe[e].parentType}s`);a.children=a.children.filter((a=>{const s=this.findData(e,a);return s.zIndex>l.zIndex&&(s.zIndex-=1),a!==t})),"group"===Qe[e].parentType&&1===a.children.length&&this.unbindGroup({type:"layer",uuid:a.children[0]})}this.selectedMap[e]===t&&(this.selectedMap[e]=null),this.reDraw(),l&&l.tileType&&"element"===e&&0===a&&this.delete("layer",l.parentUuid,a+1),delete i[t]}handleIsShow(e,t,a="show"){const l=this.findData(e,t);if(!l)return;const s=l.children;if(s.length?s.forEach((t=>{this.handleIsShow(Qe[e].childrenType,t,a)})):l[a](),l.parentUuid){const t=this.findData(Qe[e].parentType,l.parentUuid);t.children.every((t=>this.findData(e,t).isShow===("show"===a)))?t[a]():t.show()}this.reDraw()}findParent(e,t=""){for(const a of t?[t]:["groups","layers","elements"]){const t=this[a];if(t[e])return t[e]}return null}findData(e,t){return this[`${e}s`][t]}handleShowMap(e,t){this.showMap[`${e}s`].has(t)?this.showMap[`${e}s`].delete(t):this.showMap[`${e}s`].add(t)}isShowMapShow(e,t){return this.showMap[`${e}s`].has(t)}changeSelected(e){for(let t in e){t=Number(t);const a=e[t],l=Object.keys(Qe)[t];a&&"element"!==l&&this.showMap[`${l}s`].add(a),this.selectedMap[l]=a}this.reDraw()}isSelected(e,t){return this.selectedMap[e]===t}async bindGroup({fromData:e,toData:t,zIndex:a},l=null,s=0){if(e.uuid!==t.uuid&&(a||0===a)){{const l=this.findData(e.type,e.uuid),i=this.findData(t.type,t.uuid);if(l.parentUuid!==i.parentUuid)return;0===s&&Re({atom:"update_zindex",parameters:{fromName:l.name,toName:i.name}});const n=l.zIndex;let r=i.zIndex;const o=this.getListByParentUuid(l.parentUuid);n>r?(r=a+1,o.forEach((e=>{const{dataType:t,uuid:a}=e,l=e.zIndex;l<n&&l>=r&&(this[`${t}s`][a].zIndex+=1)})),l.zIndex=r):(o.forEach((e=>{const{dataType:t,uuid:a,zIndex:l}=e;l<=r&&l>n&&(this[`${t}s`][a].zIndex-=1)})),l.zIndex=Math.min(r,o.length))}this.reDraw()}}unbindGroup(e,t=0){}getListByParentUuid(e){const t=[];return Object.keys(Qe).forEach((a=>{Object.keys(this[`${a}s`]).forEach((l=>{const s=this[`${a}s`][l];e===s.parentUuid&&(t[s.zIndex-1]=Object.assign({dataType:a},s))}))})),t}bindGroupCheck(e){let t=new Set,a=new Set,l=!0;return e.forEach(((e,s)=>{t.add(this.layers[e].type);const i=this.layers[e],n=i.type,r=new Set(i[n]);if(0===s)a=r;else{if(r.size!=r.size)return void(l=!1);for(let e of a)r.has(e)||(l=!1)}})),!([...t].length>1)&&(!!l&&{type:[...t][0],typesInfo:[...a]})}clearAllData(){this.groups={},this.layers={},this.elements={},this.showMap={groups:new Set,layers:new Set},this.selectedMap={group:null,layer:null,element:null}}getData(){return{groups:this.groups,layers:this.layers,elements:this.elements}}getAllList(){const e=Object.keys(this.groups).map((e=>({type:"group",uuid:e,zIndex:this.groups[e].zIndex}))),t=Object.keys(this.layers).filter((e=>!this.layers[e].parentUuid)).map((e=>({type:"layer",uuid:e,zIndex:this.layers[e].zIndex}))),a=[].concat(e,t),l=[];return a.forEach((e=>{const{zIndex:t}=e;l[t-1]=e})),l}async copyData(e,t,a,l=0){const s=this.findData(t,e),i=s.image;0===l&&Re({atom:"copy",parameters:{name:s.name}}),a=a||s.parentUuid;const n=JSON.parse(JSON.stringify(s));n.handleImage=s.handleImage,n.parentUuid=null,!n.tileType&&"element"===t&&n.x&&n.y&&(n.x+=100,n.y+=100);const r=await this.add(t,a||null,`${s.name}-${Math.round(1e3*Math.random())}`,n,null,null,l+1);!n.tileType&&"element"===t&&n.x&&n.y&&(this.selectedMap.element=r);const o=this.findData(t,r);i&&o.setData({image:i}),o.children=[],o.zIndex=null,s.children.length&&s.children.forEach((async e=>{await this.copyData(e,Qe[t].childrenType,r,l+1)}));this.getListByParentUuid(a).forEach((e=>{const t=this.findData(e.dataType,e.uuid);"element"!==e.dataType?t.zIndex>=s.zIndex&&(t.zIndex+=1):t.zIndex>s.zIndex&&(t.zIndex+=1)})),"element"!==t?o.zIndex=s.zIndex-1:o.parentUuid!==s.parentUuid?o.zIndex=s.zIndex:o.zIndex=s.zIndex+1,this.reDraw()}}class Ke{constructor(){this.listeners={}}addListener(e,t,a){e.addEventListener(t,a);const s=l();return this.listeners[s]={element:e,eventType:t,listener:a},s}removeListenersByEventType(e){const{listeners:t}=this;Object.keys(t).filter((a=>t[a].eventType===e)).forEach((e=>{this.removeListenter(e)}))}removeAllListeners(){for(var e in this.listeners)this.removeListenter(e);this.listeners={}}removeListenter(e){var t=this.listeners[e];t.element.removeEventListener(t.eventType,t.listener),delete this.listeners[e]}}const et="edit",tt="generate",at="gallery",lt="效果调节",st="上传替换",it="文本编辑",nt="颜色编辑",rt="图层编辑",ot="AI图生图",dt="重新生成",ut="删除元素",ct="删除图层",ht="删除组",mt="复制元素",vt="复制图层",pt="复制组";class gt{constructor(e=et){this.handelType=e,this.x=0,this.y=0,this.layerType=null,this.isShow=!1,this.dom=null,this.bindDom=null,this.isHasImage=!1,this.tileType=null}setHandle({uuid:e,type:t,tileType:a},{x:l,y:s},i,n=!1,r=document.body,o=null){return this.close(),this.bindDom=r,this.isHasImage=n,this.tileType=a,new Promise((a=>{this.x=l,this.y=s,this.handleUuid=e,this.elementType=t,this.layerType=i,this.createDom(o).then((e=>{a(e)}))}))}close(){this.isShow=!1,this.x=0,this.y=0,this.layerType=null,this.dom&&(this.bindDom.removeChild(this.dom),document.documentElement.onClick=()=>{},this.dom=null)}createDom(e=null){return new Promise((t=>{const a=document.createElement("div");a.className="editor-contextmenu-view",this.bindDom.appendChild(a),this.dom=a,document.documentElement.onclick=this.close.bind(this),this.createList(e).then((e=>{t(e)}))}))}createList(e=null){const t=this.getHandleList(this.handelType),{x:a,y:l,dom:s,bindDom:i}=this,n=(1.2*t.length-.2)*window.rootFont,r=i.getBoundingClientRect();let o=l+n>r.bottom?r.bottom-n-r.top:l-r.top;return s.style.top=`${o}px`,s.style.left=a-r.left+"px",new Promise((a=>{t.forEach((t=>{this.dom&&this.createItem(t,e).then((e=>{a(e)}))})),setTimeout((()=>{this.dom&&(this.dom.style.height=1.2*t.length-.2+"rem",this.dom.style.transform="scale(1, 1)")}))}))}createItem({name:e,icon:t,type:a="button"},l=null){const{handleUuid:s}=this;return new Promise((i=>{const n=document.createElement("div");n.className="editor-contextmenu-item";const r=document.createElement("i");r.className="editor-contextmenu-item-icon",r.className=`editor-contextmenu-item-icon bi ${t}`;const o=document.createElement("div");if(o.className="editor-contextmenu-item-name",o.innerText=e,n.appendChild(r),n.appendChild(o),"upload"===a){const t=document.createElement("input");t.type="file",n.appendChild(t),t.onclick=e=>{e.stopPropagation()},t.onchange=t=>{t.stopPropagation();const{target:a}=t;i({file:a.files[0],handleUuid:s,name:e}),this.close()}}else n.onclick=t=>{t.stopPropagation(),i({handleUuid:s,name:e}),this.close()};this.dom.appendChild(n),("texts"===l&&e===it||"prompts"===l&&e===ot)&&n.click()}))}getHandleList(e=et){let t=[];e=e||this.handelType;const{isHasImage:a,elementType:l,layerType:s,tileType:i}=this;switch(s){case"element":switch(e){case et:if(t=a?[{name:lt,icon:N,type:"button"},{name:st,icon:P,type:"upload"},{name:mt,icon:j,type:"button"},{name:ot,icon:F,type:"button"},{name:dt,icon:H},{name:ut,icon:Y,type:"button"}]:[{name:lt,icon:N,type:"button"},{name:st,icon:P,type:"upload"},{name:mt,icon:j,type:"button"},{name:dt,icon:H},{name:ut,icon:Y,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:it,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:nt,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}break;case tt:if(t=a?[{name:lt,icon:N,type:"button"},{name:st,icon:P,type:"upload"},{name:mt,icon:j,type:"button"},{name:ot,icon:F,type:"button"},{name:dt,icon:H},{name:ut,icon:Y,type:"button"}]:[{name:st,icon:P,type:"upload"},{name:dt,icon:H},{name:ut,icon:Y,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:it,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:nt,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}break;case at:if(t=a?[{name:lt,icon:N,type:"button"},{name:st,icon:P,type:"upload"},{name:mt,icon:j,type:"button"},{name:ut,icon:Y,type:"button"}]:[{name:st,icon:P,type:"upload"},{name:mt,icon:j,type:"button"},{name:ut,icon:Y,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:it,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===st));t.splice(e,1,{name:nt,icon:G,type:"button"});const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}}break;case"layer":switch(e){case tt:t=[{name:vt,icon:j,type:"button"},{name:ct,icon:Y,type:"button"}];break;case et:t=[{name:rt,icon:G,type:"button"},{name:vt,icon:j,type:"button"},{name:ct,icon:Y,type:"button"}];break;case at:t=[{name:vt,icon:j,type:"button"},{name:ct,icon:Y,type:"button"}]}break;case"group":switch(e){case tt:case at:case et:t=[{name:pt,icon:j,type:"button"},{name:ht,icon:Y,type:"button"}]}}if(i){const e=t.findIndex((({name:e})=>e===mt));t.splice(e,1);const a=t.findIndex((({name:e})=>e===lt));t.splice(a,1)}return t}}const yt=ie,ft="编辑器",wt="操作",bt="绘制",Dt="定位花",kt="横向二方连续",xt="纵向二方连续",It="四方连续",Ct={outerWidth:100,innerWidth:20};class _t{constructor(){this.rootFont=window.rootFont,this.realWidth=2048,this.realHeight=2048,this.name="",this.canvasOuterDom=null,this.canvasDom=null,this.ctx=null,this.zoomRatio=1,this.handleState=wt,this.listeners=new Ke,this.startX=0,this.startY=0,this.isDrawing=!1,this.moveType=null,this.drawType=Dt,this.handleController=null;const e=new Image;this.rotateImage=null,this.viewType="editor",e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE7mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4xLWMwMDEgNzkuMTQ2Mjg5OSwgMjAyMy8wNi8yNS0yMDowMTo1NSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI1LjMgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyNC0wOS0xOVQyMDozNjo1NCswODowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjQtMDktMTlUMjA6Mzg6MDcrMDg6MDAiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMDktMTlUMjA6Mzg6MDcrMDg6MDAiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI0ZWM4ZGEzLTEyMzYtODc0MC05ZjM3LTYxYTEzYjJjZGMzYSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoyNGVjOGRhMy0xMjM2LTg3NDAtOWYzNy02MWExM2IyY2RjM2EiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyNGVjOGRhMy0xMjM2LTg3NDAtOWYzNy02MWExM2IyY2RjM2EiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjI0ZWM4ZGEzLTEyMzYtODc0MC05ZjM3LTYxYTEzYjJjZGMzYSIgc3RFdnQ6d2hlbj0iMjAyNC0wOS0xOVQyMDozNjo1NCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDI1LjMgKFdpbmRvd3MpIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgYbnyIAAANaSURBVFiF7ZhBbuowEIb/ZJFNtskaIV8hyopL9ByRIm7BKlIPwB286AHKCcoqq1ZqRCXKE6qi8uQsQI3fAk/fNC+BQM1rFx3JG4jtz2PP+B87Wmt8Z3O/GuCY/QB+lQ0AjAHMAVQAagC60WoApflm0ndgrfWHdg7YLQE5jvMmhFhmWbbI83yjlNJKKZ3n+SZJkkIIsXRdd2uAd6bv6FKAksCCIHghoGOmlNJSylUQBC8MdGob8A6A9n3/lYORt9I0fYzjeBGG4ToMw7UQYpmm6SN5lIN6nlcZ0DtbgPcA9HA4fOaTpWn6yLaPztsD9meuNL9rz/OqLMsWvO9wOHw2/99/FvAOgI6i6ImfLwZWYh8Ag47+U+yDSHueV0kpVzROFEVPaPHkKYBT7jmllM6ybME81jsyzVg7AJq82fCkPBVwBGDneV7VAlfhSCQeGLNqQvq+/4r9ggenAN4C0FLKldZaSylXDK5rO/vYgCDzPN9orXWe5xsz9uwUwF0QBC+0ShN5O5znuaaNANSu625p/DAM1zBe7AM4AfNemqaPZoWduesMmwDQSZIUDS+O+wDO+eqM90qLcGQln8dxnDcA8z6ApRBiSTkL9r1HNgE7i0KIJYCqD2BNrmfbewkb8LlMlqj7ADZXdYntJSvjOF7wc9gG2JRJ7/enia7m/88WAR/CMFzz49QEdB3HqZVS4I2sKIqA/351dVVYhAOA330+0kmSFMekE4s0mx58D8hDW1zC5L0uSJZMNfZK2pbpRkC2BskA5iKn4DgAN7MINwU77xSQXVE8AlA7jvPGvUi67wJwAFByMWIk3MFEPYZRzdSJiQTbqWYKtr1snsmxPCgBaCHEknWyJRLI/pFy5gjtgH5qZm4+3l4A7l1utUi5WV9AGoiaLWsVrE0p1xfQto3RIvlN5H4QIzYAJfZBQ61L6dDrQwlT5POiKY5jKiHmvJMNwJ3v+69JkhSsxqVIn2NfSpZgrw/8pmp47qE5uBXAm5ubXzSZUkrTMwcV7lEUPSVJUrQV+aZI+sdzVgHDMFwfuhqbN1Ge5xt2G9VgZeYlAGcwB9513S09czQfj66vrxdCiKURGAQ2w5HMYDOKJ/j7zNH1/FaZb8bHwLoAnf+Za86xb//C+gP4WfsDkHE+0dPTz/8AAAAASUVORK5CYII=",this.handleLocked=!1,this.templateId=null,this.template_level="normal",this.template_filter="normal",this.points=1,this.hue=null,this.edgeFeather=0,this.drawX=0,this.drawY=0,e.onload=()=>{this.rotateImage=e},this.position={left:0,top:0}}init(e,t={},a=ft,l,{template_level:s,template_filter:i,points:n}){return new Promise((r=>{this.canvasOuterDom=e,this.name=t.name||null,this.realWidth=t.realWidth||2048,this.realHeight=t.realHeight||2048,this.viewType="editor",this.drawType=t.drawType||Dt,this.position={left:0,top:0},this.templateId=l||null,this.template_level=s,this.template_filter=i,this.points=n,this.getCanvasSize().then((e=>{this.canvasDom=document.createElement("canvas"),this.canvasDom.width=e.outerWidth,this.canvasDom.height=e.outerHeight,this.drawX=(e.outerWidth-e.width)/2,this.drawY=(e.outerHeight-e.height)/2,this.zoomRatio=e.zoomRatio,this.canvasOuterDom.focus(),this.handleState=wt,this.canvasOuterDom.appendChild(this.canvasDom),this.ctx=this.canvasDom.getContext("2d"),this.handleController=new gt(a),this.bindCanvasHandleListener(),r()}))}))}bindMainMove(){this.listeners.addListener(this.canvasDom,"mousedown",(e=>{this.handle("mousedown",e)})),this.listeners.addListener(this.canvasDom,"mousemove",(e=>{this.handle("mousemove",e)})),this.listeners.addListener(this.canvasDom,"mouseup",(e=>{this.handle("mouseup",e)})),this.listeners.addListener(this.canvasDom,"mouseleave",(e=>{this.handle("mouseleave",e)}))}unBindMove(){this.listeners.removeListenersByEventType("mousedown"),this.listeners.removeListenersByEventType("mousemove"),this.listeners.removeListenersByEventType("mouseup"),this.listeners.removeListenersByEventType("mouseleave")}bindHandleMove(){this.listeners.addListener(this.canvasOuterDom,"mousedown",(e=>{this.handle("mousedown",e)})),this.listeners.addListener(this.canvasOuterDom,"mousemove",(e=>{this.handle("mousemove",e)})),this.listeners.addListener(this.canvasOuterDom,"mouseup",(e=>{this.handle("mouseup",e)}))}bindCanvasHandleListener(){this.bindMainMove(),this.listeners.addListener(this.canvasDom,"click",(e=>{this.handle("selected",e)})),this.listeners.addListener(this.canvasDom,"dblclick",(e=>{this.handle("dblclick",e)})),this.listeners.addListener(this.canvasDom,"contextmenu",(e=>{this.handle("contextmenu",e)})),this.listeners.addListener(this.canvasOuterDom,"keydown",(e=>{this.handle("keydown",e)})),this.listeners.addListener(this.canvasOuterDom,"keyup",(e=>{this.handle("keyup",e)})),this.listeners.addListener(this.canvasOuterDom,"wheel",(e=>{e.preventDefault();const{drawX:t,drawY:a,realWidth:l,realHeight:s,zoomRatio:i}=this,n={width:this.canvasDom.width,height:this.canvasDom.height,zoomRatio:this.zoomRatio};if(e.deltaY>0){n.zoomRatio<=.01?n.zoomRatio=.01:n.zoomRatio=Math.round(n.zoomRatio/11*10*1e4)/1e4;const e=l*(i-n.zoomRatio),t=s*(i-n.zoomRatio);this.drawX+=e/2,this.drawY+=t/2}else{n.zoomRatio>=4?n.zoomRatio=4:n.zoomRatio=Math.round(11*n.zoomRatio/10*1e4)/1e4;const e=l*(n.zoomRatio-i),t=s*(n.zoomRatio-i);this.drawX-=e/2,this.drawY-=t/2}this.zoomRatio=n.zoomRatio,this.reDraw()}),{passive:!1})}async resize(){const e=await this.getCanvasSize();this.canvasDom.width=e.outerWidth,this.canvasDom.height=e.outerHeight,this.drawX=(e.outerWidth-e.width)/2,this.drawY=(e.outerHeight-e.height)/2,this.zoomRatio=e.zoomRatio}lockHandle(e){this.handleState!==bt&&"Space"===e.code&&(this.handleLocked=!0,this.canvasDom.className="canvas-key-down",this.unBindMove(),this.bindHandleMove())}unlockHandle(e){"Space"===e.code&&(this.handleLocked=!1,this.canvasDom.className="",this.unBindMove(),this.bindMainMove())}getCanvasSize(){const{realWidth:e,realHeight:t}=this,a=this.canvasOuterDom.getBoundingClientRect();return new Promise((l=>{if(a.width||a.height){const s=this.getZoomRatio(a.width,a.height,e,t);l(s)}else{const a=new ResizeObserver((s=>{for(let i of s){const{width:s,height:n}=i.contentRect;if(s&&n){const i=this.getZoomRatio(s,n,e,t);l(i),a.disconnect()}}}));a.observe(this.canvasOuterDom)}}))}getZoomRatio(e,t,a,l){const s=e,i=t;let n=1;return e/t<a/l?(t=t*a/e,n=e/a,e=a):(e=e*l/t,n=t/l,t=l),{outerWidth:s,outerHeight:i,width:a*n,height:l*n,zoomRatio:n}}destory(){this.width=0,this.height=0,this.realWidth=0,this.realHeight=0,this.name="",this.handleState=null,this.canvasOuterDom=null,this.canvasDom=null,this.ctx=null}setData({name:e,realWidth:t,realHeight:a,drawType:l,template_filter:s,template_level:i,points:n},r="init"){this.name=e,this.drawType=l,this.template_filter=s,this.template_level=i,this.points=n,t!==this.realWidth||a!==this.realHeight?"edit"===r?yt.warning({title:"警告",content:"修改尺寸将会清空所有元素，是否继续",positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{this.realWidth=t,this.realHeight=a,this.clearAllData(),this.resize().then((()=>{this.reDraw()}))},onNegativeClick:()=>{ae.info("取消修改")}}):(this.realWidth=t,this.realHeight=a,this.clearAllData(),this.resize().then((()=>{this.reDraw()}))):this.reDraw()}changeHandleType(e){this.handleState=e,this.canvasDom.style.cursor=e===bt?"crosshair":"auto"}handle(e,t){const{handleState:a,handleLocked:l,startX:s,startY:i,zoomRatio:n}=this;if(l){const{pageX:a,pageY:l}=t;switch(e){case"keyup":this.unlockHandle(t);break;case"mousedown":this.canvasDom.className="canvas-key-down-mousedown",this.isDrawing=!0,this.startX=a,this.startY=l;break;case"mousemove":if(!this.isDrawing)return;const e=a-s,n=l-i;this.startX=a,this.startY=l,this.drawX+=e,this.drawY+=n,this.reDraw();break;case"mouseup":switch(t.button){case 0:this.canvasDom.className="canvas-key-down",this.isDrawing=!1;break;case 1:this.isDrawing=!1,this.unlockHandle({code:"Space"})}}}else switch(a){case wt:this.handleEvent(e,t);break;case bt:this.drawingEvent(e,t)}}handleEvent(e,t){switch(e){case"dblclick":this.checkContextMenu(t,!0);break;case"mousedown":switch(t.button){case 0:this.handleController.close(),this.checkMove(t);break;case 1:this.lockHandle({code:"Space"})}break;case"click":this.handleController.close();break;case"mousemove":this.moving(t);break;case"mouseup":switch(this.finishMove(t),t.button){case 0:this.finishMove(t);break;case 1:this.unlockHandle({code:"Space"})}break;case"contextmenu":this.checkContextMenu(t);break;case"selected":this.handleController.close(),this.selectedElement(t);break;case"mouseleave":this.finishMove(t);break;case"keydown":this.lockHandle(t)}}drawingEvent(e,t){switch(this.handleController.close(),e){case"mousedown":if(0!==t.button)return;this.toDraw(t);break;case"click":case"contextmenu":case"selected":break;case"mousemove":this.drawMove(t);break;case"mouseup":case"mouseleave":this.finishDraw(t);break;case"keydown":this.lockHandle(t)}}startDraw(e){const{offsetX:t,offsetY:a}=e;this.startX=t,this.startY=a,this.isDrawing=!0}drawMove(e){if(!this.isDrawing)return;const t=this.getDrawingArea(e);this.reDraw(t)}finishDraw(e){if(!this.isDrawing)return;this.isDrawing=!1;const t=this.getDrawingArea(e);this.sendElement(t)}startMove(e,t){const{offsetX:a,offsetY:l}=e;this.startX=a,this.startY=l,this.isDrawing=!0,this.moveType=t}moving(e){if(!this.isDrawing)return;const{moveType:t,startX:a,startY:l,zoomRatio:s,drawX:i,drawY:n}=this,{offsetX:r,offsetY:o}=e,d=(r-this.startX)/s,u=(o-this.startY)/s;this.startX=r,this.startY=o;const c=[(a-i)/s,(l-n)/s];this.setElementMovingData({xFloat:d,yFloat:u,rotateFloat:c,moveType:t},e.shiftKey)}finishMove(){this.isDrawing&&(this.isDrawing=!1,this.moveEnd())}contextMenu(e,t,a=null,l=null){this.handleController.setHandle(t,{x:e.pageX,y:e.pageY},"element",Boolean(t.image),this.canvasOuterDom,a).then((e=>{this.contextmenuCallBack(e,l)}))}contextmenuCallBack(e,t=null){switch(e.name){case lt:this.toElementSetting(e.handleUuid);break;case st:oe(e.file).then((t=>{this.changeElementImage(e.handleUuid,t)}));break;case ot:this.toImageGenerateView(e.handleUuid,t);break;case dt:this.generateElement(e.handleUuid);break;case ut:this.deleteElement(e.handleUuid);break;case it:this.toTextEdit(e.handleUuid,"text");break;case nt:this.toTextEdit(e.handleUuid,"color");break;case mt:this.copyData(e.handleUuid)}}getDrawingArea(e){const{offsetX:t,offsetY:a}=e,{startX:l,startY:s,zoomRatio:i,drawX:n,drawY:r}=this;let o=l>t?{startX:t,finishX:l}:{startX:l,finishX:t},d=s>a?{startY:a,finishY:s}:{startY:s,finishY:a};return{x:(o.startX-n)/i,y:(d.startY-r)/i,width:(o.finishX-o.startX)/i,height:(d.finishY-d.startY)/i}}clearAll(){const{ctx:e,canvasDom:t}=this;e.beginPath(),e.clearRect(0,0,t.width,t.height),e.closePath()}drawItem({name:e,x:t,y:a,width:l,height:s,rotate:i,image:n,xOverturn:r,yOverturn:o,opacity:d,handleImage:u}){const{ctx:c,zoomRatio:h,drawX:m,drawY:v}=this;if(l||s){if(t*=h,a*=h,t+=m,a+=v,l*=h,s*=h,c.beginPath(),c.save(),c.lineWidth=2,c.fillStyle="#222",c.translate(t+l/2,a+s/2),c.scale(r?-1:1,o?-1:1),c.globalAlpha=d,i&&c.rotate(i),n){const e=u||n;c.drawImage(e,-l/2,-s/2,l,s)}else c.rect(-l/2,-s/2,l,s),c.stroke(),c.fill();i&&c.rotate(-i),c.globalAlpha=1,c.scale(r?-1:1,o?-1:1),c.translate(-(t+l/2),-(a+s/2)),c.restore(),c.closePath()}}clearOther(){const{drawX:e,drawY:t,zoomRatio:a,realWidth:l,realHeight:s,ctx:i,canvasDom:n}=this;i.beginPath(),i.save(),i.strokeStyle="#bbb",i.clearRect(0,0,e,n.height),i.clearRect(e,t+s*a,n.width,n.height),i.clearRect(0,0,n.width,t),i.clearRect(e+l*a,0,n.width,n.height),i.rect(e,t,l*a,s*a),i.stroke(),i.restore(),i.closePath()}drawTextItem({x:e,y:t,width:a,height:l,rotate:s,fontSetting:i,xOverturn:n,yOverturn:r,opacity:o}){const{content:d,font_color:u,font_size:c,fontFamily:h}=i,{ctx:m,zoomRatio:v,drawX:p,drawY:g}=this;e*=v,t*=v,e+=p,t+=g,a*=v,l*=v,m.beginPath(),m.save(),m.translate(e+a/2,t+l/2),m.scale(n?-1:1,r?-1:1),m.globalAlpha=o,s&&m.rotate(s),m.font=`${c*v}px ${h}`,m.fillStyle=de(u);const y=m.measureText(d).width;m.fillText(d,-y/2,c*v/2),m.stroke(),s&&m.rotate(-s),m.scale(n?-1:1,r?-1:1),m.globalAlpha=1,m.translate(-(e+a/2),-(t+l/2)),m.restore(),m.closePath()}selectedElement(e){this.toSelectedElement(e)}checkIsInItem({x:e,y:t,width:a,height:l,rotate:s=0,tileType:i,image:n},r,o=!1){const{offsetX:d,offsetY:u}=r,{ctx:c,zoomRatio:h,realWidth:m,realHeight:v,drawX:p,drawY:g}=this;let y=!1;if(e*=h,t*=h,e+=p,t+=g,a*=h,l*=h,"tile_x"===i?(e=p,a=m*h,s=0):"tile_y"===i?(t=g,l=v*h,s=0):"tile_xy"===i&&(e=p,a=m*h,t=g,l=v*h,s=0),c.beginPath(),c.save(),c.translate(e+a/2,t+l/2),s&&c.rotate(s),c.rect(-a/2,-l/2,a,l),c.translate(-(e+a/2),-(t+l/2)),s&&c.rotate(-s),y=!!c.isPointInPath(d,u)&&"main",c.restore(),c.closePath(),o&&n&&y){const s=document.createElement("canvas");document.body.appendChild(s),s.width=a,s.height=l;const i=s.getContext("2d");i.beginPath(),i.drawImage(n,0,0,a,l),i.closePath();const r=i.getImageData(d-e,u-t,1,1).data;document.body.removeChild(s);0===r[3]&&(y=!1)}return y}drawHandleArea({x:e,y:t,width:a,height:l,rotate:s,type:i,tileType:n}){const{zoomRatio:r,ctx:o,realHeight:d,realWidth:u,drawX:c,drawY:h}=this;e*=r,t*=r,e+=c,t+=h,a*=r,l*=r,"statics"!==i&&"colors"!==i||("tile_x"===n?(e=c,a=u*r,s=0):"tile_y"===n?(t=h,l=d*r,s=0):"tile_xy"===n&&(e=c,a=u*r,t=h,l=d*r,s=0));const m=10,v=10,p=[[0-a/2,-10-l/2,a,2],[a+5+5-a/2-1,0-l/2,2,l],[-10-a/2,0-l/2,2,l],[0-a/2,l+5+5-l/2-1,a,2]];[[-15-a/2,-15-l/2],[+a+5-a/2,-15-l/2],[+a+5-a/2,+l+5-l/2],[-15-a/2,+l+5-l/2]].forEach((i=>{this.drawHandlePoint(i,{x:e,y:t,width:a,height:l,rotate:s},v)})),p.forEach((i=>{this.drawHandleLine(i,{x:e,y:t,width:a,height:l,rotate:s})})),n&&n.includes("tile")||this.drawRotateArea({x:e,y:t,width:a,height:l,rotate:s},m)}drawRotateArea({x:e,y:t,width:a,height:l,rotate:s},i){const{rotateImage:n,ctx:r}=this;r.beginPath(),r.save(),r.translate(e+a/2,t+l/2),s&&r.rotate(s),r.drawImage(n,-10,-l/2-2*i-20,20,20),r.translate(-(e+a/2),-(t+l/2)),s&&r.rotate(-s),r.translate(-(e+a/2),-(t+l/2)),r.restore(),r.closePath()}drawHandlePoint([e,t],a,l){const{ctx:s}=this;s.beginPath(),s.save(),s.fillStyle="#fff",s.translate(a.x+a.width/2,a.y+a.height/2),a.rotate&&s.rotate(a.rotate),s.rect(e,t,l,l),s.translate(-(a.x+a.width/2),-(a.y+a.height/2)),a.rotate&&s.rotate(-a.rotate),s.stroke(),s.fill(),s.restore(),s.closePath()}drawHandleLine([e,t,a,l],s){const{ctx:i}=this;i.beginPath(),i.save(),i.fillStyle="#fff",i.translate(s.x+s.width/2,s.y+s.height/2),s.rotate&&i.rotate(s.rotate),i.rect(e,t,a,l),i.translate(-(s.x+s.width/2),-(s.y+s.height/2)),s.rotate&&i.rotate(-s.rotate),i.stroke(),i.fill(),i.restore(),i.closePath()}checkIsInHandleArea({x:e,y:t,width:a,height:l,rotate:s,type:i,tileType:n},r){const{zoomRatio:o,canvasDom:d,drawX:u,drawY:c,realWidth:h,realHeight:m}=this;e*=o,t*=o,e+=u,t+=c,a*=o,l*=o,"tile_xy"===n?(e=u,a=h*o,s=0):"tile_y"===n?(t=c,l=m*o,s=0):"tile_xy"===n&&(e=u,a=h*o,t=c,l=m*o,s=0);const v=10,p=10,g=[[-15-a/2,-15-l/2,"left-top"],[+a+5-a/2,-15-l/2,"right-top"],[+a+5-a/2,+l+5-l/2,"right-bottom"],[-15-a/2,+l+5-l/2,"left-bottom"]],y=[[0-a/2,-10-l/2,a,2,"top"],[a+5+5-a/2-1,0-l/2,2,l,"right"],[-10-a/2,0-l/2-1,2,l,"left"],[0-a/2,l+5+5-l/2,a,2,"bottom"]];let f=!1;if(f=this.checkIsInRotateArea({x:e,y:t,width:a,height:l,rotate:s},v,r),f||"texts"===i)return f;for(let w of g)if(f=this.checkIsInHandlePoint(w,{x:e,y:t,width:a,height:l,rotate:s},p,r),f)break;if(f)return f;for(let w of y)if(f=this.checkIsInHanleLine(w,{x:e,y:t,width:a,height:l,rotate:s},r),f)break;return f}checkIsInHandlePoint([e,t,a],l,s,{offsetX:i,offsetY:n}){const{ctx:r}=this;r.beginPath(),r.save(),r.fillStyle="#fff",r.translate(l.x+l.width/2,l.y+l.height/2),l.rotate&&r.rotate(l.rotate),r.rect(e,t,s,s),r.translate(-(l.x+l.width/2),-(l.y+l.height/2)),l.rotate&&r.rotate(-l.rotate);let o=!!r.isPointInPath(i,n)&&a;return r.restore(),r.closePath(),o}checkIsInHanleLine([e,t,a,l,s],i,{offsetX:n,offsetY:r}){const{ctx:o}=this;o.beginPath(),o.save(),o.fillStyle="#fff",o.translate(i.x+i.width/2,i.y+i.height/2),i.rotate&&o.rotate(i.rotate),o.rect(e,t,a,l),o.translate(-(i.x+i.width/2),-(i.y+i.height/2)),i.rotate&&o.rotate(-i.rotate);let d=!!o.isPointInPath(n,r)&&s;return o.restore(),o.closePath(),d}checkIsInRotateArea({x:e,y:t,width:a,height:l,rotate:s},i,{offsetX:n,offsetY:r}){const{ctx:o}=this;o.beginPath(),o.save(),o.translate(e+a/2,t+l/2),s&&o.rotate(s),o.rect(-10,-l/2-2*i-20,20,20),o.translate(-(e+a/2),-(t+l/2)),s&&o.rotate(-s),o.translate(-(e+a/2),-(t+l/2)),o.restore();let d=!!o.isPointInPath(n,r)&&"rotate";return o.closePath(),d}getData(){return{name:this.name,realWidth:this.realWidth,realHeight:this.realHeight,drawType:this.drawType,points:this.points,template_level:this.template_level,template_filter:this.template_filter,hue:this.hue,edgeFeather:this.edgeFeather}}getRealCanvas(){this.zoomRatio=1}setViewType(e){this.viewType=e,"editor"===e&&(this.resize(),this.reDraw())}getTextWidth({content:e,fontFamily:t,font_size:a}){const{ctx:l}=this;l.beginPath(),l.save(),l.font=`${a}px ${t}`;var s=l.measureText(e).width;return l.restore(),l.closePath(),s}drawMeshLine(){const{canvasDom:e,zoomRatio:t}=this,{width:a,height:l}=e,{outerWidth:s}=Ct,i=Math.ceil(a/t/s),n=Math.ceil(l/t/s),r={x:new Array(i),y:new Array(n)};this.drawMeshLineItem(r)}drawMeshLineItem(e){const{ctx:t,canvasDom:a,zoomRatio:l}=this,{outerWidth:s}=Ct,{width:i,height:n}=a,{x:r,y:o}=e;for(let d=0;d<r.length;d++)t.beginPath(),t.save(),t.strokeStyle="#e0e0e0",t.moveTo(d*s*l,0),t.lineTo(d*s*l,n),t.stroke(),t.restore(),t.closePath(),this.drawMeshMin(d*s*l,0,0);for(let d=0;d<o.length;d++)t.beginPath(),t.save(),t.strokeStyle="#e0e0e0",t.moveTo(0,d*s*l),t.lineTo(i,d*s*l),t.stroke(),t.restore(),t.closePath(),this.drawMeshMin(0,d*s*l,1)}drawMeshMin(e,t,a=0){const{ctx:l,canvasDom:s,zoomRatio:i}=this,{width:n,height:r}=s,{innerWidth:o,outerWidth:d}=Ct,u=Math.ceil(d/o);if(!(d*i<20))for(let c=0;c<u;c++)if(0!==c){switch(l.beginPath(),l.save(),l.strokeStyle="#e9e9e9",a){case 0:l.moveTo(e+c*o*i,0),l.lineTo(e+c*o*i,r);break;case 1:l.moveTo(0,t+c*o*i),l.lineTo(n,t+c*o*i)}l.stroke(),l.restore(),l.closePath()}}drawTileImage(e,t="tile_xy"){const{image:a,handleImage:l}=e;if(!a)return void this.drawTileColor(e,t);const{zoomRatio:s,ctx:i,drawX:n,drawY:r,realWidth:o,realHeight:d}=this,{width:u,height:c}=a,h="tile_y"===t?1:Math.floor(o*s/u/s),m="tile_x"===t?1:Math.floor(d*s/c/s);let v=o*s/h,p=d*s/m;v="tile_y"===t?e.width*s:v,p="tile_x"===t?e.height*s:p;const g="tile_y"===t?e.x*s:0,y="tile_x"===t?e.y*s:0;i.beginPath();for(let f=0;f<h;f++)for(let e=0;e<m;e++)i.drawImage(l||a,n+g+f*v,r+y+e*p,v+1,p+1);i.closePath()}drawTileColor(e,t="tile_xy"){const a=e.color||[0,0,0,1],{canvasDom:l,zoomRatio:s,ctx:i,realWidth:n,realHeight:r,drawX:o,drawY:d}=this;let u=n*s,c=r*s;u="tile_y"===t?e.width*s:n*s,c="tile_x"===t?e.height*s:r*s;const h="tile_y"===t?e.x*s:0,m="tile_x"===t?e.y*s:0;i.beginPath(),i.save(),i.fillStyle=de(a),i.fillRect(h+o,m+d,u,c),i.fill(),i.restore(),i.closePath()}}function Tt(e){return/^data:image\/\w+;base64,/.test(e)}function Mt(e){return new Promise((t=>{const a=function(e){const t=e.split("/")[e.split("/").length-1].split(".")[0];return`font-${t}`}(e);let l=document.getElementById(a)||document.createElement("style");if(l.id)return void t(a);l.id=a;const i=new s(a);l.innerText=`@font-face {\n      font-family: ${a};\n      src: url('${e}');\n    }`,document.head.appendChild(l),i.load().then((()=>{t(a)}),(e=>{}))}))}function St(e){const t=document.createElement("canvas"),a=t.getContext("2d");return t.width=e.width,t.height=e.height,{canvas:t,ctx:a}}async function Et(e,t){const{canvas:a,ctx:l}=St(e);l.drawImage(e,0,0);let s=l.getImageData(0,0,a.width,a.height),i=new ImageData(new Uint8ClampedArray(s.data),a.width,a.height),n=i.data;for(let r=0;r<n.length;r+=4){let e=(n[r]+n[r+1]+n[r+2])/3;n[r]=e,n[r+1]=e,n[r+2]=e}return function(e,t){let a=e.data;for(let l=0;l<a.length;l+=4){let e=3*a[l];a[l]=t[e],a[l+1]=t[e+1],a[l+2]=t[e+2]}}(i,function(e,t=256){let a=new Uint8ClampedArray(3*t);for(let l=0;l<t;l++){let s=Math.round(e[0]+(255-e[0])*(l/(t-1))),i=Math.round(e[1]+(255-e[1])*(l/(t-1))),n=Math.round(e[2]+(255-e[2])*(l/(t-1)));a[3*l]=s,a[3*l+1]=i,a[3*l+2]=n}return a}(t)),l.putImageData(i,0,0),a.toDataURL()}const Lt=[[-1,0,1],[-2,0,2],[-1,0,1]],At=[[-1,-2,-1],[0,0,0],[1,2,1]];function Ot(e,t){const{data:a,width:l,height:s}=e,i=t.length,n=Math.floor(i/2),r=new Float32Array(l*s);for(let o=0;o<s;o++)for(let e=0;e<l;e++){let d=0;for(let r=0;r<i;r++)for(let u=0;u<i;u++){const i=o+r-n,c=e+u-n;i>=0&&i<s&&c>=0&&c<l&&(d+=a[i*l+c]*t[r][u])}r[o*l+e]=d}return{data:r,width:l,height:s}}const zt=(e,t=null,a=!0)=>{const l=(e=>{const{ctx:t}=St(e);return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)})(e);if(!t&&a){const e=function(e){const t=e.data,a=e.width,l=e.height,s=new Uint8Array(a*l);for(let i=0;i<t.length;i+=4)s[i/4]=t[i+3];return{data:s,width:a,height:l}}(l),a=function(e,t){const{data:a,width:l,height:s}=e,{data:i}=t,n=new Float32Array(l*s);for(let r=0;r<n.length;r++)n[r]=Math.sqrt(a[r]**2+i[r]**2);return{data:n,width:l,height:s}}(Ot(e,Lt),Ot(e,At)),s=function(e,t){const{data:a,width:l,height:s}=e;let i=0;for(let o=0;o<a.length;o++)i=Math.max(a[o],i);const n=t*i,r=new Uint8Array(l*s);for(let o=0;o<a.length;o++)r[o]=a[o]>n?1:0;return{data:r,width:l,height:s}}(a,.1);t=function(e){const{data:t,width:a,height:l}=e,s=new Float32Array(a*l),i=[];for(let r=0;r<t.length;r++)1===t[r]?(s[r]=0,i.push(r)):s[r]=1/0;const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(;i.length>0;){const e=i.shift(),t=e%a,r=Math.floor(e/a);for(const o of n){const n=t+o.dx,d=r+o.dy;if(n>=0&&n<a&&d>=0&&d<l){const t=d*a+n,l=s[e]+1;l<s[t]&&(s[t]=l,i.push(t))}}}return{data:s,width:a,height:l}}(s)}return{imageData:l,transformedDistance:t}},Ut={image:"u_plus_image",image_info:"u_plus_image_info",message:"u_plus_message",message_info:"u_plus_message_info",message_data:"u_plus_message_data"};const Rt=new class{constructor(){this.SQL_NAME="u_plus",this.DB_NAME_LIST=["u_plus_image","u_plus_image_info","u_plus_message","u_plus_message_info","u_plus_message_data"],this.db={},this.request=null,this.init()}init(){const{SQL_NAME:e,DB_NAME_LIST:t}=this;return new Promise(((a,l)=>{this.request=window.indexedDB.open(e,1),this.request.onerror=e=>{l(e)},this.request.onsuccess=e=>{a(e.target.result),this.db=e.target.result},this.request.onupgradeneeded=e=>{this.db=e.target.result,t.forEach((e=>{if(!this.db.objectStoreNames.contains(e)){this.db.createObjectStore(e,{keyPath:"uuid",unique:!0}).createIndex("content","content",{unique:!1})}}))}}))}async get(e,t){const a=Ut[e];return new Promise(((e,l)=>{const s=this.db.transaction([a],"readonly").objectStore(a).get(t);s.onsuccess=function(){e(s.result)},s.onerror=l}))}async add(e,t){const a=Ut[e],{uuid:l}=t;return new Promise(((e,s)=>{const i=this.db.transaction([a],"readwrite").objectStore(a).add({uuid:l,content:t});i.onsuccess=t=>{e(t.target.result)},i.onerror=s}))}async update(e,t){const a=Ut[e],{uuid:l}=t;return new Promise(((e,s)=>{const i=this.db.transaction([a],"readwrite").objectStore(a).put({uuid:l,content:t});i.onsuccess=t=>{e(t.target.result)},i.onerror=s}))}async getAll(e){const t=Ut[e];return new Promise(((e,a)=>{const l=this.db.transaction([t],"readonly"),s=l.objectStore(t),i=[];s.openCursor().onsuccess=function(t){const a=t.target.result;a?(i.push(a.value.content),a.continue()):e(i)},l.oncomplete=function(){},l.onerror=function(){}}))}};class Gt{constructor(e,t,a=!0){this.uuid=e,this.image=null,this.handleImage=null,this.init(t,a),this.hasDB=!1}init(e){this.image=e,this.handleImage=e}async grayToColor(e=[255,0,0]){const t=await Et(this.image,e),a=await re(t);return this.handleImage=a,a}async edgeFeather(e=0){const{uuid:t,image:a}=this;if(!a)return a;const l=await Rt.get("image",t);let s=null;if(l){const{content:e}=l;if(e.image!==a.src);else{const e=await Rt.get("image_info",t);e&&(s=e.content.transformedDistance)}}else;let{imageRes:i,transformedDistance:n}=await(async(e,t,a=null)=>{const l=new Worker(new URL("/assets/imageProcessor.worker-MA1ShGEa.js",import.meta.url));t+=.01;const s=zt(e,a),i=s.imageData;return a=s.transformedDistance,new Promise((e=>{l.postMessage({transformedDistance:a,originalImageData:i,spreadFactor:t}),l.onmessage=({data:t})=>{const{canvas:s,ctx:i}=St(t),n=i,r=new ImageData(t.data,t.width,t.height);n.putImageData(r,0,0);const o=s.toDataURL(),d=ue(o);e({imageRes:d,transformedDistance:a}),l.terminate()}}))})(this.handleImage,e,s);if(s=null,l){const{content:e}=l;e.image!==a.src&&(await Rt.update("image",{uuid:t,image:a.src}),await Rt.update("image_info",{uuid:t,transformedDistance:n}))}else await Rt.add("image",{uuid:t,image:a.src}),await Rt.add("image_info",{uuid:t,transformedDistance:n});return n=null,i}}const Nt=ae,Pt=ie,jt="layouts";function Ft(e,t,a,l=0,s=0){const i=[[-e/2,-t/2],[e/2,-t/2],[e/2,t/2],[-e/2,t/2]].map((([e,t])=>{const i=Math.cos(a),n=Math.sin(a);return[l+(e*i-t*n),s+(e*n+t*i)]}));let n=1/0,r=-1/0,o=1/0,d=-1/0;return i.forEach((([e,t])=>{n=Math.min(n,e),r=Math.max(r,e),o=Math.min(o,t),d=Math.max(d,t)})),{width:r-n,height:d-o}}function Ht([e,t],[a,l]){return e>0&&e<a&&t>0&&t<l}const Yt=new class{constructor(){this.dataController=a(new qe),this.canvasController=a(new _t),this.generationController=a(new Fe),this.dataController.reDraw=this.reDraw.bind(this),this.canvasController.clearAllData=this.clearAllData.bind(this),this.canvasController.reDraw=this.reDraw.bind(this),this.canvasController.toDraw=this.toDraw.bind(this),this.canvasController.sendElement=this.sendElement.bind(this),this.canvasController.toSelectedElement=this.toSelectedElement.bind(this),this.canvasController.checkMove=this.checkMove.bind(this),this.canvasController.setElementMovingData=this.setElementMovingData.bind(this),this.canvasController.moveEnd=this.moveEnd.bind(this),this.canvasController.checkContextMenu=this.checkContextMenu.bind(this),this.canvasController.changeElementImage=this.changeElementImage.bind(this),this.canvasController.toImageGenerateView=this.toImageGenerateView.bind(this),this.canvasController.reGenerateElement=this.reGenerateElement.bind(this),this.canvasController.deleteElement=this.deleteElement.bind(this),this.canvasController.generateElement=this.generateElement.bind(this),this.canvasController.getLayerImage=this.getLayerImage.bind(this),this.canvasController.toTextEdit=this.toTextEdit.bind(this),this.canvasController.copyData=this.copyData.bind(this),this.canvasController.toElementSetting=this.toElementSetting.bind(this),this.movedElementUuid=null,this.movedElementData=null}save(e=0){return new Promise(((t,a)=>{const l=se.currentRoute;"/basic/generateImage"!==l.value.path||e?this.getSaveData().then((({jsonFile:e,preview:s,code:i,message:n})=>{if(200===i){const i=new FormData;i.append("file",e),"/basic/generateImage"===l.value.path||"/galleryUpdate"===l.value.path?this.saveOrUpdateArtWork(i,e.name.replace(".json",""),s).then((()=>{})).catch((e=>{450===e.code&&Nt.error("模板名称重复"),loading.close(),a(e)})):this.saveOrUpdateTemplate(i,e.name.replace(".json",""),s).then((()=>{t()})).catch((e=>{450===e.code&&Nt.error("模板名称重复"),a(e)}))}else Nt.error(n)})):t()}))}saveOrUpdateTemplate(e,t,a){const{templateId:l,template_level:s,template_filter:i,points:n}=this.canvasController;return new Promise(((r,o)=>{l?fe({resource_id:l,resource_type:jt,resource_name:t,preview:a,resource_level:s,resource_filter:i,points:n},e).then((e=>{Nt.success("保存成功"),r()})):ye({resource_type:jt,resource_name:t,preview:a,resource_level:s,resource_filter:i,points:n},e).then((e=>{this.canvasController.templateId=e.info.resource_id,Nt.success("保存成功"),r()})).catch((e=>{o(e)}))}))}saveOrUpdateArtWork(e,t,a){const{templateId:l,template_level:s,template_filter:r,points:o}=this.canvasController;return new Promise((d=>{if("/basic/generateImage"===se.currentRoute.value.path){let t=null;Pt.warning({title:"请输入作品名称",content:()=>i(n,{modelValue:t,"onUpdate:modelValue":e=>{t=e},onInput:e=>{t=e}}),positiveText:"确定",negativeText:"取消",onPositiveClick:()=>{be(e,t,a,s,r,o).then((e=>{Nt.success("保存成功"),d(),se.replace({path:"/galleryUpdate",query:{file_name:value,artwork_id:e.info.artwork_id}})})).catch((e=>{reject(e)}))},onNegativeClick:()=>{ae.error("取消保存")}})}else De(l,e,t,a,s,r,o).then((()=>{Nt.success("保存成功")})).catch((e=>{}));d()}))}async getSaveData(){const e=this.canvasController.getData(),t=this.dataController.getData(),a=JSON.parse(JSON.stringify(t));if(!e.name)return{code:500,message:"请设置文件名称后操作"};const s=l(),i=new Map;for(let l in a)for(let e in t[l])if("groups"!==l&&"texts"!==t[l][e].type&&(delete a[l][e].fontSetting,delete a[l][e].handleImage),"colors"!==l&&"texts"!==t[l][e].type&&delete a[l][e].color,"elements"===l&&(delete a[l][e].virtuallyElements,delete a[l][e].zIndex,delete a[l][e].children),t[l][e].image&&Tt(t[l][e].image.src))if(i.get(t[l][e].image.src)){const s=i.get(t[l][e].image.src);await this.setImage(l,e,s),a[l][e].image=s}else{const s=ce(t[l][e].image.src,e),n=new FormData;n.append("file",s);const r=(await this.saveImage(e,n)).data;i.set([t[l][e].image.src,r]),await this.setImage(l,e,r),a[l][e].image=r}else t[l][e].image&&t[l][e].image.src?a[l][e].image=t[l][e].image.src:a[l][e].image=null;const n=await this.getCanvasImage(),r=ce(n,s),o=new FormData;o.append("file",r);const d=await this.saveImage(s,o),u={viewData:e,layerData:a};for(let l in t){const e=t[l];if("elements"===l)break;for(let t in e)Object.assign(u,{[t]:{prompts:e[t].prompts,statics:e[t].statics,colors:e[t].colors,texts:e[t].texts}})}return{jsonFile:he(u,e.name),preview:d.data,code:200}}saveImage(e,t){return new Promise((a=>{pe(e,t).then((e=>{a(e)}))}))}setImage(e,t,a){return new Promise((l=>{const s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{this.dataController[e][t].setData({image:s}),l()},s.onerror=()=>{l()},s.src=a}))}clearAllData(){this.dataController.clearAllData(),this.reDraw()}reDraw(e=null){const t=this.dataController.elements,a=this.dataController.groups,l=this.dataController.layers,s=new Set;Object.keys(t).forEach((e=>{this.recomputationPosition(t[e])})),Object.keys(a).forEach((e=>{a[e].children.forEach((e=>{l[e].children.forEach((e=>{t[e].isShow&&s.add(e)}))}))})),Object.keys(l).forEach((e=>{l[e].children.forEach((e=>{t[e].isShow&&s.add(e)}))}));let i=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{let a=[];if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&i.push(t)}))}))}else a=this.dataController.getListByParentUuid(t),a=a.filter((e=>e.isShow)),i=i.concat(a)})),e&&(e.image=this.dataController.findData("layer",this.dataController.selectedMap.layer).image,i.push(e)),this.canvasController.clearAll(),i.forEach((e=>{this.drawItem(e)}));const n=this.dataController.selectedMap.element;if(t&&n&&t[n].isShow){this.canvasController.drawHandleArea(t[n]);const{virtuallyElements:e}=t[n];e&&e.length&&e.forEach((e=>{const[a,l]=e,{width:s,height:i,rotate:r,image:o,type:d,tileType:u}=t[n],c={x:a,y:l,width:s,height:i,rotate:r,image:o,type:d,tileType:u};this.canvasController.drawHandleArea(c)}))}this.canvasController.clearOther(),this.canvasController.ctx.globalCompositeOperation="destination-over",this.canvasController.drawMeshLine(),this.canvasController.ctx.globalCompositeOperation="source-over"}drawItem(e){const{virtuallyElements:t,type:a,color:l,tileType:s}=e;switch(a){case"colors":switch(s){case"tile_xy":case"tile_x":case"tile_y":this.canvasController.drawTileColor(e,s);break;default:this.canvasController.drawTileColor(e,"tile_xy")}break;case"texts":this.canvasController.drawTextItem(e),t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:s,height:i,rotate:n,fontSetting:r,type:o,tileType:d}=e,u={x:a,y:l,width:s,height:i,rotate:n,fontSetting:r,type:o,tileType:d};this.drawItem(u)}));break;case"statics":switch(s){case"tile_xy":case"tile_x":case"tile_y":this.canvasController.drawTileImage(e,s);break;default:this.canvasController.drawItem(e)}t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:s,height:i,rotate:n,image:r,type:o,tileType:d}=e,u={x:a,y:l,width:s,height:i,rotate:n,image:r,type:o,tileType:d};this.drawItem(u)}));break;default:this.canvasController.drawItem(e),t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:s,height:i,rotate:n,image:r,type:o,tileType:d,handleImage:u,xOverturn:c,yOverturn:h,opacity:m}=e,v={x:a,y:l,width:s,height:i,rotate:n,image:r,type:o,tileType:d,handleImage:u,xOverturn:c,yOverturn:h,opacity:m};this.drawItem(v)}))}}sendElement(e){const t=this.dataController.selectedMap.layer,a=this.dataController.findData("layer",t),{type:l}=a;if("texts"===l){const t=JSON.parse(JSON.stringify(a.fontSetting)),l=Xt.getTextWidth(t);e=Object.assign(e,{x:e.x+e.width/2-l/2,y:e.y+e.height/2-t.font_size/2,width:l,height:t.font_size,fontSetting:t})}this.dataController.add("element",t,null,e),this.reDraw()}toDraw(e){const t=this.dataController.selectedMap.layer;if(!t)return void Nt.error("请在选中图层后操作");const a=this.dataController.findData("layer",t);a&&a.tileType||this.canvasController.startDraw(e)}checkClickIsIn(e,t=!0){const a=this.dataController.elements,l=this.dataController.groups,s=this.dataController.layers,i=this.dataController.findData("element",this.dataController.selectedMap.element);let n=null;if(i&&t){if(this.canvasController.checkIsInItem(i,e))return{handleType:"main",data:i};if(n=this.canvasController.checkIsInHandleArea(i,e),n)return{handleType:n,data:i};const{virtuallyElements:t}=i;if(t&&t.length)for(let a of t){const[t,l]=a,{width:s,height:r,rotate:o,image:d,type:u,tileType:c}=i,h={x:t,y:l,width:s,height:r,rotate:o,image:d,type:u,tileType:c};if(n=this.canvasController.checkIsInHandleArea(h,e),n)return{handleType:n,data:i}}}const r=new Set;Object.keys(l).forEach((e=>{l[e].children.forEach((e=>{s[e].children.forEach((e=>{a[e].isShow&&r.add(e)}))}))})),Object.keys(s).forEach((e=>{s[e].children.forEach((e=>{a[e].isShow&&r.add(e)}))}));let o=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&o.push(t)}))}))}else{this.dataController.findData("layer",t).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&o.push(t)}))}})),o=o.reverse();let d=!1,u=!1;for(let c of o){const{virtuallyElements:t,type:a}=c;if(d=this.canvasController.checkIsInItem(c,e,!0),u||(u=this.canvasController.checkIsInItem(c,e,!1),u&&(u=c)),t&&t.length)for(let l of t){const[t,a]=l,{width:s,height:i,rotate:n,image:r}=c,o={x:t,y:a,width:s,height:i,rotate:n,image:r};d=this.canvasController.checkIsInItem(o,e,!0),u||(u=this.canvasController.checkIsInItem(c,e,!1),u&&(u=c))}if(d)return n="main",{handleType:n,data:c}}return u?{handleType:"main",data:u}:{handleType:null,data:null}}toSelectedElement(e){const{data:t}=this.checkClickIsIn(e,!1);if(!t)return this.dataController.selectedMap={group:null,layer:null,element:null},void this.reDraw();const a=this.dataController.findData("layer",t.parentUuid),l=a?this.dataController.findData("group",a.parentUuid):null,s=[l?l.uuid:null,a.uuid||null,t.uuid];this.dataController.changeSelected(s),this.reDraw()}checkMove(e){const t=this.checkClickIsIn(e),a=t.data,l=t.handleType;a&&a.uuid===this.dataController.selectedMap.element&&(this.movedElementUuid=a.uuid,this.movedElementData=JSON.parse(JSON.stringify(a)),this.movedElementData.image=a.image,this.canvasController.startMove(e,l))}checkContextMenu(e,t=!1){const a=this.checkClickIsIn(e),l=a.data;if(!l)return;const s=a.handleType,i=l.uuid,n=l.parentUuid,r=this.dataController.findData("layer",n).parentUuid||null;this.dataController.changeSelected([r,n,i]),l&&"main"===s&&(t?"texts"!==l.type&&"prompts"!==l.type||this.canvasController.contextMenu(e,l,l.type):this.canvasController.contextMenu(e,l))}setElementMovingData({xFloat:e,yFloat:t,rotateFloat:a,moveType:l},s){const i=this.dataController.elements[this.movedElementUuid],n=i.rotate,r=Math.cos(-n),o=Math.sin(-n);let{width:d,height:u}=i,c=e*r-e*o,h=e*o+t*r;switch(d=Math.round(100*d)/100,u=Math.round(100*u)/100,c=Math.round(100*c)/100,h=Math.round(100*h)/100,l){case"main":this.mainMove(i,e,t);break;case"left-top":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100}this.leftTopMove(i,c,h);break;case"top":if(s){let e=d/u;e=Math.round(100*e)/100,c=h*e,c=Math.round(100*c)/100,c=-c}else c=0;this.rightTopMove(i,c,h);break;case"right-top":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}this.rightTopMove(i,c,h);break;case"right":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*c)/100}else h=0;this.rightBottomMove(i,c,h);break;case"right-bottom":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100}this.rightBottomMove(i,c,h);break;case"bottom":if(s){let e=d/u;e=Math.round(100*e)/100,c=h*e,c=Math.round(100*c)/100}else c=0;this.rightBottomMove(i,c,h);break;case"left-bottom":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}this.leftBottomMove(i,c,h);break;case"left":if(s){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}else h=0;this.leftBottomMove(i,c,h);break;case"rotate":this.rotateMove(i,e,t,a)}this.reDraw()}moveEnd(){this.dataController.elements[this.movedElementUuid].setData({},1,this.movedElementData),this.movedElementUuid=null,this.movedElementData=null}mainMove(e,t,a){e.setData({x:e.x+t,y:e.y+a},0),this.recomputationPosition(e)}leftTopMove(e,t,a){let{width:l,height:s,x:i,y:n}=e;l-t<0||(l-=t,s-=a/2,i+=t,n+=a/2),s-a<0||(s-=a/2,n+=a/2),e.setData({x:i,y:n,width:l,height:s},0)}topMove(e,t,a){let{height:l,y:s}=e;l-a<0||(l-=a,s+=a),e.setData({y:s,height:l},0)}rightTopMove(e,t,a){let{width:l,height:s,y:i}=e;l+t<0||(l+=t),s-a<0||(s-=a,i+=a),e.setData({width:l,height:s,y:i},0)}rightMove(e,t,a){let{width:l}=e;l+t<0||(l+=t),e.setData({width:l},0)}rightBottomMove(e,t,a){let{width:l,height:s}=e;l+t<0||(l+=t),s+a<0||(s+=a),e.setData({width:l,height:s},0)}bottomMove(e,t,a){let{height:l}=e;l+a<0||(l+=a),e.setData({height:l},0)}leftBottomMove(e,t,a){let{width:l,height:s,x:i}=e;l-t<0||(l-=t,i+=t),s+a<0||(s+=a),e.setData({width:l,height:s,x:i},0)}leftMove(e,t,a){let{width:l,x:s}=e;l-t<0||(l-=t,s+=t),e.setData({x:s,width:l},0)}rotateMove(e,t,a,l){const{x:s,y:i,width:n,height:r,rotate:o}=e;let d=function([e,t],[a,l],[s,i]){const n=a-e,r=l-t,o=s-e,d=i-t;let u=(n*o+r*d)/(Math.sqrt(n*n+r*r)*Math.sqrt(o*o+d*d));if(isNaN(u))return 0;let c=Math.acos(u);return n*d-r*o<0&&(c=-c),isNaN(c)?Math.PI/1800:Number(c.toFixed(2))}([s+n/2,i+r/2],l,[l[0]+t,l[1]+a]);e.setData({rotate:o+d},0)}recomputationPosition(e){const{drawType:t}=this.canvasController,{realWidth:a,realHeight:l}=this.canvasController;switch(t){case Dt:e.virtuallyElements=[],this.recomputationMainPosition(a,l,e);break;case kt:e.virtuallyElements=[],this.recomputationAgentXPosition(a,e),this.recomputationMainPosition(a,l,e);break;case xt:e.virtuallyElements=[],this.recomputationAgentYPosition(l,e),this.recomputationMainPosition(a,l,e);break;case It:e.virtuallyElements=[],this.recomputationAgentFPosition(a,l,e),this.recomputationMainPosition(a,l,e)}}recomputationMainPosition(e,t,a){const{virtuallyElements:l,x:s,y:i,width:n,height:r}=a;let o=JSON.parse(JSON.stringify(l));o.length&&(Ht([s+n/2,i+r/2],[e,t])||o.forEach(((l,d)=>{const[u,c]=l;Ht([u+n/2,c+r/2],[e,t])&&(o[d]=[s,i],a.setData({x:u,y:c,virtuallyElements:o}))})))}recomputationAgentXPosition(e,t){const{x:a,y:l,virtuallyElements:s,width:i,height:n,rotate:r}=t;let o=i;r&&(o=Ft(i,n,r).width),a+i/2+o/2>e?s.push([a-e,l]):a+i/2-o/2<0&&s.push([e+a,l]),t.setData({virtuallyElements:s})}recomputationAgentYPosition(e,t){const{x:a,y:l,virtuallyElements:s,width:i,height:n,rotate:r}=t;let o=n;r&&(o=Ft(i,n,r).height),l+n/2+o/2>e?s.push([a,l-e]):l+n/2-o/2<0&&s.push([a,e+l]),t.setData({virtuallyElements:s})}recomputationAgentFPosition(e,t,a){this.recomputationAgentXPosition(e,a),this.recomputationAgentYPosition(t,a);const{virtuallyElements:l,x:s,drawY:i,width:n,height:r}=a;2===l.length&&(s===l[0][0]?l.push([l[1][0],l[0][1]]):l.push([l[0][0],l[1][1]])),a.setData({virtuallyElements:l})}deleteElement(e){this.dataController.delete("element",e),this.reDraw()}reGenerateElement(e){}toImageGenerateView(e){}toElementSetting(e){this.toElementSetting(e)}async changeElementImage(e,t){const a=this.dataController.findData("element",e);let l=new Gt(e,t,Boolean(a.edgeFeather)),s=null;a.hue&&Array.isArray(a.hue)&&(s=await l.grayToColor(a.hue)),a.edgeFeather&&(s=await l.edgeFeather(a.edgeFeather/100)),l=null,this.dataController.elements[e].setData({image:t,handleImage:s}),this.reDraw()}async getCanvasImage(){await this.canvasController.resize();const{zoomRatio:e,realWidth:t,realHeight:a,drawX:l,drawY:s}=this.canvasController;this.reDraw();const i=this.dataController.elements,n=this.dataController.groups,r=this.dataController.layers,o=new Set;Object.keys(i).forEach((e=>{this.recomputationPosition(i[e])})),Object.keys(n).forEach((e=>{n[e].children.forEach((e=>{r[e].children.forEach((e=>{i[e].isShow&&o.add(e)}))}))})),Object.keys(r).forEach((e=>{r[e].children.forEach((e=>{i[e].isShow&&o.add(e)}))}));let d=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&d.push(t)}))}))}else{this.dataController.findData("layer",t).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&d.push(t)}))}})),this.canvasController.clearAll(),d.forEach((e=>{this.drawItem(e)}));const u=t*e,c=a*e,h=this.canvasController.ctx.getImageData(l,s,u,c),{canvas:m,ctx:v}=St({width:u,height:c});v.putImageData(h,0,0);const p=m.toDataURL("image/png");return this.canvasController.resize().then((()=>{this.reDraw()})),p}async generateAll(){const e=ke(),t=Object.keys(this.dataController.groups).map((e=>this.dataController.groups[e])),a=this.dataController.layers,l=Object.keys(a).filter((e=>!this.dataController.layers[e].parentUuid)).map((e=>this.dataController.layers[e])),s=[];if(!t.length&&!l.length)return e.close(),void Nt.error("请在添加图层后生成");if(t.length&&t.forEach((e=>{s.push({type:"Group",dataType:e.type,name:e.name,generateUuid:e.uuid,children:e.children,resource_name:e.resource_name,resource_id:e.resource_id,uuid:e.uuid})})),l.length){for(let e of l)s.push({type:"Layer",name:e.name,dataType:e.type,generateUuid:e.uuid,uuid:e.uuid,resource_name:e.resource_name,resource_id:e.resource_id,prompt:e.prompt});const{templateId:t,name:a}=this.canvasController;Je.addTask(t,a,"All",s),e.close(),Nt.success("生成任务已提交")}}async setGroupGenerateResult(e){const t=Object.keys(e);for(let a=0;a<t.length;a++)await this.setLayerGenerateResult({[t[a]]:e[t[a]]})}async setLayerGenerateResult(e){const t=Object.keys(e);for(let a=0;a<t.length;a++){const l=this.dataController.findData("layer",t[a]),{type:s}=l;if(!e[t[a]])break;switch(s){case"texts":await this.setResultText(l,e[t[a]].task_result);break;case"colors":this.setResultColor(l,e[t[a]].task_result);break;default:await this.setResultImage(l,e[t[a]].task_result)}}this.reDraw()}async setElemenyGenerateResult(e,t){const a=Object.keys(e);for(let l=0;l<a.length;l++){const s=this.dataController.findData("element",t),{type:i}=s;switch(i){case"texts":const i=e[a[l]].task_result,n=await Mt(i.font);i.fontFamily=n;const r={fontSetting:i,width:this.canvasController.getTextWidth(i),height:i.font_size};s.setData(r);break;case"colors":s.setData({color:e[a[l]].task_result.color});break;default:const o=await re(e[a[l]].task_result);if(s.setData({image:o}),s.hue&&Array.isArray(s.hue)){const e=new Gt(t,o),a=await e.grayToColor(s.hue);s.setData({handleImage:a})}}}this.reDraw()}async setResultImage(e,t){const{uuid:a}=e,l=await re(t);this.dataController.layers[a].setData({image:l});for(let s=0;s<e.children.length;s++){const t=e.children[s],a=this.dataController.findData("element",t);if(a.setData({image:l}),a.hue&&Array.isArray(a.hue)){const e=new Gt(t,l),s=await e.grayToColor(a.hue);a.setData({handleImage:s})}}}async setResultText(e,t){const a=t,l=await Mt(a.font);a.fontFamily=l,e.setData({fontSetting:a}),e.children.forEach((e=>{const t=this.dataController.elements[e],l={fontSetting:a,width:this.canvasController.getTextWidth(a),height:a.font_size};t.setData(l)}))}setResultColor(e,t){e.children.forEach((e=>{this.dataController.elements[e].setData({color:t.color})}))}async generateGroup(e){const t=ke(),a=this.dataController.findData("group",e),l=[];l.push({type:"Group",dataType:a.type,name:a.name,generateUuid:a.uuid,uuid:a.uuid,children:a.children,resource_name:a.resource_name,resource_id:a.resource_id});const{templateId:s,name:i}=this.canvasController;Je.addTask(s,i,"Group",l),this.reDraw(),t.close()}async generateLayer(e){const t=ke(),a=this.dataController.findData("layer",e),l=[];l.push({type:"Layer",name:a.name,dataType:a.type,generateUuid:a.uuid,uuid:a.uuid,resource_name:a.resource_name,resource_id:a.resource_id,prompt:a.prompt});const{templateId:s,name:i}=this.canvasController;Je.addTask(s,i,"Layer",l),this.reDraw(),t.close()}async generateElement(e){const t=this.dataController.findData("element",e),a=this.dataController.findData("layer",t.parentUuid),l=ke(),s=[];s.push({type:"Element",dataType:a.type,name:t.name,generateUuid:a.uuid,uuid:t.uuid,resource_name:a.resource_name,resource_id:a.resource_id,prompt:a.prompt});const{templateId:i,name:n}=this.canvasController;Je.addTask(i,n,"Element",s),this.reDraw(),l.close()}toImageGenerateView(e,t){const a=this.dataController.findData("element",e),{image:l,uuid:s}=a;this.toImageGenerateView({image:l.src,uuid:s},t)}async getLayerImage(e=!1){await this.canvasController.resize();const{zoomRatio:t,realWidth:a,realHeight:l,drawX:s,drawY:i}=this.canvasController;this.reDraw(),e&&this.canvasController.getRealCanvas();const n=this.dataController.elements,r=this.dataController.groups,o=this.dataController.layers,d=new Set;Object.keys(n).forEach((e=>{this.recomputationPosition(n[e])})),Object.keys(r).forEach((e=>{r[e].children.forEach((e=>{o[e].isShow&&d.add(e)}))})),Object.keys(o).forEach((e=>{o[e].children.forEach((t=>{o[e].isShow&&d.add(e)}))}));const u=[];let c=[];return this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{const t=this.dataController.findData("layer",e);t.isShow&&c.push(t)}))}else{const e=this.dataController.findData("layer",t);if(!e.isShow)return;c.push(e)}})),c.forEach((e=>{this.canvasController.clearAll(),e.children.forEach((e=>{const t=n[e];this.drawItem(t)}));const r=a*t,o=l*t,d=this.canvasController.ctx.getImageData(s,i,r,o),{canvas:c,ctx:h}=St({width:r,height:o});h.putImageData(d,0,0),u.push({name:e.name,uuid:e.uuid,image:c.toDataURL("image/png")})})),"editor"===this.canvasController.viewType&&await this.canvasController.resize(),this.reDraw(),u.reverse()}async getAllImage(){this.canvasController.getRealCanvas();const{zoomRatio:e,realWidth:t,realHeight:a,drawX:l,drawY:s,canvasDom:i}=this.canvasController;this.reDraw();const n=Math.floor(Math.min(i.width,i.height)),r=this.dataController.elements,o=this.dataController.groups,d=this.dataController.layers,u=new Set;Object.keys(r).forEach((e=>{this.recomputationPosition(r[e])})),Object.keys(o).forEach((e=>{o[e].children.forEach((e=>{d[e].isShow&&u.add(e)}))})),Object.keys(d).forEach((e=>{d[e].children.forEach((t=>{d[e].isShow&&u.add(e)}))}));const c=[];let h=[];return this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{const t=this.dataController.findData("layer",e);t.isShow&&h.push(t)}))}else{const e=this.dataController.findData("layer",t);if(!e.isShow)return;h.push(e)}})),h.forEach((e=>{const l=[];for(let s=0;s<Math.ceil(t/n);s++){this.canvasController.drawX=-s*n,l[s]=[];let i=n;n*(s+1)>t&&(i=t%n);for(let t=0;t<Math.ceil(a/n);t++){this.canvasController.drawY=-t*n;let o=n;n*(t+1)>a&&(o=a%n),this.canvasController.clearAll(),e.children.forEach((e=>{const t=r[e];this.drawItem(t)}));const d=this.canvasController.ctx.getImageData(0,0,i,o),{canvas:u,ctx:c}=St({width:i,height:o});c.putImageData(d,0,0),l[s].push(u.toDataURL("image/png"))}}c.push({name:e.name,uuid:e.uuid,image:l})})),await this.canvasController.resize(),this.reDraw(),c.reverse()}toTextEdit(e,t="text"){const a=this.dataController.findData("element",e);this.toTextEditView(a,t)}copyData(e){this.dataController.copyData(e,"element")}},Wt=a(Yt.dataController),Xt=a(Yt.canvasController),Bt=a(Yt.generationController),$t={class:"element-item"},Jt=["id"],Zt=["title"],Vt={class:"element-handle-area"},Qt=xe({__name:"elementLayers",props:{data:{},editorType:{},editorLayersDom:{},groupUuid:{default:null},layerUuid:{default:null},needGenerate:{type:Boolean,default:!0},isLast:{}},emits:["toLayerInfo"],setup(e,{emit:t}){const a=r(Wt),l=r(Yt),s=r(Xt),i=r(!1),n=r(!1),g=r(!1),y=r(null),f=e,w=t,b=(...e)=>{w("toLayerInfo",...e)},D=(e,t,l,s=null)=>{l.preventDefault(),n.value=!1,g.value=!1,i.value=!1,window.dragDomId=null;const r=JSON.parse(l.dataTransfer.getData("text/plain")),o={uuid:e,type:t};a.value.bindGroup({fromData:r,toData:o,zIndex:s})};return(t,r)=>(o(),d("div",$t,[u("div",{class:c(["drop-to-line",{droped:n.value}]),onDragover:r[0]||(r[0]=h((e=>n.value=!0),["prevent"])),onDragleave:r[1]||(r[1]=h((e=>n.value=!1),["prevent"])),onDrop:r[2]||(r[2]=h((e=>D(f.data.uuid,f.data.type,e,f.data.zIndex)),["stop"]))},null,34),u("div",{class:c(["element-title",{selected:a.value.isSelected("element",f.data.uuid)}]),ref_key:"dropOverDom",ref:y,id:`${f.data.type}_${f.data.uuid}`,onContextmenu:r[6]||(r[6]=e=>((e,t,l)=>{const i=a.value.findData(e,t),{pageX:n,pageY:r}=l;s.value.handleController.setHandle(i,{x:n,y:r},e,Boolean(i.image),f.editorLayersDom).then((l=>{const{name:n}=l;switch(e){case"element":s.value.contextmenuCallBack(l);break;case"layer":switch(n){case ct:a.value.delete(e,t);break;case rt:b(i);break;case vt:a.value.copyData(t,e)}break;case"group":switch(n){case ht:a.value.delete(e,t);break;case pt:a.value.copyData(t,e)}}}))})("element",f.data.uuid,e)),onClick:r[7]||(r[7]=e=>a.value.changeSelected([f.groupUuid,f.layerUuid,f.data.uuid])),onDragover:r[8]||(r[8]=h((e=>(f.data.uuid,f.data.type,void(y.value.id!==window.dragDomId&&(i.value=!0)))),["prevent"])),onDragleave:r[9]||(r[9]=h((e=>i.value=!1),["prevent"])),draggable:"true",onDragstart:r[10]||(r[10]=e=>{return t=f.data.uuid,a=f.data.type,l=e,window.dragDomId=y.value.id,void l.dataTransfer.setData("text/plain",JSON.stringify({uuid:t,type:a}));var t,a,l})},[u("div",{class:"element-name",title:a.value.elements[f.data.uuid].name},m(a.value.elements[f.data.uuid].name)+" "+m(f.data.zIndex),9,Zt),u("div",Vt,["gallery"!==e.editorType&&e.needGenerate?(o(),d("div",{key:0,class:c(["pointer icon bi",v(H)]),onClick:r[3]||(r[3]=h((e=>((...e)=>{l.value.generateElement(...e)})(f.data.uuid)),["stop"]))},null,2)):p("",!0),u("div",{class:c(["pointer icon bi",a.value.elements[f.data.uuid].isShow?v(W):v(X)]),onClick:r[4]||(r[4]=h((()=>{a.value.handleIsShow("element",f.data.uuid,a.value.elements[f.data.uuid].isShow?"hide":"show"),w("setDiagramImage")}),["stop"]))},null,2),"edit"===f.editorType?(o(),d("div",{key:1,class:c(["pointer icon bi",v(B)]),onClick:r[5]||(r[5]=h((e=>a.value.delete("element",f.data.uuid)),["stop"]))},null,2)):p("",!0)])],42,Jt),f.isLast?(o(),d("div",{key:0,class:c(["drop-to-line",{droped:g.value}]),onDragover:r[11]||(r[11]=h((e=>g.value=!0),["prevent"])),onDragleave:r[12]||(r[12]=h((e=>g.value=!1),["prevent"])),onDrop:r[13]||(r[13]=h((e=>D(f.data.uuid,f.data.type,e,0)),["stop"]))},null,34)):p("",!0)]))}},[["__scopeId","data-v-9ca8701c"]]),qt={class:"layer-list"},Kt=["id"],ea=["title"],ta={class:"layer-handle-area"},aa=xe({__name:"layerLayers",props:{data:{},editorType:{},editorLayersDom:{},groupUuid:{default:null},isLast:{},dropType:{default:"layer"}},emits:["toLayerInfo","setChildLength"],setup(e,{emit:t}){const a=r(Wt),l=r(Yt),s=r(Xt),i=r(!1),n=r(null),D=e,k=r(!1),x=r(!1),I=t,C=()=>{const{uuid:e}=D.data;if(!e)return[];const t=a.value.findData("layer",e),l=[];t.children.forEach((e=>{const t=a.value.findData("element",e);l[t.zIndex-1]={name:t.name,uuid:t.uuid,type:"element",zIndex:t.zIndex}}));for(let a=0;a<l.length;a++)if(!l[a])return[];return I("setChildLength",{uuid:D.data.uuid,length:_(l)}),l.reverse()},_=e=>a.value.isShowMapShow("layer",D.data.uuid)?e.length:0,T=(...e)=>{I("toLayerInfo",...e)},M=(e,t,l,s=null)=>{l.preventDefault(),k.value=!1,x.value=!1,i.value=!1,window.dragDomId=null;const n=JSON.parse(l.dataTransfer.getData("text/plain")),r={uuid:e,type:t};a.value.bindGroup({fromData:n,toData:r,zIndex:s})};return(t,r)=>(o(),d("div",qt,[u("div",{class:c(["drop-to-line",{droped:k.value}]),onDragover:r[0]||(r[0]=h((e=>k.value=!0),["prevent"])),onDragleave:r[1]||(r[1]=h((e=>k.value=!1),["prevent"])),onDrop:r[2]||(r[2]=h((e=>M(D.data.uuid,D.data.type,e,D.data.zIndex)),["stop"]))},null,34),u("div",{class:c(["layer-title",{selected:a.value.isSelected("layer",D.data.uuid)&&!i.value,dropover:i.value}]),ref_key:"dropOverDom",ref:n,id:`${D.data.type}_${D.data.uuid}`,onClick:r[7]||(r[7]=e=>a.value.changeSelected([D.groupUuid,D.data.uuid,null])),onDragover:r[8]||(r[8]=h((e=>(D.data.uuid,D.data.type,void(n.value.id!==window.dragDomId&&(i.value=!0)))),["prevent"])),onDragleave:r[9]||(r[9]=h((e=>i.value=!1),["prevent"])),onContextmenu:r[10]||(r[10]=e=>((e,t,l)=>{const i=a.value.findData(e,t),{pageX:n,pageY:r}=l;s.value.handleController.setHandle(i,{x:n,y:r},e,Boolean(i.image),D.editorLayersDom).then((l=>{const{name:n}=l;switch(e){case"element":s.value.contextmenuCallBack(l);break;case"layer":switch(n){case ct:a.value.delete(e,t);break;case rt:T(i);break;case vt:a.value.copyData(t,e)}break;case"group":switch(n){case ht:a.value.delete(e,t);break;case pt:a.value.copyData(t,e)}}}))})("layer",D.data.uuid,e)),onDrop:r[11]||(r[11]=h((e=>M(D.data.uuid,D.data.type,e)),["stop"])),draggable:"true",onDragstart:r[12]||(r[12]=e=>{return t=D.data.uuid,a=D.data.type,l=e,window.dragDomId=n.value.id,void l.dataTransfer.setData("text/plain",JSON.stringify({uuid:t,type:a}));var t,a,l})},[u("div",{class:"layer-name",title:a.value.layers[D.data.uuid].name},[u("div",{class:c(["icon bi",`${v($)} ${a.value.isShowMapShow("layer",D.data.uuid)?"selected":""}`]),onClick:r[3]||(r[3]=h((()=>{a.value.handleShowMap("layer",D.data.uuid)}),["stop"]))},null,2),g(" "+m(a.value.layers[D.data.uuid].name)+" "+m(D.data.zIndex),1)],8,ea),u("div",ta,["gallery"!==e.editorType&&"texts"!==a.value.layers[D.data.uuid].type?(o(),d("div",{key:0,class:c(["pointer icon bi",v(H)]),onClick:r[4]||(r[4]=h((e=>((...e)=>{l.value.generateLayer(...e)})(D.data.uuid)),["stop"]))},null,2)):p("",!0),u("div",{class:c(["pointer icon bi",a.value.layers[D.data.uuid].isShow?v(W):v(X)]),onClick:r[5]||(r[5]=h((()=>{a.value.handleIsShow("layer",D.data.uuid,a.value.layers[D.data.uuid].isShow?"hide":"show"),I("setDiagramImage")}),["stop"]))},null,2),"edit"===D.editorType?(o(),d("div",{key:1,class:c(["pointer icon bi",v(B)]),onClick:r[6]||(r[6]=h((e=>a.value.delete("layer",D.data.uuid)),["stop"]))},null,2)):p("",!0)])],42,Kt),u("div",{class:"child-list",style:b({maxHeight:a.value.isShowMapShow("layer",D.data.uuid)?1.1*C().length+"rem":"0rem"})},[(o(!0),d(y,null,f(C(),((e,t)=>(o(),w(Qt,{layerUuid:D.data.uuid,groupUuid:D.groupUuid,onToLayerInfo:T,editorType:D.editorType,editorLayersDom:D.editorLayersDom,isLast:t===C().length-1,needGenerate:"texts"!==a.value.layers[D.data.uuid].type,data:e,key:e.uuid},null,8,["layerUuid","groupUuid","editorType","editorLayersDom","isLast","needGenerate","data"])))),128))],4),D.isLast?(o(),d("div",{key:0,class:c(["drop-to-line",{droped:x.value}]),onDragover:r[13]||(r[13]=h((e=>x.value=!0),["prevent"])),onDragleave:r[14]||(r[14]=h((e=>x.value=!1),["prevent"])),onDrop:r[15]||(r[15]=h((e=>M(D.data.uuid,D.data.type,e,0)),["stop"]))},null,34)):p("",!0)]))}},[["__scopeId","data-v-5337d4b7"]]),la={class:"group-list"},sa=["id"],ia=["title"],na={class:"group-handle-area"},ra=xe({__name:"groupLayers",props:{data:{},editorType:{},editorLayersDom:{},isLast:{}},emits:["toLayerInfo"],setup(e,{emit:t}){const a=r(Wt),l=r(Yt),s=r(Xt),i=r(!1),n=r(!1),D=e,k=r(new Map),x=r(!1),I=r(null),C=t,_=()=>{const{uuid:e}=D.data;if(!e)return[];const t=a.value.findData("group",e),l=[];return t.children.forEach((e=>{const t=a.value.findData("layer",e);l[t.zIndex-1]={type:"layer",uuid:t.uuid,zIndex:t.zIndex}})),l.reverse()},T=({uuid:e,length:t})=>{k.value.set(e,t)},M=e=>{if(!a.value.isShowMapShow("group",D.data.uuid))return 0;let t=e.length;for(let[a,l]of k.value)t+=l;return t},S=(e,t,l,s=null)=>{l.preventDefault(),i.value=!1,n.value=!1,x.value=!1,window.dragDomId=null;const r=JSON.parse(l.dataTransfer.getData("text/plain")),o={uuid:e,type:t};a.value.bindGroup({fromData:r,toData:o,zIndex:s})},E=(...e)=>{C("toLayerInfo",...e)};return(t,r)=>(o(),d("div",la,[u("div",{class:c(["drop-to-line",{droped:i.value}]),onDragover:r[0]||(r[0]=h((e=>i.value=!0),["prevent"])),onDragleave:r[1]||(r[1]=h((e=>i.value=!1),["prevent"])),onDrop:r[2]||(r[2]=h((e=>S(D.data.uuid,D.data.type,e,D.data.zIndex)),["stop"]))},null,34),u("div",{class:c(["group-title",{selected:a.value.isSelected("group",D.data.uuid)&&!x.value,dropover:x.value}]),ref_key:"dropOverDom",ref:I,id:`${D.data.type}_${D.data.uuid}`,onDragover:r[7]||(r[7]=h((e=>(D.data.uuid,D.data.type,void(I.value.id!==window.dragDomId&&(x.value=!0)))),["prevent"])),onDragleave:r[8]||(r[8]=h((e=>x.value=!1),["prevent"])),onContextmenu:r[9]||(r[9]=e=>((e,t,l)=>{const i=a.value.findData(e,t),{pageX:n,pageY:r}=l;s.value.handleController.setHandle(i,{x:n,y:r},e,Boolean(i.image),D.editorLayersDom).then((l=>{const{name:n}=l;switch(e){case"element":s.value.contextmenuCallBack(l);break;case"layer":switch(n){case ct:a.value.delete(e,t);break;case rt:E(i);break;case vt:a.value.copyData(t,e)}break;case"group":switch(n){case ht:a.value.delete(e,t);break;case pt:a.value.copyData(t,e)}}}))})("group",D.data.uuid,e)),onDrop:r[10]||(r[10]=h((e=>S(D.data.uuid,"group",e)),["stop"])),onClick:r[11]||(r[11]=e=>a.value.changeSelected([D.data.uuid,null,null])),draggable:"true",onDragstart:r[12]||(r[12]=e=>{return t=D.data.uuid,a=D.data.type,l=e,window.dragDomId=I.value.id,void l.dataTransfer.setData("text/plain",JSON.stringify({uuid:t,type:a}));var t,a,l})},[u("div",{class:"group-name",title:a.value.groups[D.data.uuid].name},[u("div",{class:c(["icon bi",`${v($)} ${a.value.isShowMapShow("group",D.data.uuid)?"selected":""}`]),onClick:r[3]||(r[3]=h((()=>{a.value.handleShowMap("group",D.data.uuid)}),["stop"]))},null,2),g(" "+m(a.value.groups[D.data.uuid].name)+" "+m(D.data.zIndex),1)],8,ia),u("div",na,["gallery"!==e.editorType?(o(),d("div",{key:0,class:c(["pointer icon bi",v(H)]),onClick:r[4]||(r[4]=h((e=>((...e)=>{l.value.generateGroup(...e)})(D.data.uuid)),["stop"]))},null,2)):p("",!0),u("div",{class:c(["pointer icon bi",a.value.groups[D.data.uuid].isShow?v(W):v(X)]),onClick:r[5]||(r[5]=h((()=>{a.value.handleIsShow("group",D.data.uuid,a.value.groups[D.data.uuid].isShow?"hide":"show"),C("setDiagramImage")}),["stop"]))},null,2),"edit"===D.editorType?(o(),d("div",{key:1,class:c(["pointer icon bi",v(B)]),onClick:r[6]||(r[6]=h((e=>a.value.delete("group",D.data.uuid)),["stop"]))},null,2)):p("",!0)])],42,sa),u("div",{class:"child-list",style:b({maxHeight:1.1*M(_())+"rem"})},[(o(!0),d(y,null,f(_(),((e,t)=>(o(),w(aa,{groupUuid:D.data.uuid,onToLayerInfo:E,onSetChildLength:T,editorType:D.editorType,editorLayersDom:D.editorLayersDom,isLast:t===_().length-1,data:e,key:t},null,8,["groupUuid","editorType","editorLayersDom","isLast","data"])))),128))],4),D.isLast?(o(),d("div",{key:0,class:c(["drop-to-line",{droped:n.value}]),onDragover:r[13]||(r[13]=h((e=>n.value=!0),["prevent"])),onDragleave:r[14]||(r[14]=h((e=>n.value=!1),["prevent"])),onDrop:r[15]||(r[15]=h((e=>S(D.data.uuid,D.data.type,e,0)),["stop"]))},null,34)):p("",!0)]))}},[["__scopeId","data-v-928c7836"]]),oa={class:"editor-layers-title"},da=xe({__name:"editorLayers",props:{viewType:{type:String,default:"编辑器"},typeList:{type:Array,default:()=>[]},groupList:{type:Array,default:()=>[]},editorType:{}},emits:["toLayerInfo","setSelectedLayer","deleteGroup","deleteLayer","deleteElement","setGroup","hideLayer","reGenerateGroup","reGenerateLayer","reGenerateElement","setDiagramImage"],setup(e,{expose:t,emit:a}){const l=r(Wt);r(Yt),r(Xt);const s=r(!1),i=e,n=a,m=r(null),b=(...e)=>{n("toLayerInfo",...e)};return D((()=>{s.value=!0})),t({setSelectedElement:e=>{const t=i.typeList.find((t=>new Set(Object.keys(t.layerInfo)).has(e))),a=t?t.uuid:null,l=i.groupList.find((e=>new Set(e.layers).has(a))),s=l?l.uuid:null;selectedElement(e,a,s)}}),(t,a)=>{const n=k("n-scrollbar");return o(),d("div",{class:c(["editor-layers",{inView:s.value}]),ref_key:"editorLayersDom",ref:m},[u("div",oa,[a[4]||(a[4]=u("div",{class:"title-name"},[u("i",{class:"bi bi-layers"}),g(" 图层 ")],-1)),"generate"!==e.editorType&&"gallery"!==e.editorType?(o(),d("i",{key:0,class:c(["pointer icon bi",v(J)]),onClick:a[0]||(a[0]=e=>b())},null,2)):p("",!0)]),u("div",{class:"list-outer",onDragover:a[2]||(a[2]=h((()=>{}),["prevent"])),onDrop:a[3]||(a[3]=e=>(e=>{e.preventDefault();const t=JSON.parse(e.dataTransfer.getData("text/plain")),{type:a,uuid:s}=t;if(l.value.findData(a,s).parentUuid)l.value.unbindGroup(t);else{const e=l.value.getAllList().reverse();l.value.bindGroup({fromData:t,toData:e[e.length-1],zIndex:e[e.length-1].zIndex+1})}})(e))},[x(n,{onWheel:a[1]||(a[1]=h((()=>{}),["stop"]))},{default:I((()=>[(o(!0),d(y,null,f(l.value.getAllList().reverse(),((e,t)=>(o(),d(y,null,[e&&"group"===e.type?(o(),w(ra,{isFirst:0===t,isLast:t===l.value.getAllList().length-1,onToLayerInfo:b,editorType:i.editorType,data:e,key:e?e.uuid:t},null,8,["isFirst","isLast","editorType","data"])):p("",!0),e&&"layer"===e.type?(o(),w(aa,{isFirst:0===t,isLast:t===l.value.getAllList().length-1,onToLayerInfo:b,editorType:i.editorType,data:e,key:e?e.uuid:t},null,8,["isFirst","isLast","editorType","data"])):p("",!0)],64)))),256))])),_:1})],32)],2)}}},[["__scopeId","data-v-6351d652"]]),ua={class:"menu-icon"},ca=["src"],ha={class:"menu-all"},ma=["onClick"],va={class:"menu-icon"},pa={class:"menu-name"},ga=xe({__name:"editorHandle",props:["editorType"],emits:["changeHandleType","exportImage","changeViewType","toGenrateGroup","toAdvancedSettingDom","save"],setup(e,{emit:t}){const a=C(),{publicStore:l}=ne(),s=r(Xt),i=r(Yt),n=_();T();const h=r([]),p=r(null),g=r(0),w=r(0),b=e,M=t,S=()=>{const e=E();return[].concat([],e)},E=()=>{let e=[{name:"下载图片",icon:Z,async click(){const e=n.query.template_id||s.value.templateId,t=n.query.file_name||s.value.name,a=s.value.template_level;if(!e)return;const l="/basic/artWorkInfo"===n.path?"Artwork":"Template",i=[];"Artwork"===l&&(i.push({artwork_name:t,artwork_id:e,artwork_level:a}),Je.addTask(e,t,l,i,$e))}},{name:"/generateImage"===n.path?"作品保存":"模板保存",icon:V,click(){if(!s.value.name)return a.error("请在设置模板名称后操作"),void M("toCanvasSetting");i.value.save(1)}},{name:"效果调节",icon:N,click(){M("toAdvancedSettingDom")}},{name:"测试生成",icon:w.value?H:Q,click(){Object.keys(Wt.layers).length?(w.value++,i.value.generateAll()):a.error("请在绘制元素后进行生成")}},{name:"分层展示",icon:q,click(){M("changeViewType")}}];if("edit"===b.editorType&&(e=e.concat([{name:"画板设置",icon:K,click(){M("toCanvasSetting")}}])),"gallery"===b.editorType){const t=e.findIndex((e=>"测试生成"===e.name));e.splice(t,1)}return e};return D((()=>{p.value=n.path,h.value=[]})),(e,t)=>{const a=k("el-icon");return o(),d("div",{class:c(["left-bar-body",{expand:g.value}])},[u("div",{class:"menu-title",onClick:t[0]||(t[0]=e=>(g.value=Number(!g.value),void l.setLeftBarShowType(g.value)))},[u("div",ua,[x(a,{class:"icon"},{default:I((()=>[u("img",{src:v(Ie)},null,8,ca)])),_:1})]),t[1]||(t[1]=u("div",{class:"menu-name"},null,-1))]),u("div",ha,[(o(!0),d(y,null,f(S(),((e,t)=>(o(),d("div",{class:"menu-item",key:t,onClick:t=>e.click()},[u("div",va,[u("i",{class:c(["bi icon",e.icon])},null,2)]),u("div",pa,m(e.name),1)],8,ma)))),128))])],2)}}},[["__scopeId","data-v-e4556794"]]),ya={class:"editor-draw-board-setting-box"},fa={class:"editor-draw-board-setting-title"},wa={class:"editor-draw-board-setting-handle-area"},ba={class:"setting-item"},Da={class:"setting-item-value"},ka={class:"setting-item"},xa={class:"setting-item-value"},Ia={class:"setting-item-value"},Ca={class:"setting-item"},_a={class:"setting-item-value"},Ta=xe({__name:"editorDrawBoardSetting",props:["editorType"],setup(e,{expose:t}){const a=C(),l=_(),s=e,i="/basic/modelEditor"===l.path,n=r(!1);r(null);const h=r({}),m=r(Xt),p=r(Bt),y=()=>{n.value=!1};return t({show:e=>{n.value?y():(h.value=Xt.getData(),n.value=!0)},close:y}),(e,t)=>{const l=k("n-input"),r=k("n-input-number"),f=k("n-select");return o(),d("div",{class:c(["editor-draw-board-setting",{show:n.value}])},[u("div",ya,[u("div",fa,[t[6]||(t[6]=g(" 画板设置 ")),u("div",wa,[u("div",{class:"editor-draw-board-setting-handle",onClick:t[0]||(t[0]=e=>y())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{class:"editor-draw-board-setting-handle",onClick:t[1]||(t[1]=e=>{h.value.points?(n.value=!1,m.value.setData(h.value,"edit"),p.value.setName(h.value.name)):a.error("请输入售卖点数后操作")})},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",ba,[t[7]||(t[7]=u("div",{class:"setting-item-label"},"模板名称",-1)),u("div",Da,[x(l,{class:"editor-setting-input",value:h.value.name,"onUpdate:value":t[2]||(t[2]=e=>h.value.name=e),disabled:"edit"!==s.editorType||!i},null,8,["value","disabled"])])]),u("div",ka,[t[10]||(t[10]=u("div",{class:"setting-item-label"},"宽度W",-1)),u("div",xa,[x(r,{class:"editor-setting-input",style:{width:"2rem"},disabled:"edit"!==s.editorType,value:h.value.realWidth,"onUpdate:value":t[3]||(t[3]=e=>h.value.realWidth=e),"show-button":!1},null,8,["disabled","value"]),t[8]||(t[8]=g("cm "))]),t[11]||(t[11]=u("div",{class:"setting-item-label"},"高度H",-1)),u("div",Ia,[x(r,{class:"editor-setting-input",style:{width:"2rem"},disabled:"edit"!==s.editorType,value:h.value.realHeight,"onUpdate:value":t[4]||(t[4]=e=>h.value.realHeight=e),"show-button":!1},null,8,["disabled","value"]),t[9]||(t[9]=g("cm "))])]),u("div",Ca,[t[12]||(t[12]=u("div",{class:"setting-item-label"},"绘制方式",-1)),u("div",_a,[x(f,{class:"editor-setting-input",value:h.value.drawType,"onUpdate:value":t[5]||(t[5]=e=>h.value.drawType=e),"label-field":"value","value-field":"value",options:Object.keys(v(_e)).map((e=>({key:e,value:v(_e)[e]}))),disabled:"edit"!==s.editorType},null,8,["value","options","disabled"])])])])],2)}}},[["__scopeId","data-v-823af50c"]]),Ma="none",Sa="transparent",Ea={Input:{border:Ma,borderDisabled:Ma,borderHover:Ma,borderFocus:Ma,color:Sa,colorDisabled:Sa,colorFocus:Sa,boxShadowFocus:Ma},InputNumber:{border:Ma,borderDisabled:Ma,borderFocus:Ma,borderHover:Ma}},La={class:"editor-layer-setting-box"},Aa={class:"editor-layer-setting-title"},Oa={class:"editor-layer-setting-handle-area"},za={class:"setting-value-box"},Ua={key:0,class:"setting-item"},Ra={class:"setting-item-value"},Ga={class:"setting-item",style:{"justify-content":"space-between"}},Na=["label","onClick","value"],Pa={key:1,class:"setting-item"},ja={class:"setting-item-value"},Fa={key:2,class:"setting-item"},Ha={class:"setting-item-value"},Ya={key:3,class:"setting-item"},Wa={class:"setting-item-value"},Xa={key:4,class:"setting-item"},Ba={class:"setting-item-value"},$a={key:5,class:"setting-item"},Ja={class:"setting-item-value"},Za={key:6,class:"setting-item"},Va={class:"setting-item-value"},Qa=xe({__name:"editorLayerSetting",props:{staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]}},emits:["save"],setup(e,{expose:t,emit:a}){const l=C(),s=r(Wt),i=e,n={statics:M(i,"staticsList"),prompts:M(i,"promptsList"),colors:M(i,"colorsList"),texts:M(i,"textsList")},h=r(!1),D=r(null),_=r(null),T=r(null),S=r(null),E=r("layer"),L=r(null),A=r(null),O=r(null),z=r(""),U=()=>{h.value=!1};return t({show:(e=null)=>{h.value?U():(h.value=!0,D.value=e?e.name:"",A.value=e?e.resource_name:null,_.value=e?e.uuid:null,S.value=e?e.image:null,L.value=e?e.type:"statics",T.value=S.value?S.value.src:null,O.value=e?e.tileType:null,z.value=e?e.prompt:null)},close:U}),(t,a)=>{const i=k("n-input"),r=k("n-select"),C=k("n-scrollbar"),M=k("n-config-provider");return o(),w(M,{"theme-overrides":v(Ea)},{default:I((()=>[u("div",{class:c(["editor-layer-setting",{show:h.value}]),style:b({height:"layer"===E.value?"9.3rem":"7rem"})},[u("div",La,[u("div",Aa,[g(m("layer"===E.value?"图层":"组")+"设置 ",1),u("div",Oa,[u("div",{class:"editor-layer-setting-handle",onClick:a[0]||(a[0]=e=>U())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{class:"editor-layer-setting-handle",onClick:a[1]||(a[1]=e=>(async()=>{if(D.value||"layer"!==E.value)if(L.value)if(A.value)if(h.value=!1,_.value){const e=s.value.findData("layer",_.value),{children:t}=e,a={resource_name:A.value,resource_id:n[L.value].value.find((e=>e.resource_name===A.value)).resource_id,type:L.value,name:D.value,tileType:O.value};if("prompts"===L.value&&(a.prompt=z.value),"texts"===L.value){const e=(await we(a.resource_id)).data,t=await Mt(e.font);a.fontSetting=e,a.fontSetting.fontFamily=t,a.fontSetting.content="默认文本"}e.setData(a),delete a.name,t.forEach(((l,i)=>{O.value&&i?e.children.splice(i,t.length-1):s.value.findData("element",l).setData(a)})),s.value.reDraw()}else{const e={resource_name:A.value,resource_id:n[L.value].value.find((e=>e.resource_name===A.value)).resource_id,type:L.value,name:D.value,tileType:O.value};if("prompts"===L.value&&(e.prompt=z.value),"texts"===L.value){const t=(await we(e.resource_id)).data,a=await Mt(t.font);e.fontSetting=t,e.fontSetting.fontFamily=a,e.fontSetting.content="默认文本"}const t=await s.value.add("layer",null,D.value,e);s.value.changeSelected([null,t,null]),s.value.reDraw()}else l.error("请选择模板后操作");else l.error("请选择图层类型后操作");else l.error("请输入图层名称后保存")})())},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",za,[x(C,null,{default:I((()=>["layer"===E.value?(o(),d("div",Ua,[a[9]||(a[9]=u("div",{class:"setting-item-label"},"图层名称",-1)),u("div",Ra,[x(i,{value:D.value,"onUpdate:value":a[2]||(a[2]=e=>D.value=e)},null,8,["value"])])])):p("",!0),u("div",Ga,[(o(!0),d(y,null,f(Object.keys(v(Ee)),(e=>(o(),d("div",{class:c(["setting-item-value",{selected:e===L.value}]),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"},key:e,label:v(Ee)[e],onClick:t=>{return a=e,void(_.value?l.error("图层类型不可改变"):(A.value=null,T.value=null,S.value=null,O.value=null,L.value=a,z.value=""));var a},value:e},[g(m(v(Ee)[e])+" ",1),a[10]||(a[10]=u("i",{class:"bi bi-bookmark-check",style:{"margin-left":"0.1rem"}},null,-1))],10,Na)))),128)),u("div",{class:"setting-item-selected",style:b({left:2.1*Object.keys(Ee).findIndex((e=>e===L.value))+"rem"})},null,4)]),"statics"===L.value?(o(),d("div",Pa,[a[11]||(a[11]=u("div",{class:"setting-item-label"},"模板选择",-1)),u("div",ja,[x(r,{class:"editor-setting-input",value:A.value,"onUpdate:value":a[3]||(a[3]=e=>A.value=e),"label-field":"resource_name","value-field":"resource_name",options:e.staticsList},null,8,["value","options"])])])):p("",!0),"prompts"===L.value?(o(),d("div",Fa,[a[12]||(a[12]=u("div",{class:"setting-item-label"},"模板选择",-1)),u("div",Ha,[x(r,{class:"editor-setting-input",value:A.value,"onUpdate:value":a[4]||(a[4]=e=>A.value=e),"label-field":"resource_name","value-field":"resource_name",options:e.promptsList},null,8,["value","options"])])])):p("",!0),"colors"===L.value?(o(),d("div",Ya,[a[13]||(a[13]=u("div",{class:"setting-item-label"},"模板选择",-1)),u("div",Wa,[x(r,{class:"editor-setting-input",value:A.value,"onUpdate:value":a[5]||(a[5]=e=>A.value=e),"label-field":"resource_name","value-field":"resource_name",options:e.colorsList},null,8,["value","options"])])])):p("",!0),"texts"===L.value?(o(),d("div",Xa,[a[14]||(a[14]=u("div",{class:"setting-item-label"},"模板选择",-1)),u("div",Ba,[x(r,{value:A.value,"onUpdate:value":a[6]||(a[6]=e=>A.value=e),class:"editor-setting-input","label-field":"resource_name","value-field":"resource_name",options:e.textsList},null,8,["value","options"])])])):p("",!0),"prompts"===L.value?(o(),d("div",$a,[a[15]||(a[15]=u("div",{class:"setting-item-label",style:{width:"1.55rem"}},"提示词",-1)),u("div",Ja,[x(i,{type:"textarea",style:{height:"2rem"},placeholder:"请输入提示词",value:z.value,"onUpdate:value":a[7]||(a[7]=e=>z.value=e)},null,8,["value"])])])):p("",!0),"statics"===L.value||"colors"===L.value?(o(),d("div",Za,[a[16]||(a[16]=u("div",{class:"setting-item-label"},"连续方式",-1)),u("div",Va,[x(r,{class:"editor-setting-input",value:O.value,"onUpdate:value":a[8]||(a[8]=e=>O.value=e),"label-field":"value","value-field":"key",options:Object.keys(v(Te)).map((e=>({key:v(Te)[e].value,value:v(Te)[e].name})))},null,8,["value","options"])])])):p("",!0)])),_:1})])])],6)])),_:1},8,["theme-overrides"])}}},[["__scopeId","data-v-5ce6ad63"]]);const qa=xe({},[["render",function(e,t){return o(),d("div")}]]),Ka={class:"image-like"},el={class:"slider-area"},tl={class:"slider-handle"},al={class:"image-area"},ll={class:"image-item"},sl=["src"],il={class:"image-item"},nl=["src"],rl=xe({__name:"imageLike",props:{imageUrl:{type:String,default:""},uuid:{type:Number,default:0},generateImageReviewUrl:{type:String,default:null}},emits:["setNewImageUrl"],setup(e,{emit:t}){C();const a=e,l=r(50),s=r(null),i=()=>{const{templateId:e,name:t}=Xt;Je.addTask(e,t,"element",[{imageUrl:a.imageUrl,similarity:l.value/100,uuid:a.uuid}],Be)};return(t,n)=>{const r=k("n-slider");return o(),d("div",Ka,[u("div",el,[n[1]||(n[1]=u("div",{class:"slider-name"},"相似度",-1)),u("div",tl,[x(r,{value:l.value,"onUpdate:value":n[0]||(n[0]=e=>l.value=e),min:0,max:100},null,8,["value"])]),u("div",{class:"slider-btn-area"},[u("div",{onClick:i},"生成")])]),u("div",al,[u("div",ll,[u("img",{src:a.imageUrl},null,8,sl)]),u("div",il,[u("img",{src:s.value||e.generateImageReviewUrl},null,8,nl)])])])}}},[["__scopeId","data-v-f28fede6"]]);const ol=xe({},[["render",function(e,t){return o(),d("div")}]]),dl={class:"image-generate-setting-handle-area"},ul={class:"change-setting-type-area"},cl=["onClick"],hl={class:"handle-btn-area"},ml={class:"image-generate-setting-component-area"},vl=xe({__name:"imageGenerate",emits:["replaceImage"],setup(e,{expose:t,emit:a}){const l=[{name:"相似生成",component:rl},{name:"融合图像",component:qa},{name:"文本控制",component:ol}],s=r(0),i=r(Wt),n=r(Yt),g=r(!1),D=r(null),k=r(null),x=r(null),I=r(null),C=r("element"),_=r(!1),T=()=>{_.value=!1,setTimeout((()=>{g.value=!1}),200)},M=e=>{x.value=e};return t({init:(e,t=null,a="element")=>{if(Tt(e.image)){const l=ce(e.image,`element_${e.uuid}`),s=new FormData;s.append("file",l),pe(`element_${e.uuid}`,s).then((l=>{D.value=l,k.value=e.uuid,C.value=a,I.value=t,x.value=null,g.value=!0,setTimeout((()=>{_.value=!0}))}))}else D.value=e.image,k.value=e.uuid,C.value=a,I.value=t,x.value=null,g.value=!0,setTimeout((()=>{_.value=!0}))}}),(e,t)=>g.value?(o(),d("div",{key:0,class:"image-generate-outer",onClick:t[3]||(t[3]=e=>T())},[u("div",{class:c(["image-generate show_start",{show_end:_.value}]),onClick:t[2]||(t[2]=h((()=>{}),["stop"]))},[u("div",dl,[u("div",ul,[u("div",{class:"component-selected",style:b({left:3.2*s.value+.05+"rem"})},null,4),(o(),d(y,null,f(l,((e,t)=>u("div",{class:"component-item",onClick:e=>s.value=t,key:e.name},m(e.name),9,cl))),64))]),u("div",hl,[u("div",{class:"handle-btn",onClick:t[0]||(t[0]=e=>T())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{class:"handle-btn",onClick:t[1]||(t[1]=e=>(async()=>{g.value=!1;const e=await ue(I.value);i.value.findData(C.value,k.value).setData({image:e}),n.value.reDraw()})())},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",ml,[g.value?(o(),w(S(l[s.value].component),{key:0,imageUrl:D.value,uuid:k.value,generateImageReviewUrl:I.value,onSetNewImageUrl:M,ref:"componentDom"},null,40,["imageUrl","uuid","generateImageReviewUrl"])):p("",!0)])],2)])):p("",!0)}},[["__scopeId","data-v-a46664c1"]]),pl={class:"editor-text-setting-title"},gl={class:"editor-text-setting-close-area"},yl={class:"editor-text-setting-inner"},fl={class:"editor-text-setting"},wl={class:"editor-text-setting-value"},bl={class:"editor-text-setting"},Dl={class:"editor-text-setting-value"},kl={class:"editor-text-setting"},xl={class:"editor-text-setting-value",style:{display:"flex"}},Il=xe({__name:"editorTextSetting",setup(e,{expose:t}){const a=r(!1),l=r(Wt),s=r(null),i=r({}),n=r(!1),m=()=>{n.value=!1,setTimeout((()=>{a.value=!1}),200)};return t({init:e=>{const{fontSetting:t}=e;s.value=e.uuid,a.value=!0;const l=JSON.parse(JSON.stringify(t));l.font_color=de(l.font_color),i.value=l,E((()=>{n.value=!0}))}}),(e,t)=>{const r=k("n-input"),y=k("n-color-picker"),f=k("n-input-number");return a.value?(o(),d("div",{key:0,class:"editor-text-setting-outer",onClick:t[6]||(t[6]=e=>m())},[u("div",{class:c(["editor-text-setting-box show_start",{show_end:n.value}]),onClick:t[5]||(t[5]=h((()=>{}),["stop"]))},[u("div",pl,[t[7]||(t[7]=u("div",{class:"editor-text-setting-content"},"编辑文本",-1)),u("div",gl,[u("div",{onClick:t[0]||(t[0]=e=>m())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{onClick:t[1]||(t[1]=e=>(()=>{const e=l.value.findData("element",s.value),t=JSON.parse(JSON.stringify(i.value));t.font_color=me(t.font_color);const a=Xt.getTextWidth(t);e.setData({x:e.x+e.width/2-a/2,width:a,height:t.font_size,fontSetting:t}),l.value.reDraw(),m()})())},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",yl,[u("div",fl,[t[8]||(t[8]=u("div",{class:"editor-text-setting-name"},"文本内容",-1)),u("div",wl,[x(r,{value:i.value.content,"onUpdate:value":t[2]||(t[2]=e=>i.value.content=e),style:{"--n-font-size":"0.5rem","--n-height":"0.9rem"},class:"editor-setting-input input"},null,8,["value"])])]),u("div",bl,[t[9]||(t[9]=u("div",{class:"editor-text-setting-name"},"文本颜色",-1)),u("div",Dl,[x(y,{style:{width:"100%"},"color-format":"rgba","show-alpha":"",value:i.value.font_color,"onUpdate:value":t[3]||(t[3]=e=>i.value.font_color=e)},null,8,["value"])])]),u("div",kl,[t[11]||(t[11]=u("div",{class:"editor-text-setting-name"},"文本字号",-1)),u("div",xl,[x(f,{min:12,value:i.value.font_size,"onUpdate:value":t[4]||(t[4]=e=>i.value.font_size=e),"show-button":!1,class:"editor-setting-input input"},null,8,["value"]),t[10]||(t[10]=g(" px "))])])])],2)])):p("",!0)}}},[["__scopeId","data-v-1017e005"]]),Cl={class:"editor-text-setting-title"},_l={class:"editor-text-setting-close-area"},Tl={class:"editor-text-setting-inner"},Ml={class:"editor-text-setting"},Sl={class:"editor-text-setting-value"},El=xe({__name:"editorColorSetting",setup(e,{expose:t}){const a=r(!1),l=r(Wt),s=r(null),i=r({}),n=r(!1),m=()=>{n.value=!1,setTimeout((()=>{a.value=!1}),200)};return t({init:e=>{const{color:t}=e;s.value=e.uuid,a.value=!0;const l={color:de(t)};i.value=l,E((()=>{n.value=!0}))}}),(e,t)=>{const r=k("n-color-picker");return a.value?(o(),d("div",{key:0,class:"editor-text-setting-outer",onClick:t[4]||(t[4]=e=>m())},[u("div",{class:c(["editor-text-setting-box show_start",{show_end:n.value}]),onClick:t[3]||(t[3]=h((()=>{}),["stop"]))},[u("div",Cl,[t[5]||(t[5]=u("div",{class:"editor-text-setting-content"}," 编辑颜色 ",-1)),u("div",_l,[u("div",{onClick:t[0]||(t[0]=e=>m())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{onClick:t[1]||(t[1]=e=>(()=>{const e=l.value.findData("element",s.value),t=JSON.parse(JSON.stringify(i.value));t.color=me(t.color),e.setData(t),l.value.reDraw(),m()})())},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",Tl,[u("div",Ml,[t[6]||(t[6]=u("div",{class:"editor-text-setting-name"}," 纯色层颜色 ",-1)),u("div",Sl,[x(r,{style:{width:"100%"},"color-format":"rgba","show-alpha":"",value:i.value.color,"onUpdate:value":t[2]||(t[2]=e=>i.value.color=e)},null,8,["value"])])])])],2)])):p("",!0)}}},[["__scopeId","data-v-14fb2a44"]]),Ll={class:"editor-layer-setting-box"},Al={class:"editor-layer-setting-title"},Ol={class:"editor-layer-setting-handle-area"},zl={class:"setting-value-box"},Ul={class:"setting-item",style:{"justify-content":"space-between"}},Rl={class:"setting-item",style:{border:"none",margin:"0"}},Gl={class:"setting-item-value"},Nl={class:"setting-item-value"},Pl={class:"setting-item",style:{border:"none",margin:"0"}},jl={class:"setting-item-value"},Fl={class:"setting-item-value"},Hl={class:"setting-item"},Yl={class:"setting-item-value",style:{padding:"0 0.4rem"}},Wl={class:"setting-item"},Xl={class:"setting-item-value"},Bl={class:"setting-item-value"},$l={class:"setting-item"},Jl={class:"setting-item-value",style:{padding:"0 0.4rem"}},Zl=xe({__name:"editorElementSetting",emits:["save"],setup(e,{expose:t,emit:a}){C();const l=r(Wt),s=r(!1),i=r(null);r([]);const n=r(null),h=r(0),m=r(0),p=r(0),y=r(0),f=r(100),w=r(0),b=r(!1),D=r(!1),_=r(new Ke),T=r(null),M=r(null),S=r(null),E=r(null),A=r(null),O=r(0),z=r(null);let U=null;L(M,(async e=>{s.value&&(await R(),F())})),L(O,(async()=>{s.value&&(await R(),F())}));const R=async()=>{let e=null;M.value&&(e=await A.value.grayToColor(me(M.value))),O.value&&(e=await A.value.edgeFeather(O.value/1e3)),E.value=e,F()},G=(e="right")=>{"right"===e?w.value+=Math.PI/2:w.value-=Math.PI/2,F()},N=(e="x")=>{"x"===e?b.value=!b.value:D.value=!D.value,F()},P=()=>{const e={name:U.name,uuid:U.uuid,x:U.x,y:U.y,width:U.width,height:U.height,opacity:U.opacity,rotate:U.rotate,xOverturn:U.xOverturn,yOverturn:U.yOverturn,hue:U.hue,handleImage:U.handleImage,edgeFeather:U.edgeFeather};l.value.findData("element",n.value).setData(e),l.value.reDraw(),U=null},j=()=>{s.value&&(A.value=null,P(),n.value=null,s.value=!1)},F=()=>{const e={name:i.value,uuid:n.value,x:h.value,y:m.value,width:p.value,height:y.value,opacity:f.value/100,rotate:w.value,xOverturn:b.value,yOverturn:D.value,hue:M.value?me(M.value):null,handleImage:E.value,edgeFeather:O.value};l.value.findData("element",n.value).setData(e),l.value.reDraw()};return t({show:(e=null)=>{const t=l.value.findData("element",e);n.value&&n.value!==e&&P(),U||(U=JSON.parse(JSON.stringify(t)),U.image=t.image,U.handleImage=t.handleImage),s.value=!0,i.value=t?t.name:"",z.value=t.hue?ve(t.hue):null,n.value=t?t.uuid:null,h.value=Math.round(t.x)||0,m.value=Math.round(t.y)||0,p.value=Math.round(t.width)||0,y.value=Math.round(t.height)||0,f.value=100*t.opacity||100,w.value=t.rotate||0,b.value=t.xOverturn||!1,D.value=t.yOverturn||!1,O.value=t.edgeFeather||0,M.value=t.hue?ve(t.hue):null,S.value=t.image,E.value=t.handleImage,A.value=new Gt(n.value,t.image)},close:j}),(e,t)=>{const a=k("n-input-number"),l=k("n-slider"),i=k("n-color-picker"),r=k("n-scrollbar");return o(),d("div",{class:c(["editor-layer-setting",{show:s.value}])},[u("div",Ll,[u("div",Al,[t[23]||(t[23]=g(" 参数调节 ")),u("div",Ol,[u("div",{class:"editor-layer-setting-handle",onClick:t[0]||(t[0]=e=>j())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{class:"editor-layer-setting-handle",onClick:t[1]||(t[1]=e=>(F(),s.value=!1,n.value=null,void(U=null)))},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",zl,[x(r,null,{default:I((()=>[u("div",Ul,[u("div",{class:"setting-item-value handle-btn",onClick:t[2]||(t[2]=e=>G("left")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[24]||(t[24]=[g(" 左转 "),u("i",{class:"bi bi-arrow-90deg-left",style:{"margin-left":"0.1rem"}},null,-1)])),u("div",{class:"setting-item-value handle-btn",onClick:t[3]||(t[3]=e=>G("right")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[25]||(t[25]=[g(" 右转 "),u("i",{class:"bi bi-arrow-90deg-right",style:{"margin-left":"0.1rem"}},null,-1)])),u("div",{class:"setting-item-value handle-btn",onClick:t[4]||(t[4]=e=>N("x")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[26]||(t[26]=[g(" 水平翻转 "),u("i",{class:"bi bi-arrows-expand-vertical",style:{"margin-left":"0.1rem"}},null,-1)])),u("div",{class:"setting-item-value handle-btn",onClick:t[5]||(t[5]=e=>N("y")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[27]||(t[27]=[g(" 垂直翻转 "),u("i",{class:"bi bi-arrows-expand",style:{"margin-left":"0.1rem"}},null,-1)]))]),u("div",Rl,[u("div",{class:c(["setting-item-min",{handing:"x"===T.value,handingLock:T.value}]),onMousedown:t[8]||(t[8]=e=>(e=>{let t=e.pageX;_.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX?h.value--:t<e.pageX&&h.value++,t=e.pageX,F()})),T.value="x",_.value.addListener(document.documentElement,"mouseup",(e=>{_.value.removeAllListeners(),T.value=null}))})(e))},[t[28]||(t[28]=u("div",{class:"setting-item-label"},"位置X",-1)),u("div",Gl,[x(a,{style:{width:"2rem"},value:h.value,"onUpdate:value":[t[6]||(t[6]=e=>h.value=e),t[7]||(t[7]=e=>F())],"show-button":!1,class:"editor-setting-input",precision:0,step:1},null,8,["value"])])],34),u("div",{class:c(["setting-item-min",{handing:"y"===T.value,handingLock:T.value}]),onMousedown:t[11]||(t[11]=e=>(e=>{let t=e.pageX;_.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX?m.value--:t<e.pageX&&m.value++,t=e.pageX,F()})),T.value="y",_.value.addListener(document.documentElement,"mouseup",(e=>{_.value.removeAllListeners(),T.value=null}))})(e))},[t[29]||(t[29]=u("div",{class:"setting-item-label"},"位置Y",-1)),u("div",Nl,[x(a,{style:{width:"2rem"},value:m.value,"onUpdate:value":[t[9]||(t[9]=e=>m.value=e),t[10]||(t[10]=e=>F())],precision:0,step:1,"show-button":!1,class:"editor-setting-input"},null,8,["value"])])],34)]),u("div",Pl,[u("div",{class:c(["setting-item-min",{handing:"width"===T.value,handingLock:T.value}]),onMousedown:t[14]||(t[14]=e=>(e=>{let t=e.pageX;_.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX&&p.value>1?p.value--:t<e.pageX&&p.value>1&&p.value++,t=e.pageX,F()})),T.value="width",_.value.addListener(document.documentElement,"mouseup",(e=>{_.value.removeAllListeners(),T.value=null}))})(e))},[t[30]||(t[30]=u("div",{class:"setting-item-label"},"宽度W",-1)),u("div",jl,[x(a,{style:{width:"2rem"},value:p.value,"onUpdate:value":[t[12]||(t[12]=e=>p.value=e),t[13]||(t[13]=e=>F())],precision:0,step:1,"show-button":!1,class:"editor-setting-input"},null,8,["value"])])],34),u("div",{class:c(["setting-item-min",{handing:"height"===T.value,handingLock:T.value}]),onMousedown:t[17]||(t[17]=e=>(e=>{let t=e.pageX;_.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX&&y.value>1?y.value--:t<e.pageX&&y.value>1&&y.value++,t=e.pageX,F()})),T.value="height",_.value.addListener(document.documentElement,"mouseup",(e=>{_.value.removeAllListeners(),T.value=null}))})(e))},[t[31]||(t[31]=u("div",{class:"setting-item-label"},"高度H",-1)),u("div",Fl,[x(a,{style:{width:"2rem"},value:y.value,"onUpdate:value":[t[15]||(t[15]=e=>y.value=e),t[16]||(t[16]=e=>F())],precision:0,step:1,"show-button":!1,class:"editor-setting-input"},null,8,["value"])])],34)]),u("div",Hl,[t[32]||(t[32]=u("div",{class:"setting-item-label"},"透明度",-1)),u("div",Yl,[x(l,{"onUpdate:value":[t[18]||(t[18]=e=>F()),t[19]||(t[19]=e=>f.value=e)],style:{"--el-slider-button-size":"0.5rem","--el-slider-button-wrapper-size":"0.8rem",height:"0.8rem","--el-slider-button-wrapper-offset":"-0.3rem"},max:100,min:0,value:f.value},null,8,["value"])])]),t[35]||(t[35]=u("div",{class:"setting-item",style:{border:"none",margin:"0"}},[u("div",{class:"editor-layer-setting-title"},"高级参数")],-1)),u("div",Wl,[u("div",Xl,[t[33]||(t[33]=u("div",{class:"setting-item-label",style:{width:"1.5rem"}},"单色相",-1)),u("div",Bl,[x(i,{style:{flex:"1","margin-top":"-0.25rem"},"color-format":"rgb",value:M.value,"onUpdate:value":t[20]||(t[20]=e=>M.value=e),actions:["clear"]},null,8,["value"])])])]),u("div",$l,[t[34]||(t[34]=u("div",{class:"setting-item-label",style:{width:"1.5rem"}},"边缘羽化",-1)),u("div",Jl,[x(l,{onInput:t[21]||(t[21]=e=>R()),style:{"--el-slider-button-size":"0.5rem","--el-slider-button-wrapper-size":"0.8rem",height:"0.8rem","--el-slider-button-wrapper-offset":"-0.3rem"},max:100,min:0,value:O.value,"onUpdate:value":t[22]||(t[22]=e=>O.value=e)},null,8,["value"])])])])),_:1})])])],2)}}},[["__scopeId","data-v-04bef7d1"]]),Vl={class:"editor-layer-setting-box"},Ql={class:"editor-layer-setting-title"},ql={class:"editor-layer-setting-handle-area"},Kl={class:"setting-value-box"},es={class:"setting-item"},ts={class:"setting-item-value"},as={class:"setting-item-value"},ls={class:"setting-item"},ss={class:"setting-item-value",style:{padding:"0 0.4rem"}},is=xe({__name:"editorAdvancedSetting",emits:["save"],setup(e,{expose:t,emit:a}){C(),r(Wt);const l=r(!1);r(null),r(null),r(100),r(new Ke),r(null);const s=r(null);r(null),r(null);const i=r(0),n=r(null);let h=null,m={};L(s,(()=>{y()})),L(i,(()=>{y()}));const p=()=>{l.value&&(w(),l.value=!1)},y=async(e=!1)=>{const t=Object.keys(m);for(let a=0;a<t.length;a++){const l=t[a],n=m[l],r=n.colorHandle;let o=null;s.value&&(o=await r.grayToColor(me(s.value))),i.value&&(o=await r.edgeFeather(i.value/100));const d=Wt.findData("element",l);e&&delete n.colorHandle,d.setData({handleImage:o,hue:s.value?me(s.value):null,edgeFeather:i.value})}Xt.edgeFeather=i.value,Xt.hue=s.value?me(s.value):null,Xt.reDraw()};L(s,(async e=>{l.value&&y()}));const f=e=>{s.value=e},w=()=>{const e=Object.keys(m);for(let t=0;t<e.length;t++){const a=e[t],l=m[a];delete l.colorHandle;const{image:s,handleImage:i,hue:n,edgeFeather:r}=l;Wt.findData("element",a).setData({image:s,handleImage:i,hue:n,edgeFeather:r})}Xt.edgeFeather=h.edgeFeather,Xt.hue=h.hue,Xt.reDraw()};return t({show:()=>{l.value=!0,h=Xt.getData(),s.value=h.hue?ve(h.hue):null,n.value=s.value,i.value=h.edgeFeather,Object.keys(Wt.elements).forEach((e=>{const t=Wt.findData("element",e);"texts"!==t.type&&(m[e]={image:t.image,hue:t.hue,handleImage:t.handleImage,edgeFeather:t.edgeFeather,colorHandle:new Gt(e,t.image,Boolean(t.edgeFeather))})}))},close:p}),(e,t)=>{const a=k("n-color-picker"),n=k("n-slider"),r=k("n-scrollbar");return o(),d("div",{class:c(["editor-layer-setting",{show:l.value}])},[u("div",Vl,[u("div",Ql,[t[5]||(t[5]=g(" 参数调节 ")),u("div",ql,[u("div",{class:"editor-layer-setting-handle",onClick:t[0]||(t[0]=e=>p())},[u("i",{class:c(`bi ${v(ee)}`)},null,2)]),u("div",{class:"editor-layer-setting-handle",onClick:t[1]||(t[1]=e=>(y(!0),void(l.value=!1)))},[u("i",{class:c(`bi ${v(te)}`)},null,2)])])]),u("div",Kl,[x(r,null,{default:I((()=>[u("div",es,[u("div",ts,[t[6]||(t[6]=u("div",{class:"setting-item-label",style:{width:"1.5rem"}},"单色相",-1)),u("div",as,[x(a,{style:{flex:"1","margin-top":"-0.25rem"},onActiveChange:f,actions:["clear"],"color-format":"rgb",value:s.value,"onUpdate:value":t[2]||(t[2]=e=>s.value=e)},null,8,["value"])])])]),u("div",ls,[t[7]||(t[7]=u("div",{class:"setting-item-label",style:{width:"1.5rem"}},"边缘羽化",-1)),u("div",ss,[x(n,{onInput:t[3]||(t[3]=e=>y()),max:100,min:0,value:i.value,"onUpdate:value":t[4]||(t[4]=e=>i.value=e)},null,8,["value"])])])])),_:1})])])],2)}}},[["__scopeId","data-v-005f8fbd"]]),ns=["onClick"],rs={key:0,class:"explosion-line-1"},os={class:"explosion-prompt-item"},ds={class:"explosion-item-name"},us={class:"explosion-prompt-edit-btn"},cs={key:0,class:"explosion-prompt-info"},hs={key:1,class:"explosion-prompt-info"},ms={class:"explosion-diagram-item"},vs={key:0,class:"explosion-name"},ps=["onClick"],gs={class:"explosion-image"},ys=["src"],fs=xe({__name:"explosionDiagram",props:{data:{type:Array,default:()=>[]},widthPrompt:{type:Boolean,default:()=>!1},explosionStyle:{type:Object,default:()=>({width:"5rem",height:"7rem"})}},setup(e,{expose:t}){const a=C(),l=e,s=r(null),i=r(null),n=r(null),v=r(null),w=r(null),_=r(""),T={COMMENCE:"commence",INCORPORATION:"incorporation"},M=r(T.INCORPORATION),S=e=>{T.hasOwnProperty(e)||"CHANGE"===e?(i.value=null,"CHANGE"===e?M.value===T.COMMENCE?M.value=T.INCORPORATION:M.value=T.COMMENCE:M.value=T[e]):a.error("非法参数")},E=e=>M.value===T.COMMENCE?Object.assign({left:2*e-l.data.length+0+"rem",top:-.5*e+.5+"rem",zIndex:l.data.length-e-1},l.explosionStyle):Object.assign({left:"0rem",top:"0rem",transform:"skewY(0deg)",zIndex:l.data.length-e-1,backgroundColor:e===l.data.length-1?"var(--op-for-bg-color)":"transparent"},l.explosionStyle),L=e=>n.value===e?{hiding:!0}:v.value===e?{showing:!0}:s.value===e?{show:!0}:s.value!==e?{hide:!0}:void 0;return D((()=>{l.data.length&&(s.value=0),setTimeout((()=>{S("COMMENCE")}))})),t({changeExplosionType:S}),(t,a)=>{const r=k("el-icon"),D=k("t-button");return o(),d("div",{class:"explosion-diagram-body",style:b({paddingTop:(M.value,T.COMMENCE,0)+"rem"})},[u("div",{class:"explosion-all",style:b(l.explosionStyle)},[(o(!0),d(y,null,f(l.data,((t,f)=>(o(),d(y,null,[i.value===f||M.value===T.COMMENCE||!i.value&&0!==i.value&&M.value===T.INCORPORATION?(o(),d("div",{class:c(["explosion-item",{selected:M.value===T.COMMENCE&&s.value===f}]),key:t.uuid,onClick:e=>(e=>new Promise((t=>{M.value===T.COMMENCE&&s.value!==e?(w.value=null,null!==s.value&&(n.value=s.value),v.value=e,setTimeout((()=>{s.value=v.value,v.value=null})),setTimeout((()=>{n.value=null,t()}),200)):t()})))(f),style:b(E(f))},[M.value===T.COMMENCE||null!==i.value?(o(),d("div",{key:0,class:c(["explosion-diagram-handle-area",Object.assign(L(f),{nomal:null!==i.value})])},[e.widthPrompt?(o(),d("div",rs)):p("",!0),e.widthPrompt?(o(),d("div",{key:1,class:"explosion-line-2",style:b({width:1.5*(M.value===T.COMMENCE||null===i.value?l.data.length-f:1)+"rem"})},null,4)):p("",!0),e.widthPrompt?(o(),d("div",{key:2,class:"explosion-prompt-area",style:b({left:1.5*(M.value===T.COMMENCE||null===i.value?l.data.length-f:1)+1+"rem"})},[u("div",os,[u("div",ds,[g(m(t.name)+" ",1),u("div",us,[x(r,{class:"explosion-prompt-edit-item",onClick:h((e=>(e=>{_.value=l.data[e].prompt,w.value=e})(f)),["stop"])},null,8,["onClick"])])]),w.value!==f?(o(),d("div",cs,m(t.prompt),1)):p("",!0),w.value===f?(o(),d("div",hs,[A(u("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>_.value=e)},null,512),[[O,_.value]])])):p("",!0),u("div",{class:"explosion-prompt-save-handle-area",style:b({height:w.value===f?"0.8rem":"0rem"})},[x(D,{type:"info",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"},onClick:a[1]||(a[1]=e=>w.value=null)},{default:I((()=>a[2]||(a[2]=[g("取消")]))),_:1}),x(D,{type:"success",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"}},{default:I((()=>a[3]||(a[3]=[g("生成")]))),_:1})],4)])],4)):p("",!0)],2)):p("",!0),u("div",ms,[M.value===T.COMMENCE?(o(),d("div",vs,m(t.name),1)):p("",!0),null!==i.value||M.value===T.COMMENCE?(o(),d("div",{key:1,class:"show-explosion-item-handle-btn",onClick:h((e=>(e=>{null===i.value&&M.value===T.COMMENCE?(S("INCORPORATION"),i.value=e):null!==i.value&&(S("COMMENCE"),i.value=null),s.value=e})(f)),["stop"]),style:b({top:(M.value===T.COMMENCE?"1.2":"0.2")+"rem"})},m(null!==i.value?"隐藏":"展示"),13,ps)):p("",!0),u("div",gs,[u("img",{src:t.image},null,8,ys)])])],14,ns)):p("",!0)],64)))),256))],4)],4)}}},[["__scopeId","data-v-7f8b8087"]]),ws={class:"ratio-setting-area"},bs={class:"handle-type-setting-area"},Ds=xe({__name:"editorPublicSetting",setup(e){r(10);const t=M(Xt,"zoomRatio"),a=M(Xt,"handleState"),l=r(Xt),s=r(!1),i=e=>{a.value!==e&&(l.value.handleState=e)};return L(t,(()=>{l.value.zoomRatio=t.value,l.value.reDraw()})),D((()=>{s.value=!0})),(e,l)=>{const n=k("n-slider");return o(),d("div",{class:c(["public-setting-body",{inView:s.value}])},[u("div",ws,[l[3]||(l[3]=u("label",null," 0% ",-1)),x(n,{class:"ratio-setting-slider",value:t.value,"onUpdate:value":l[0]||(l[0]=e=>t.value=e),step:1e-4,"format-tooltip":e=>Math.round(1e4*e)/100+"%",min:.01,max:4},null,8,["value","format-tooltip"]),l[4]||(l[4]=u("label",null," 400% ",-1))]),u("div",bs,[u("div",{class:c(["handle-type-item",{selected:"操作"===a.value}])},[u("div",{class:"handle-type-item-info",onClick:l[1]||(l[1]=e=>i("操作"))},l[5]||(l[5]=[u("i",{class:"bi bi-cursor"},null,-1)]))],2),u("div",{class:c(["handle-type-item",{selected:"绘制"===a.value}])},[u("div",{class:"handle-type-item-info",onClick:l[2]||(l[2]=e=>i("绘制"))},l[6]||(l[6]=[u("i",{class:"bi bi-vector-pen"},null,-1)]))],2)])],2)}}},[["__scopeId","data-v-05bf299c"]]),ks=xe({__name:"editorOpInput",setup(e,{expose:t}){const a=r(!1),l=r(!1);return D((()=>{a.value=!0,window.handle=Ue})),t({hideInput:()=>{l.value=!1}}),(e,t)=>(o(),d("div",{class:c(["editor-op-input-body",{inView:a.value,openState:l.value}]),onClick:t[0]||(t[0]=h((e=>l.value=!0),["stop"]))},[x(ge)],2))}},[["__scopeId","data-v-0ecb26f3"]]),xs={key:0,class:"model-draw-area"},Is=xe({__name:"modelDrawBoard",props:{setting:{},staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]},templateId:{type:Number,default:null},needOpInput:{type:Boolean,default:!0},info:{type:Object,default:()=>({template_filter:"normal",template_level:"normal",points:1})},layerData:{},editorType:{}},emits:["setTypeList","setGroupList","setSelectedElement","layerData"],setup(e,{expose:t,emit:a}){C();const l=e,s=a,i=r(null),n=r(null),m=r(null),g=r(null),y=r(null),f=r(null),b=r(null),k=r(null),I=r(null),_=r(null),T=r(null),M=r(!1);r("editor");const S=r([]),E=r({width:0,height:0}),L=r(null),O=r(Xt),U=r(Wt),R=r(Yt);r(Object.assign({name:l.setting.name},l.setting.canvasData));const G=r(null),N=()=>{q(),_.value.show()},P=async()=>{O.value.viewType===Me?(O.value.setViewType(Se),await j()):(g.value.changeExplosionType("INCORPORATION"),O.value.setViewType(Me),await j()),E.value={width:O.value.realWidth*O.value.zoomRatio*.8+"px",height:O.value.realHeight*O.value.zoomRatio*.8+"px"}},j=async()=>{S.value=await R.value.getLayerImage()},F=e=>{G.value=L.value.changeHandleType(e)},H=()=>{q(),n.value.show()},Y=()=>{L.value.exportImage()},W=(e,t)=>{switch(t){case"text":b.value.init(e);break;case"color":k.value.init(e)}},X=async()=>{const e=["groups","layers","elements"];for(let t of e)for(let e in l.layerData[t]){const a=l.layerData[t][e];if(a.image){const l=await re(a.image);if(a.image=l,"elements"===t){let t=null,l=new Gt(e,a.image,Boolean(a.edgeFeather));a.hue&&Array.isArray(a.hue)&&(t=await l.grayToColor(a.hue)),a.edgeFeather&&(t=await l.edgeFeather(a.edgeFeather/100)),l=null,a.handleImage=t}}if("texts"===a.type&&a.fontSetting&&a.fontSetting.font){const e=await Mt(a.fontSetting.font);a.fontSetting.fontFamily=e}if("elements"!==t||"statics"!==a.type&&"colors"!==a.type)await U.value.add(t.slice(0,-1),a.parentUuid,a.name,a,e,a.zIndex);else{const l=await U.value.add(t.slice(0,-1),a.parentUuid,a.name,{},e,a.zIndex,1);U.value.findData("element",l).setData(a,1)}U.value.reDraw()}},B=(e=null)=>{e=e||L.value.setTypeList();const t=Object.keys(e).map((t=>({uuid:t,name:e[t].name,image:e[t].image,loraInfo:e[t].loraInfo,layerInfo:e[t].layerInfo})));s("setTypeList",t)},$=e=>{s("setGroupList",e)},J=(...e)=>{y.value.init(...e)},Z=(e,t,a)=>{const l=ke();re(e).then((e=>{L.value.elementsList[t].setImage(e),L.value.reDraw(),l.close()}))},V=e=>{const{uuid:t}=e;delete e.uuid,t||L.value.addType({name:e.name,prompts:e.prompts,statics:e.statics,image:e.image}).then((e=>{B(e)}))},Q=()=>{U.value.clearAllData(),R.value.toTextEditView=W,R.value.toImageGenerateView=J,R.value.toElementSetting=K,R.value.generationController.setName(l.setting.name),O.value.init(i.value,l.setting,l.editorType,l.templateId,l.info).then((()=>{X().then((()=>{R.value.reDraw(),Je.setTaskResult()}))}))},q=()=>{m.value.close(),I.value.close(),n.value.close(),_.value.close()},K=(...e)=>{q(),I.value.show(...e)},ee=()=>{T.value.hideInput()};return D((()=>{Q(),M.value=!0})),t({toSettingLayer:(...e)=>{q(),m.value.show(...e)},setSelectedLayer:(...e)=>{L.value.setTypeUuid(...e)},deleteGroup:e=>{L.value.deleteGroup(e)},deleteLayer:e=>{L.value.deleteType(e).then((({typeList:e,groups:t})=>{$(t),B(e)}))},deleteElement:e=>{L.value.deleteElement(e),B(typeList)},setGroup:e=>{const{layerUuids:t,groupUuid:a}=e;if(a){if(1===t.length&&a){const e=L.value.getGroupItem(a).layers.concat(t),l=L.value.updateGroup(a,{layers:[...new Set(e)]});$(l)}}else f.value.show(null,"group",e)},hideLayer:e=>{L.value.setHideLayer(e),new Promise((e=>{L.value.getAllLayerImage().then((t=>{S.value=Object.keys(t).map((e=>Object.assign({uuid:e,imageSrc:t[e].imageBase64},t[e]))).reverse(),e()}))}))},setDiagramImage:j}),(t,a)=>(o(),d("div",{class:"model-draw-board",onClick:ee},[A(u("div",{class:"model-draw-area",ref_key:"modelEditorDom",ref:i,tabindex:"0",onWheel:a[0]||(a[0]=h((()=>{}),["stop"]))},null,544),[[z,"editor"===v(Xt).viewType]]),"explosion"===v(Xt).viewType?(o(),d("div",xs,[x(fs,{explosionStyle:E.value,data:S.value,ref_key:"explosionDiagramDom",ref:g},null,8,["explosionStyle","data"])])):p("",!0),u("div",{class:c(["model-handle-area",{inView:M.value}])},[x(ga,{handleType:G.value,onToCanvasSetting:H,onChangeHandleType:F,onExportImage:Y,onChangeViewType:P,onToAdvancedSettingDom:N,editorType:l.editorType},null,8,["handleType","editorType"])],2),x(Ds),x(Ta,{ref_key:"editorDrawBoardSettingDom",ref:n,editorType:l.editorType},null,8,["editorType"]),x(Qa,{ref_key:"editorLayerSettingDom",ref:m,staticsList:l.staticsList,promptsList:l.promptsList,colorsList:l.colorsList,textsList:l.textsList,onSave:V},null,8,["staticsList","promptsList","colorsList","textsList"]),x(vl,{onReplaceImage:Z,ref_key:"imageGenerateDom",ref:y},null,512),x(Il,{ref_key:"editorTextSettingDom",ref:b},null,512),x(El,{ref_key:"editorColorSettingDom",ref:k},null,512),x(Zl,{ref_key:"editorElementSettingDom",ref:I},null,512),x(is,{ref_key:"editorAdvancedSettingDom",ref:_},null,512),e.needOpInput?(o(),w(ks,{key:1,ref_key:"editorOpInputRef",ref:T},null,512)):p("",!0)]))}},[["__scopeId","data-v-e7b1c21b"]]),Cs={class:"tab-hide-view"},_s={class:"tab-hide-view-main"},Ts={class:"tab-hide-view-other"},Ms=xe({__name:"navbarTab",props:{name:{type:String,default:"default"},height:{type:String,default:"4rem"},icon:{type:String,default:""},num:{type:Number,default:0}},setup(e){const t=e,a=r(!1),l=r(!1);return D((()=>{l.value=!0})),(s,i)=>{const n=k("n-badge");return o(),d("div",{class:c(["tab-outer",{inView:l.value,show:a.value}]),onMouseleave:i[1]||(i[1]=e=>{a.value=!1}),onClick:i[2]||(i[2]=e=>{a.value=!a.value}),style:b(a.value?{height:t.height}:{height:"1.25rem"})},[u("div",Cs,[u("div",_s,[x(n,{value:e.num,class:"item","show-zero":!1},{default:I((()=>[u("i",{class:c(["bi",`bi-${e.icon}`])},null,2)])),_:1},8,["value"]),g(" "+m(e.name),1)]),u("div",Ts,[U(s.$slots,"other",{},void 0,!0)])]),u("div",{class:"tab-show-view",onClick:i[0]||(i[0]=h((()=>{}),["stop"])),style:b(a.value?{height:Number(t.height.replaceAll("rem",""))-1.5+"rem"}:{height:"0rem"})},[U(s.$slots,"default",{},void 0,!0)],4)],38)}}},[["__scopeId","data-v-06343830"]]),Ss={class:"task-item"},Es={class:"task-item-main"},Ls={class:"task-data"},As={class:"task-name-area"},Os={class:"task-name"},zs={class:"task-progress-name"},Us={class:"task-handle-area"},Rs={key:1,class:"handle-btn"},Gs={key:2,class:"handle-btn"},Ns={key:3,class:"handle-btn"},Ps={key:4,class:"handle-btn line"},js={key:5,class:"handle-btn"},Fs={class:"task-item-progress-bar"},Hs=xe({__name:"taskItem",props:{progress:{type:Number,default:0},name:{type:String,default:""},subName:{type:String,default:""},template_name:{},template_id:{},fromPath:{}},setup(e){const t=T(),a=e;return D((()=>{})),(l,s)=>(o(),d("div",Ss,[u("div",Es,[u("div",Ls,[s[1]||(s[1]=u("div",{class:"task-icon"},[u("i",{class:"bi bi-badge-hd-fill"})],-1)),u("div",As,[u("div",Os,m(e.name),1),u("div",zs,m(e.subName),1)])]),u("div",Us,[100===e.progress?(o(),d("div",{key:0,class:"handle-btn",onClick:s[0]||(s[0]=e=>{t.push({path:a.fromPath,query:{file_name:a.template_name,template_id:a.template_id}})})},s[2]||(s[2]=[u("i",{class:"bi bi-eye-fill"},null,-1)]))):p("",!0),100!==e.progress?(o(),d("div",Rs,s[3]||(s[3]=[u("i",{class:"bi bi-caret-right-fill"},null,-1)]))):p("",!0),100!==e.progress?(o(),d("div",Gs,s[4]||(s[4]=[u("i",{class:"bi bi-pause-fill"},null,-1)]))):p("",!0),100!==e.progress?(o(),d("div",Ns,s[5]||(s[5]=[u("i",{class:"bi bi-square-fill"},null,-1)]))):p("",!0),100!==e.progress?(o(),d("div",Ps)):p("",!0),100!==e.progress?(o(),d("div",js,s[6]||(s[6]=[u("i",{class:"bi bi-gear-fill"},null,-1)]))):p("",!0)])]),u("div",{class:c(["task-item-progress-bar-box",{succsss:100===e.progress}])},[u("div",{class:"task-item-progress-bar-num",style:b(`left:calc(${e.progress}% - ${.4*(a.progress<10?0:a.progress>=10&&a.progress<=95?1:a.progress>95?4.5:void 0)}rem)`)},m(100!==e.progress?e.progress+"%":"生成完成"),5),u("div",Fs,[u("div",{class:"task-item-progress-bar-info",style:b(`width:${e.progress}%`)},null,4)])],2)]))}},[["__scopeId","data-v-3a89d4df"]]),Ys={class:"task-box"},Ws={class:"task-list"},Xs={class:"data-statistics"},Bs={class:"data-statistics"},$s=xe({__name:"index",setup(e){const t=r(null),a=r(null),l=r(Je);return D((()=>{E((()=>{a.value=R(t.value),a.value.setOption({title:{text:""},tooltip:{},xAxis:{type:"category",silent:!1,splitLine:{show:!1},axisLine:{show:!1},axisTick:{show:!1},axisLabel:{show:!1},data:["a","b","c","d","e","f","a","b","c","d","e","f"]},yAxis:{splitLine:{show:!1},splitArea:{show:!1},axisLabel:{color:"#000000",fontSize:10,fontStyle:"normal"}},series:[{name:"积分",type:"bar",data:[{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#A5A5A5"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#FF8686"}},{value:Math.round(100*Math.random()),itemStyle:{color:"#000000"}}],barWidth:"100%",barGap:"0%",barCategoryGap:"0%"}],grid:{left:"3%",top:"10%",bottom:"10%",containLabel:!0}})}))})),(e,a)=>{const s=k("n-scrollbar"),i=k("n-descriptions-item"),n=k("n-descriptions");return o(),d("div",Ys,[u("div",Ws,[x(s,null,{default:I((()=>[(o(!0),d(y,null,f(l.value.taskList,(e=>(o(),w(Hs,{key:e.uuid,progress:e.progress,name:e.name,template_name:e.template_name,template_id:e.template_id,fromPath:e.fromPath,subName:e.subTask[e.subTaskIndex].name},null,8,["progress","name","template_name","template_id","fromPath","subName"])))),128))])),_:1})]),u("div",Xs,[x(n,{direction:"vertical","label-align":"center",title:"任务统计",column:4,size:"small"},{default:I((()=>[x(i,{width:"25%"},{label:I((()=>a[0]||(a[0]=[u("div",{class:"cell-item"},"目前状态",-1)]))),default:I((()=>[a[1]||(a[1]=g(" 任务处理中 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[2]||(a[2]=[u("div",{class:"cell-item"},"任务数量",-1)]))),default:I((()=>[a[3]||(a[3]=g(" 21/90 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[4]||(a[4]=[u("div",{class:"cell-item"},"剩余时间",-1)]))),default:I((()=>[a[5]||(a[5]=g(" 00:14:40 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[6]||(a[6]=[u("div",{class:"cell-item"},"消耗时间",-1)]))),default:I((()=>[a[7]||(a[7]=g(" 00:05:31 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[8]||(a[8]=[u("div",{class:"cell-item"},"排队优先级",-1)]))),default:I((()=>[a[9]||(a[9]=g(" 高优先处理 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[10]||(a[10]=[u("div",{class:"cell-item"},"任务类型",-1)]))),default:I((()=>[a[11]||(a[11]=g(" GPU-普通模型 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[12]||(a[12]=[u("div",{class:"cell-item"},"节点数量",-1)]))),default:I((()=>[a[13]||(a[13]=g(" 15/15 "))])),_:1}),x(i,{width:"25%"},{label:I((()=>a[14]||(a[14]=[u("div",{class:"cell-item"},"内存使用",-1)]))),default:I((()=>[a[15]||(a[15]=g(" min.64GB "))])),_:1})])),_:1}),a[24]||(a[24]=u("hr",null,null,-1)),a[25]||(a[25]=u("div",{class:"title"},[g(" 费用统计 "),u("div",{class:"type-item success"},"完成"),u("div",{class:"type-item wait"},"队列"),u("div",{class:"type-item error"},"失败")],-1)),u("div",{class:"echarts-area",ref_key:"echartsDom",ref:t},null,512),u("div",Bs,[x(n,{direction:"vertical","label-align":"center",title:"",column:4,size:"small"},{default:I((()=>[x(i,{width:"25%",align:"center"},{label:I((()=>a[16]||(a[16]=[u("div",{class:"cell-item"},"已使用费用",-1)]))),default:I((()=>[a[17]||(a[17]=u("b",null,"1.24 积分",-1))])),_:1}),x(i,{width:"25%",align:"center"},{label:I((()=>a[18]||(a[18]=[u("div",{class:"cell-item"},"待使用费用",-1)]))),default:I((()=>[a[19]||(a[19]=u("b",null,"1.24 积分",-1))])),_:1}),x(i,{width:"25%",align:"center"},{label:I((()=>a[20]||(a[20]=[u("div",{class:"cell-item"},"返回费用",-1)]))),default:I((()=>[a[21]||(a[21]=u("b",null,"1.24 积分",-1))])),_:1}),x(i,{width:"25%",align:"center"},{label:I((()=>a[22]||(a[22]=[u("div",{class:"cell-item"},"预估费用",-1)]))),default:I((()=>[a[23]||(a[23]=u("b",null,"1.24 积分",-1))])),_:1})])),_:1})])])])}}},[["__scopeId","data-v-031ca932"]]),Js={class:"model-editor"},Zs=xe({__name:"index",props:{setting:{},staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]},templateId:{type:Number,default:null},info:{type:Object,default:()=>({template_filter:"normal",template_level:"normal",points:1})},needOpInput:{type:Boolean,default:!0},needTaskList:{type:Boolean,default:!0},layerData:{},editorType:{}},setup(e){const{userStore:t,publicStore:a}=ne(),l=r(Je);r(Wt);const s=e,i=r(null),n=r(null),u=r([]),c=r([]),h=e=>{u.value=e},m=(...e)=>{i.value.setSelectedLayer(...e)},g=e=>{c.value=e},y=(...e)=>{i.value.toSettingLayer(...e)},f=e=>{i.value.deleteGroup(e)},b=e=>{i.value.deleteLayer(e)},D=e=>{i.value.deleteElement(e)},k=e=>{i.value.setGroup(e)},C=e=>{i.value.hideLayer(e)},_=(...e)=>{i.value.reGenerateGroup(...e)},T=(...e)=>{i.value.reGenerateLayer(...e)},M=(...e)=>{i.value.reGenerateElement(...e)},S=(...e)=>{n.value.setSelectedElement(...e)},E=()=>{i.value.setDiagramImage()};return(a,r)=>(o(),d("div",Js,[v(t).token&&e.needTaskList?(o(),w(Ms,{key:0,name:"任务队列",num:l.value.getTaskList().length,icon:"clouds",height:"17.8rem"},{default:I((()=>[x($s)])),_:1},8,["num"])):p("",!0),x(Is,{staticsList:s.staticsList,promptsList:s.promptsList,colorsList:s.colorsList,textsList:s.textsList,ref_key:"modelDrawBoardDom",ref:i,onSetTypeList:h,onSetGroupList:g,onSetSelectedElement:S,setting:s.setting,editorType:s.editorType,layerData:s.layerData,templateId:e.templateId,needOpInput:e.needOpInput,needTaskList:e.needTaskList},null,8,["staticsList","promptsList","colorsList","textsList","setting","editorType","layerData","templateId","needOpInput","needTaskList"]),x(da,{ref_key:"editorLayersDom",ref:n,typeList:u.value,groupList:c.value,onToLayerInfo:y,onSetSelectedLayer:m,onDeleteGroup:f,onDeleteLayer:b,onDeleteElement:D,onSetGroup:k,onHideLayer:C,onReGenerateGroup:_,onReGenerateLayer:T,onReGenerateElement:M,onSetDiagramImage:E,editorType:s.editorType},null,8,["typeList","groupList","editorType"])]))}},[["__scopeId","data-v-1b0ddb88"]]);export{Ge as c,Oe as h,Zs as m};
