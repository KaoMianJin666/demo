var e=Object.defineProperty,t=(t,a,l)=>((t,a,l)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[a]=l)(t,"symbol"!=typeof a?a+"":a,l);import{s as a,u as l,g as i,a as n}from"./promptSetting-BKYlvCxI.js";import{u as s,K as o,H as r,L as d,M as u,r as c,h,i as m,j as v,s as p,y as g,x as y,G as f,D as w,p as b,F as x,q as D,v as k,A as I,g as C,k as T,E,w as L,m as _,o as M,B as S,C as A,z,N as O,O as R,P as U}from"./lib-CZQAdzIv.js";import{T as P,_ as G}from"./TLoading-Bct1L4DW.js";import{a as j,o as N,u as V,q as H,s as Y,r as F,h as X,v as W,x as B,y as $,z as Z,A as J,k as Q,B as q,C as K,D as ee,i as te,l as ae,E as le,F as ie,G as ne}from"./index-2JieiYcA.js";import{r as se,a as oe,u as re}from"./index-Dc2RlmRA.js";import{u as de}from"./modelEditor-CiKE7pJT.js";import{m as ue}from"./menu-B85Lp49n.js";const ce="操作",he="绘制",me={NOMAL:"定位花",AGENT_X:"横向二方连续",AGENT_Y:"纵向二方连续",AGENT_F:"四方连续"},ve="editor",pe="explosion",ge={statics:"静态层",prompts:"动态层",colors:"纯色层",texts:"文本层"};class ye{constructor(e,t,a="",l=0){this.name=a,this.uuid=e,this.parentUuid=t,this.isShow=!0,this.children=[],this.zIndex=l}addChild(e){this.children.push(e)}changeParent(e){this.parentUuid=e}setData(e={}){Object.keys(e).forEach((t=>{this[t]=e[t]}))}hide(){this.isShow=!1}show(){this.isShow=!0}}const fe=(e,t)=>t===e.length,we=(e,t=0,a=0,l=[])=>{const i=e[t];return new Promise((n=>{var s;(s=i,se.post(`/teai/query_task?task_id=${s}`)).then((i=>{"error"===i.data.task_status?(a=0,t+=1,l.push("")):"processing"===i.data.task_status?++a>=30&&(a=0,t+=1,l.push("")):(a=0,t+=1,l.push(i.data)),fe(e,t)?n(l):setTimeout((()=>{n(we(e,t,a,l))}),2e3)})).catch((i=>{fe(e,t+=1)?n(l):setTimeout((()=>{n(we(e,t,a,l))}),2e3)}))}))};class be{constructor(e=null,a=null){t(this,"getGenerateResult",(e=>we(e))),this.name=e,this.template_id=a}getGenrateTaskId(e,t){return new Promise((a=>{(function(e,t,a,l=1){return se.post(`/teai/generate?template_id=${e}&layout_name=${t}&layer_name=${a}&num_images=${l}`)})(this.template_id,this.name,e,t).then((e=>{a(e.data)})).catch((e=>{a(null)}))}))}getGroupTaskResult(e=[],t=0,a={}){const l=e[t],{children:i}=l;return new Promise((n=>{this.getGenrateTaskId(l.uuid,i.length).then((l=>{this.getGenerateResult(l).then((l=>{i.forEach(((e,t)=>{a[e]=l[t]})),++t===e.length?n(a):n(this.getGroupTaskResult(e,t,a))}))})).catch((e=>{n(a)}))}))}getLayerTaskResult(e){const{uuid:t}=e;return new Promise((e=>{this.getGenrateTaskId(t,1).then((a=>{this.getGenerateResult(a).then((([a])=>{e({[t]:a})}))})).catch((t=>{e({})}))}))}getElementTaskResult(e,t,a=0){return new Promise((a=>{this.getGenrateTaskId(t,1).then((t=>{this.getGenerateResult(t).then((([t])=>{a({[e]:t})})).catch((()=>{a({[e]:null})}))}))}))}imgGenerateImg(e,t){return new Promise((a=>{(function(e,t){return se.post(`/teai/img2img?image_url=${e}&similarity=${t}`)})(e,t).then((e=>{this.getGenerateResult(e.data).then((([e])=>{a({image:e})})).catch((()=>{a({image:null})}))}))}))}setName(e){this.name=e}setId(e){this.template_id=e}}const xe=s(),De={All:"全部生成",Layer:"单层生成",Element:"单元素生成",Group:"单组生成"},ke="正常模式",Ie="图生图";const Ce=new class{constructor(){this.taskList=o([]),this.activeUuid=null}addTask(e,t,a,l=[],i=ke){const n=r(),s=oe.currentRoute,d=o({uuid:n,template_id:e,template_name:t,name:`${t}-${i===ke?De[a]:Ie}`,taskType:a,progress:0,subTaskIndex:0,generateType:i,isFinish:!1,fromPath:s.value.path});l.length?(l.forEach((e=>{e.result=null})),d.subTask=l):(d.subTask=[d],d.subTask[0].result=null),this.taskList.push(d),this.activeUuid||(this.activeUuid=n,this.startTask()),xe.success("任务已添加至队列")}async startTask(){if(!this.activeUuid)return;const e=this.taskList.find((({uuid:e})=>e===this.activeUuid)),{generateType:t,subTask:a,template_id:l,template_name:i}=e,n=new be(i,l);for(let r=0;r<a.length;r++){e.subTaskIndex=r;const{type:l}=a[r];let i=null;if(t===ke){if("Group"===l)try{i=await n.getGroupTaskResult([a[r]])}catch(o){}else if("Layer"===l)try{i=await n.getLayerTaskResult(a[r])}catch(o){}else if("Element"===l)try{i=await n.getElementTaskResult(a[r].uuid,a[r].generateUuid)}catch(o){}}else if(t===Ie){const e=a[r],{imageUrl:t,similarity:l}=e;i=await n.imgGenerateImg(t,l)}a[r].result=i,e.progress=Math.round((r+1)/a.length*100)}e.isFinish=!0;const s=this.taskList.findIndex((({uuid:e})=>e===this.activeUuid));s<this.taskList.length-1?(this.activeUuid=this.taskList[s+1].uuid,this.startTask()):this.activeUuid=null,await this.setTaskResult([e])}async setTaskResult(e=this.taskList){let t=[];for(let a=0;a<e.length;a++){const l=e[a],{generateType:i,subTask:n,template_id:s,uuid:o}=l,r=oe.currentRoute;if(!l.isFinish)break;if(i===ke){if(!("/modelEditor"!==r.value.path&&"/generateImage"!==r.value.path&&"/modelMainEditor"!==r.value.path||r.value.query.template_id!==s&&Mt.templateId!==s)){xe.success(`${l.name} 生成完成，更新页面`);for(let e=0;e<n.length;e++){const{type:t}=n[e];switch(t){case"Group":await Lt.setGroupGenerateResult(n[e].result);break;case"Layer":await Lt.setLayerGenerateResult(n[e].result);break;case"Element":await Lt.setElemenyGenerateResult(n[e].result,n[e].uuid)}}Mt.changeHandleType(ce),t.push(o)}}else if(i===Ie&&!("/modelEditor"!==r.value.path&&"/generateImage"!==r.value.path&&"/modelMainEditor"!==r.value.path||r.value.query.template_id!==s&&Mt.templateId!==s)){xe.success(`${l.name} 生成完成，更新页面`);const[e]=n,{uuid:a,result:i}=e,s=_t.findData("element",a);t.push(a),Mt.contextMenu({},s,"prompts",i.image.task_result),Mt.changeHandleType(ce)}}t.forEach((e=>{const t=this.taskList.findIndex((t=>t.uuid=e));this.taskList.splice(t,1)}))}checkInTask(){const e=oe.currentRoute;return("/modelEditor"===e.value.path||"/generateImage"===e.value.path||"/modelMainEditor"===e.value.path)&&Boolean(this.taskList.length&&this.taskList.find((({template_id:e})=>Mt.templateId===e)))}getTaskList(){return this.taskList}},Te=s(),Ee={group:class extends ye{constructor(e,t,a,l={}){super(e,t,a),this.prompts=l.prompts||null,this.statics=l.statics||null,this.colors=l.colors||null,this.texts=l.texts||null,this.type=l.type||null}},layer:class extends ye{constructor(e,t,a,l={}){super(e,t,a),this.prompts=l.prompts||null,this.statics=l.statics||null,this.colors=l.colors||null,this.texts=l.texts||null,this.image=l.image||null,this.type=l.type||null,this.tileType=l.tileType||null,this.fontSetting=l.fontSetting||{content:"默认文本",font:"",fontFamily:"PingFangSC",font_color:[255,255,255,1],font_size:64}}},element:class extends ye{constructor(e,t,a,l={}){super(e,t,a),this.x=l.x,this.y=l.y,this.width=l.width,this.height=l.height,this.image=l.image,this.rotate=l.rotate||0,this.type=l.type||null,this.tileType=l.tileType||null,this.lightness=l.lightness||0,this.opacity=l.opacity||1,this.xOverturn=l.xOverturn||!1,this.yOverturn=l.yOverturn||!1,this.colorGradation=l.colorGradation||null,this.hue=Array.isArray(l.hue)?l.hue:null,this.saturation=l.saturation||1,this.edgeFeather=l.edgeFeather||0,this.fontSetting=l.fontSetting||{content:"默认文本",font:"",fontFamily:"PingFangSC",font_color:[255,255,255,1],font_size:64},this.color=l.color||[0,0,0,1],this.handleImage=l.handleImage||null,this.virtuallyElements=l.virtuallyElements||[]}}},Le={group:{parentType:null,childrenType:"layer"},layer:{parentType:"group",childrenType:"element"},element:{parentType:"layer",childrenType:null}};class _e{constructor(){this.groups=o({}),this.layers=o({}),this.elements=o({}),this.showMap=o({groups:new Set,layers:new Set}),this.selectedMap=o({group:null,layer:null,element:null})}async add(e,t,a,l={},i=null,n=null){const s=Ee[e],o=this.findParent(t),d=this[`${e}s`];if(!s)throw new Error(`Unknown type: ${e}`);if(i){if(d[i]=new s(i,t,a,l),t)o&&(o.addChild(i),d[i].zIndex=n||o.children.length);else{const e=this.getAllList();d[i].zIndex=n||e.length}if("element"===e){const e=this.findParent(t);a=`${e.name}-${e.children.length+1}`,l=Object.assign(l,{image:e.image,type:e.type})}}else{if(i=r(),"element"===e){const e=this.findParent(t);a=`${e.name}-${e.children.length+1}`,l=Object.assign(l,{image:e.image,type:e.type})}if(d[i]=new s(i,t,a,l),t)o&&(o.addChild(i),d[i].zIndex=n||o.children.length);else{const e=this.getAllList();d[i].zIndex=n||e.length+1}"layer"===e&&"colors"===l.type&&(a=`${a}`,await this.add("element",i,a,Object.assign({width:100,height:100,x:0,y:0},l)),this.reDraw()),"layer"===e&&"statics"===l.type&&l.tileType&&(a=`${a}`,await this.add("element",i,a,Object.assign({width:100,height:100,x:0,y:0},l)),this.reDraw())}return i}setData(e,t,a={}){if(this[`${e}s`][t].setData(a),"layer"===e&&a.image){this.findData(e,t).children.forEach((e=>{this.setData("element",e,{image:a.image})}))}}delete(e,t){if(Ce.checkInTask())return void Te.error("该模板当前有在进行中的生成队列请在队列完成后操作");const a=this.findData(e,t);if(!a)return;const l=a.children;l.length&&l.forEach((t=>{this.delete(Le[e].childrenType,t)}));const i=this[`${e}s`];if(a.parentUuid){const l=this.findParent(a.parentUuid,`${Le[e].parentType}s`);l.children=l.children.filter((l=>{const i=this.findData(e,l);return i.zIndex>a.zIndex&&(i.zIndex-=1),l!==t})),"group"===Le[e].parentType&&1===l.children.length&&this.unbindGroup({type:"layer",uuid:l.children[0]})}this.selectedMap[e]===t&&(this.selectedMap[e]=null),this.reDraw(),a&&a.tileType&&"element"===e&&this.delete("layer",a.parentUuid),delete i[t]}handleIsShow(e,t,a="show"){const l=this.findData(e,t);if(!l)return;const i=l.children;if(i.length?i.forEach((t=>{this.handleIsShow(Le[e].childrenType,t,a)})):l[a](),l.parentUuid){const t=this.findData(Le[e].parentType,l.parentUuid);t.children.every((t=>this.findData(e,t).isShow===("show"===a)))?t[a]():t.show()}this.reDraw()}findParent(e,t=""){for(const a of t?[t]:["groups","layers","elements"]){const t=this[a];if(t[e])return t[e]}return null}findData(e,t){return this[`${e}s`][t]}handleShowMap(e,t){this.showMap[`${e}s`].has(t)?this.showMap[`${e}s`].delete(t):this.showMap[`${e}s`].add(t)}isShowMapShow(e,t){return this.showMap[`${e}s`].has(t)}changeSelected(e){for(let t in e){t=Number(t);const a=e[t],l=Object.keys(Le)[t];a&&"element"!==l&&this.showMap[`${l}s`].add(a),this.selectedMap[l]=a}this.reDraw()}isSelected(e,t){return this.selectedMap[e]===t}async bindGroup({fromData:e,toData:t,zIndex:a}){if(e.uuid!==t.uuid){if(a||0===a){const l=this.findData(e.type,e.uuid),i=this.findData(t.type,t.uuid);if(l.parentUuid!==i.parentUuid)return;const n=l.zIndex;let s=i.zIndex;const o=this.getListByParentUuid(l.parentUuid);n>s?(s=a+1,o.forEach((e=>{const{dataType:t,uuid:a}=e,l=e.zIndex;l<n&&l>=s&&(this[`${t}s`][a].zIndex+=1)})),l.zIndex=s):(o.forEach((e=>{const{dataType:t,uuid:a,zIndex:l}=e;l<=s&&l>n&&(this[`${t}s`][a].zIndex-=1)})),l.zIndex=Math.min(s,o.length))}else{if("group"===e.type)return;const a=this.findData(e.type,e.uuid),l=this.findData(t.type,t.uuid);if("group"===t.type){if(!new Set(l.children).has(a.uuid)){if(!this.bindGroupCheck([e.uuid,l.children[0]]))return;if(l.addChild(a.uuid),a.parentUuid){const t=this.findParent(a.parentUuid);a.changeParent(l.uuid),a.zIndex=l.children.length,t.children=t.children.filter((t=>{const l=this.findData("layer",t);return l.zIndex>e.zIndex&&(l.zIndex-=1),t!==a.uuid}))}else{const t=this.getListByParentUuid(a.parentUuid);a.changeParent(l.uuid),a.zIndex=l.children.length,t.forEach((({dataType:t,uuid:a})=>{const l=this.findData(t,a);l.zIndex>e.zIndex&&(l.zIndex-=1)}))}}}else{const i=this.bindGroupCheck([e.uuid,t.uuid]);if(!i)return;const n=Object.assign({texts:[],statics:[],prompts:[],colors:[]},{[i.type]:i.typesInfo});let s=null;if(l.parentUuid){s=l.parentUuid;const t=this.findData("group",s);if(a.parentUuid)this.unbindGroup(e),a.changeParent(s),t.addChild(a.uuid),a.zIndex=t.children.length;else{this.getListByParentUuid(a.parentUuid).forEach((({dataType:e,uuid:t})=>{const l=this.findData(e,t);l.zIndex>a.zIndex&&(l.zIndex-=1)})),a.changeParent(s),t.addChild(a.uuid),a.zIndex=t.children.length}}else{s=await this.add("group",null,`组-${Object.keys(this.groups).length+1}`,n);const t=this.findData("group",s);a.parentUuid&&this.unbindGroup(e),t.addChild(a.uuid),t.addChild(l.uuid),a.changeParent(s),l.changeParent(s),t.zIndex=l.zIndex,a.zIndex=2,l.zIndex=1}}}this.reDraw()}}unbindGroup(e){const{uuid:t,type:a}=e;if("group"===a)return;const l=this.findData(a,t);if(!l.parentUuid)return;const i=this.findParent(l.parentUuid);i.children=i.children.filter((e=>{const t=this.findData("layer",e);return t.zIndex>l.zIndex&&(t.zIndex-=1),e!==l.uuid})),0===i.children.length&&(this.delete("group",i.uuid),l.changeParent(null),l.zIndex=i.zIndex),1===i.children.length?(l.changeParent(null),l.zIndex=this.getAllList().length,this.unbindGroup({type:"layer",uuid:i.children[0]})):i.children.length>1&&(l.changeParent(null),l.zIndex=this.getAllList().length),this.reDraw()}getListByParentUuid(e){const t=[];return Object.keys(Le).forEach((a=>{Object.keys(this[`${a}s`]).forEach((l=>{const i=this[`${a}s`][l];e===i.parentUuid&&(t[i.zIndex-1]=Object.assign({dataType:a},i))}))})),t}bindGroupCheck(e){let t=new Set,a=new Set,l=!0;return e.forEach(((e,i)=>{t.add(this.layers[e].type);const n=this.layers[e],s=n.type,o=new Set(n[s]);if(0===i)a=o;else{if(o.size!=o.size)return void(l=!1);for(let e of a)o.has(e)||(l=!1)}})),!([...t].length>1)&&(!!l&&{type:[...t][0],typesInfo:[...a]})}clearAllData(){this.groups={},this.layers={},this.elements={},this.showMap={groups:new Set,layers:new Set},this.selectedMap={group:null,layer:null,element:null}}getData(){return{groups:this.groups,layers:this.layers,elements:this.elements}}getAllList(){const e=Object.keys(this.groups).map((e=>({type:"group",uuid:e,zIndex:this.groups[e].zIndex}))),t=Object.keys(this.layers).filter((e=>!this.layers[e].parentUuid)).map((e=>({type:"layer",uuid:e,zIndex:this.layers[e].zIndex}))),a=[].concat(e,t),l=[];return a.forEach((e=>{const{zIndex:t}=e;l[t-1]=e})),l}async copyData(e,t,a){const l=this.findData(t,e),i=l.image;a=a||l.parentUuid;const n=JSON.parse(JSON.stringify(l));n.handleImage=l.handleImage,n.parentUuid=null,!n.tileType&&"element"===t&&n.x&&n.y&&(n.x+=100,n.y+=100);const s=await this.add(t,a||null,`${l.name}-${Math.round(1e3*Math.random())}`,n),o=this.findData(t,s);i&&o.setData({image:i}),o.children=[],o.zIndex=null,l.children.length&&l.children.forEach((async e=>{await this.copyData(e,Le[t].childrenType,s)}));this.getListByParentUuid(a).forEach((e=>{const t=this.findData(e.dataType,e.uuid);"element"!==e.dataType?t.zIndex>=l.zIndex&&(t.zIndex+=1):t.zIndex>l.zIndex&&(t.zIndex+=1)})),o.zIndex="element"!==t?l.zIndex-1:l.zIndex+1,this.reDraw()}}class Me{constructor(){this.listeners={}}addListener(e,t,a){e.addEventListener(t,a);const l=r();return this.listeners[l]={element:e,eventType:t,listener:a},l}removeListenersByEventType(e){const{listeners:t}=this;Object.keys(t).filter((a=>t[a].eventType===e)).forEach((e=>{this.removeListenter(e)}))}removeAllListeners(){for(var e in this.listeners)this.removeListenter(e);this.listeners={}}removeListenter(e){var t=this.listeners[e];t.element.removeEventListener(t.eventType,t.listener),delete this.listeners[e]}}const Se="edit",Ae="generate",ze="gallery",Oe="效果调节",Re="上传替换",Ue="文本编辑",Pe="颜色编辑",Ge="图层编辑",je="AI图生图",Ne="重新生成",Ve="删除元素",He="删除图层",Ye="删除组",Fe="复制元素",Xe="复制图层",We="复制组";class Be{constructor(e=Se){this.handelType=e,this.x=0,this.y=0,this.layerType=null,this.isShow=!1,this.dom=null,this.bindDom=null,this.isHasImage=!1,this.tileType=null}setHandle({uuid:e,type:t,tileType:a},{x:l,y:i},n,s=!1,o=document.body,r=null){return this.close(),this.bindDom=o,this.isHasImage=s,this.tileType=a,new Promise((a=>{this.x=l,this.y=i,this.handleUuid=e,this.elementType=t,this.layerType=n,this.createDom(r).then((e=>{a(e)}))}))}close(){this.isShow=!1,this.x=0,this.y=0,this.layerType=null,this.dom&&(this.bindDom.removeChild(this.dom),document.documentElement.onClick=()=>{},this.dom=null)}createDom(e=null){return new Promise((t=>{const a=document.createElement("div");a.className="editor-contextmenu-view",this.bindDom.appendChild(a),this.dom=a,document.documentElement.onclick=this.close.bind(this),this.createList(e).then((e=>{t(e)}))}))}createList(e=null){const t=this.getHandleList(this.handelType),{x:a,y:l,dom:i,bindDom:n}=this,s=(1.2*t.length-.2)*window.rootFont,o=n.getBoundingClientRect();let r=l+s>o.bottom?o.bottom-s-o.top:l-o.top;return i.style.top=`${r}px`,i.style.left=a-o.left+"px",new Promise((a=>{t.forEach((t=>{this.dom&&this.createItem(t,e).then((e=>{a(e)}))})),setTimeout((()=>{this.dom&&(this.dom.style.height=1.2*t.length-.2+"rem",this.dom.style.transform="scale(1, 1)")}))}))}createItem({name:e,icon:t,type:a="button"},l=null){const{handleUuid:i}=this;return new Promise((n=>{const s=document.createElement("div");s.className="editor-contextmenu-item";const o=document.createElement("i");o.className="editor-contextmenu-item-icon",o.className=`editor-contextmenu-item-icon bi ${t}`;const r=document.createElement("div");if(r.className="editor-contextmenu-item-name",r.innerText=e,s.appendChild(o),s.appendChild(r),"upload"===a){const t=document.createElement("input");t.type="file",s.appendChild(t),t.onclick=e=>{e.stopPropagation()},t.onchange=t=>{t.stopPropagation();const{target:a}=t;n({file:a.files[0],handleUuid:i,name:e}),this.close()}}else s.onclick=t=>{t.stopPropagation(),n({handleUuid:i,name:e}),this.close()};this.dom.appendChild(s),("texts"===l&&e===Ue||"prompts"===l&&e===je)&&s.click()}))}getHandleList(e=Se){let t=[];e=e||this.handelType;const{isHasImage:a,elementType:l,layerType:i,tileType:n}=this;switch(i){case"element":switch(e){case Se:if(t=a?[{name:Oe,icon:N,type:"button"},{name:Re,icon:V,type:"upload"},{name:Fe,icon:H,type:"button"},{name:je,icon:Y,type:"button"},{name:Ne,icon:F},{name:Ve,icon:X,type:"button"}]:[{name:Oe,icon:N,type:"button"},{name:Re,icon:V,type:"upload"},{name:Fe,icon:H,type:"button"},{name:Ne,icon:F},{name:Ve,icon:X,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Ue,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Pe,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}break;case Ae:if(t=a?[{name:Oe,icon:N,type:"button"},{name:Re,icon:V,type:"upload"},{name:Fe,icon:H,type:"button"},{name:je,icon:Y,type:"button"},{name:Ne,icon:F},{name:Ve,icon:X,type:"button"}]:[{name:Re,icon:V,type:"upload"},{name:Ne,icon:F},{name:Ve,icon:X,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Ue,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Pe,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}break;case ze:if(t=a?[{name:Oe,icon:N,type:"button"},{name:Re,icon:V,type:"upload"},{name:Fe,icon:H,type:"button"},{name:Ve,icon:X,type:"button"}]:[{name:Re,icon:V,type:"upload"},{name:Fe,icon:H,type:"button"},{name:Ve,icon:X,type:"button"}],"texts"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Ue,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}else if("colors"===l){const e=t.findIndex((({name:e})=>e===Re));t.splice(e,1,{name:Pe,icon:j,type:"button"});const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}}break;case"layer":switch(e){case Ae:t=[{name:Xe,icon:H,type:"button"},{name:He,icon:X,type:"button"}];break;case Se:t=[{name:Ge,icon:j,type:"button"},{name:Xe,icon:H,type:"button"},{name:He,icon:X,type:"button"}];break;case ze:t=[{name:Xe,icon:H,type:"button"},{name:He,icon:X,type:"button"}]}break;case"group":switch(e){case Ae:case ze:case Se:t=[{name:We,icon:H,type:"button"},{name:Ye,icon:X,type:"button"}]}}if(n){const e=t.findIndex((({name:e})=>e===Fe));t.splice(e,1);const a=t.findIndex((({name:e})=>e===Oe));t.splice(a,1)}return t}}function $e(e,t,a){const l=e.split(";base64,"),i=l[0].split(":")[1],n=atob(l[1]);let s=n.length;const o=new Uint8Array(s);for(;s--;)o[s]=n.charCodeAt(s);const r=Ze(e);return new File([r],`${t}${d=i,{"image/jpeg":".jpg","image/png":".png","image/gif":".gif","application/pdf":".pdf"}[d]||".bin"}`,{type:i,lastModified:Date.now()});var d}function Ze(e,t,a){const l=e.split(";base64,"),i=l[0].split(":")[1],n=atob(l[1]);let s=n.length;const o=new Uint8Array(s);for(;s--;)o[s]=n.charCodeAt(s);return new Blob([o],{type:i})}function Je(e){return new Promise((t=>{const a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{t(a)},a.src=e}))}function Qe(e){return new Promise((t=>{(function(e){return new Promise((t=>{const a=new FileReader;a.onload=({target:e})=>{t(e.result)},a.readAsDataURL(e)}))})(e).then((e=>{Je(e).then((e=>{t(e)}))}))}))}function qe(e){return new Promise((t=>{const a=new Image;a.crossOrigin="Anonymous",a.onload=()=>{t(a)},a.onerror=()=>[t(null)],a.src=e}))}function Ke(e,t){const a=JSON.stringify(e),l=new Blob([a],{type:"application/json"});return new File([l],`${t}.json`,{type:"application/json",lastModified:Date.now()})}function et(e){const t=e.match(/\d+/g);return t?t.map(Number):[]}function tt(e){return`rgba(${e.join(",")})`}function at(e){return`rgb(${e.join(",")})`}const lt=d(),it="编辑器",nt="操作",st="绘制",ot="定位花",rt="横向二方连续",dt="纵向二方连续",ut="四方连续",ct={outerWidth:100,innerWidth:20};class ht{constructor(){this.rootFont=window.rootFont,this.realWidth=2048,this.realHeight=2048,this.name="",this.canvasOuterDom=null,this.canvasDom=null,this.ctx=null,this.zoomRatio=1,this.handleState=nt,this.listeners=new Me,this.startX=0,this.startY=0,this.isDrawing=!1,this.moveType=null,this.drawType=ot,this.handleController=null;const e=new Image;this.rotateImage=null,this.viewType="editor",e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE7mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4xLWMwMDEgNzkuMTQ2Mjg5OSwgMjAyMy8wNi8yNS0yMDowMTo1NSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDI1LjMgKFdpbmRvd3MpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyNC0wOS0xOVQyMDozNjo1NCswODowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjQtMDktMTlUMjA6Mzg6MDcrMDg6MDAiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMDktMTlUMjA6Mzg6MDcrMDg6MDAiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI0ZWM4ZGEzLTEyMzYtODc0MC05ZjM3LTYxYTEzYjJjZGMzYSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoyNGVjOGRhMy0xMjM2LTg3NDAtOWYzNy02MWExM2IyY2RjM2EiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyNGVjOGRhMy0xMjM2LTg3NDAtOWYzNy02MWExM2IyY2RjM2EiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjI0ZWM4ZGEzLTEyMzYtODc0MC05ZjM3LTYxYTEzYjJjZGMzYSIgc3RFdnQ6d2hlbj0iMjAyNC0wOS0xOVQyMDozNjo1NCswODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDI1LjMgKFdpbmRvd3MpIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgYbnyIAAANaSURBVFiF7ZhBbuowEIb/ZJFNtskaIV8hyopL9ByRIm7BKlIPwB286AHKCcoqq1ZqRCXKE6qi8uQsQI3fAk/fNC+BQM1rFx3JG4jtz2PP+B87Wmt8Z3O/GuCY/QB+lQ0AjAHMAVQAagC60WoApflm0ndgrfWHdg7YLQE5jvMmhFhmWbbI83yjlNJKKZ3n+SZJkkIIsXRdd2uAd6bv6FKAksCCIHghoGOmlNJSylUQBC8MdGob8A6A9n3/lYORt9I0fYzjeBGG4ToMw7UQYpmm6SN5lIN6nlcZ0DtbgPcA9HA4fOaTpWn6yLaPztsD9meuNL9rz/OqLMsWvO9wOHw2/99/FvAOgI6i6ImfLwZWYh8Ag47+U+yDSHueV0kpVzROFEVPaPHkKYBT7jmllM6ybME81jsyzVg7AJq82fCkPBVwBGDneV7VAlfhSCQeGLNqQvq+/4r9ggenAN4C0FLKldZaSylXDK5rO/vYgCDzPN9orXWe5xsz9uwUwF0QBC+0ShN5O5znuaaNANSu625p/DAM1zBe7AM4AfNemqaPZoWduesMmwDQSZIUDS+O+wDO+eqM90qLcGQln8dxnDcA8z6ApRBiSTkL9r1HNgE7i0KIJYCqD2BNrmfbewkb8LlMlqj7ADZXdYntJSvjOF7wc9gG2JRJ7/enia7m/88WAR/CMFzz49QEdB3HqZVS4I2sKIqA/351dVVYhAOA330+0kmSFMekE4s0mx58D8hDW1zC5L0uSJZMNfZK2pbpRkC2BskA5iKn4DgAN7MINwU77xSQXVE8AlA7jvPGvUi67wJwAFByMWIk3MFEPYZRzdSJiQTbqWYKtr1snsmxPCgBaCHEknWyJRLI/pFy5gjtgH5qZm4+3l4A7l1utUi5WV9AGoiaLWsVrE0p1xfQto3RIvlN5H4QIzYAJfZBQ61L6dDrQwlT5POiKY5jKiHmvJMNwJ3v+69JkhSsxqVIn2NfSpZgrw/8pmp47qE5uBXAm5ubXzSZUkrTMwcV7lEUPSVJUrQV+aZI+sdzVgHDMFwfuhqbN1Ge5xt2G9VgZeYlAGcwB9513S09czQfj66vrxdCiKURGAQ2w5HMYDOKJ/j7zNH1/FaZb8bHwLoAnf+Za86xb//C+gP4WfsDkHE+0dPTz/8AAAAASUVORK5CYII=",this.handleLocked=!1,this.templateId=null,this.template_level="normal",this.template_filter="normal",this.points=1,this.hue=null,this.edgeFeather=0,this.drawX=0,this.drawY=0,e.onload=()=>{this.rotateImage=e},this.position={left:0,top:0}}init(e,t={},a=it,l,{template_level:i,template_filter:n,points:s}){return new Promise((o=>{this.canvasOuterDom=e,this.name=t.name||null,this.realWidth=t.realWidth||2048,this.realHeight=t.realHeight||2048,this.viewType="editor",this.drawType=t.drawType||ot,this.position={left:0,top:0},this.templateId=l||null,this.template_level=i,this.template_filter=n,this.points=s,this.getCanvasSize().then((e=>{this.canvasDom=document.createElement("canvas"),this.canvasDom.width=e.outerWidth,this.canvasDom.height=e.outerHeight,this.drawX=(e.outerWidth-e.width)/2,this.drawY=(e.outerHeight-e.height)/2,this.zoomRatio=e.zoomRatio,this.canvasOuterDom.focus(),this.handleState=nt,this.canvasOuterDom.appendChild(this.canvasDom),this.ctx=this.canvasDom.getContext("2d"),this.handleController=new Be(a),this.bindCanvasHandleListener(),o()}))}))}bindMainMove(){this.listeners.addListener(this.canvasDom,"mousedown",(e=>{this.handle("mousedown",e)})),this.listeners.addListener(this.canvasDom,"mousemove",(e=>{this.handle("mousemove",e)})),this.listeners.addListener(this.canvasDom,"mouseup",(e=>{this.handle("mouseup",e)})),this.listeners.addListener(this.canvasDom,"mouseleave",(e=>{this.handle("mouseleave",e)}))}unBindMove(){this.listeners.removeListenersByEventType("mousedown"),this.listeners.removeListenersByEventType("mousemove"),this.listeners.removeListenersByEventType("mouseup"),this.listeners.removeListenersByEventType("mouseleave")}bindHandleMove(){this.listeners.addListener(this.canvasOuterDom,"mousedown",(e=>{this.handle("mousedown",e)})),this.listeners.addListener(this.canvasOuterDom,"mousemove",(e=>{this.handle("mousemove",e)})),this.listeners.addListener(this.canvasOuterDom,"mouseup",(e=>{this.handle("mouseup",e)}))}bindCanvasHandleListener(){this.bindMainMove(),this.listeners.addListener(this.canvasDom,"click",(e=>{this.handle("selected",e)})),this.listeners.addListener(this.canvasDom,"dblclick",(e=>{this.handle("dblclick",e)})),this.listeners.addListener(this.canvasDom,"contextmenu",(e=>{this.handle("contextmenu",e)})),this.listeners.addListener(this.canvasOuterDom,"keydown",(e=>{this.handle("keydown",e)})),this.listeners.addListener(this.canvasOuterDom,"keyup",(e=>{this.handle("keyup",e)})),this.listeners.addListener(this.canvasOuterDom,"wheel",(e=>{const{drawX:t,drawY:a,realWidth:l,realHeight:i,zoomRatio:n}=this,s={width:this.canvasDom.width,height:this.canvasDom.height,zoomRatio:this.zoomRatio};if(e.deltaY>0){s.zoomRatio=Math.round(s.zoomRatio/11*10*1e4)/1e4;const e=l*(n-s.zoomRatio),t=i*(n-s.zoomRatio);this.drawX+=e/2,this.drawY+=t/2}else{s.zoomRatio=Math.round(11*s.zoomRatio/10*1e4)/1e4;const e=l*(s.zoomRatio-n),t=i*(s.zoomRatio-n);this.drawX-=e/2,this.drawY-=t/2}this.zoomRatio=s.zoomRatio,this.reDraw()}))}async resize(){const e=await this.getCanvasSize();this.canvasDom.width=e.outerWidth,this.canvasDom.height=e.outerHeight,this.drawX=(e.outerWidth-e.width)/2,this.drawY=(e.outerHeight-e.height)/2,this.zoomRatio=e.zoomRatio}lockHandle(e){this.handleState!==st&&"Space"===e.code&&(this.handleLocked=!0,this.canvasDom.className="canvas-key-down",this.unBindMove(),this.bindHandleMove())}unlockHandle(e){"Space"===e.code&&(this.handleLocked=!1,this.canvasDom.className="",this.unBindMove(),this.bindMainMove())}getCanvasSize(){const{realWidth:e,realHeight:t}=this,a=this.canvasOuterDom.getBoundingClientRect();return new Promise((l=>{if(a.width||a.height){const i=this.getZoomRatio(a.width,a.height,e,t);l(i)}else{const a=new ResizeObserver((i=>{for(let n of i){const{width:i,height:s}=n.contentRect;if(i&&s){const n=this.getZoomRatio(i,s,e,t);l(n),a.disconnect()}}}));a.observe(this.canvasOuterDom)}}))}getZoomRatio(e,t,a,l){const i=e,n=t;let s=1;return e/t<a/l?(t=t*a/e,s=e/a,e=a):(e=e*l/t,s=t/l,t=l),{outerWidth:i,outerHeight:n,width:a*s,height:l*s,zoomRatio:s}}destory(){this.width=0,this.height=0,this.realWidth=0,this.realHeight=0,this.name="",this.handleState=null,this.canvasOuterDom=null,this.canvasDom=null,this.ctx=null}setData({name:e,realWidth:t,realHeight:a,drawType:l,template_filter:i,template_level:n,points:s},o="init"){this.name=e,this.drawType=l,this.template_filter=i,this.template_level=n,this.points=s,t!==this.realWidth||a!==this.realHeight?"edit"===o?lt.confirm("修改尺寸将会清空所有元素，是否继续","警告",{confirmButtonText:"是",cancelButtonText:"否",type:"warning"}).then((()=>{this.realWidth=t,this.realHeight=a,this.clearAllData(),this.resize().then((()=>{this.reDraw()}))})):(this.realWidth=t,this.realHeight=a,this.clearAllData(),this.resize().then((()=>{this.reDraw()}))):this.reDraw()}changeHandleType(e){this.handleState=e,this.canvasDom.style.cursor=e===st?"crosshair":"auto"}handle(e,t){const{handleState:a,handleLocked:l,startX:i,startY:n,zoomRatio:s}=this;if(l){const{pageX:a,pageY:l}=t;switch(e){case"keyup":this.unlockHandle(t);break;case"mousedown":this.canvasDom.className="canvas-key-down-mousedown",this.isDrawing=!0,this.startX=a,this.startY=l;break;case"mousemove":if(!this.isDrawing)return;const e=a-i,s=l-n;this.startX=a,this.startY=l,this.drawX+=e,this.drawY+=s,this.reDraw();break;case"mouseup":switch(t.button){case 0:this.canvasDom.className="canvas-key-down",this.isDrawing=!1;break;case 1:this.isDrawing=!1,this.unlockHandle({code:"Space"})}}}else switch(a){case nt:this.handleEvent(e,t);break;case st:this.drawingEvent(e,t)}}handleEvent(e,t){switch(e){case"dblclick":this.checkContextMenu(t,!0);break;case"mousedown":switch(t.button){case 0:this.handleController.close(),this.checkMove(t);break;case 1:this.lockHandle({code:"Space"})}break;case"click":this.handleController.close();break;case"mousemove":this.moving(t);break;case"mouseup":switch(this.finishMove(t),t.button){case 0:this.finishMove(t);break;case 1:this.unlockHandle({code:"Space"})}break;case"contextmenu":this.checkContextMenu(t);break;case"selected":this.handleController.close(),this.selectedElement(t);break;case"mouseleave":this.finishMove(t);break;case"keydown":this.lockHandle(t)}}drawingEvent(e,t){switch(this.handleController.close(),e){case"mousedown":if(0!==t.button)return;this.toDraw(t);break;case"click":case"contextmenu":case"selected":break;case"mousemove":this.drawMove(t);break;case"mouseup":case"mouseleave":this.finishDraw(t);break;case"keydown":this.lockHandle(t)}}startDraw(e){const{offsetX:t,offsetY:a}=e;this.startX=t,this.startY=a,this.isDrawing=!0}drawMove(e){if(!this.isDrawing)return;const t=this.getDrawingArea(e);this.reDraw(t)}finishDraw(e){if(!this.isDrawing)return;this.isDrawing=!1;const t=this.getDrawingArea(e);this.sendElement(t)}startMove(e,t){const{offsetX:a,offsetY:l}=e;this.startX=a,this.startY=l,this.isDrawing=!0,this.moveType=t}moving(e){if(!this.isDrawing)return;const{moveType:t,startX:a,startY:l,zoomRatio:i,drawX:n,drawY:s}=this,{offsetX:o,offsetY:r}=e,d=(o-this.startX)/i,u=(r-this.startY)/i;this.startX=o,this.startY=r;const c=[(a-n)/i,(l-s)/i];this.setElementMovingData({xFloat:d,yFloat:u,rotateFloat:c,moveType:t},e.shiftKey)}finishMove(){this.isDrawing&&(this.isDrawing=!1,this.moveEnd())}contextMenu(e,t,a=null,l=null){this.handleController.setHandle(t,{x:e.pageX,y:e.pageY},"element",Boolean(t.image),this.canvasOuterDom,a).then((e=>{this.contextmenuCallBack(e,l)}))}contextmenuCallBack(e,t=null){switch(e.name){case Oe:this.toElementSetting(e.handleUuid);break;case Re:Qe(e.file).then((t=>{this.changeElementImage(e.handleUuid,t)}));break;case je:this.toImageGenerateView(e.handleUuid,t);break;case Ne:this.generateElement(e.handleUuid);break;case Ve:this.deleteElement(e.handleUuid);break;case Ue:this.toTextEdit(e.handleUuid,"text");break;case Pe:this.toTextEdit(e.handleUuid,"color");break;case Fe:this.copyData(e.handleUuid)}}getDrawingArea(e){const{offsetX:t,offsetY:a}=e,{startX:l,startY:i,zoomRatio:n,drawX:s,drawY:o}=this;let r=l>t?{startX:t,finishX:l}:{startX:l,finishX:t},d=i>a?{startY:a,finishY:i}:{startY:i,finishY:a};return{x:(r.startX-s)/n,y:(d.startY-o)/n,width:(r.finishX-r.startX)/n,height:(d.finishY-d.startY)/n}}clearAll(){const{ctx:e,canvasDom:t}=this;e.beginPath(),e.clearRect(0,0,t.width,t.height),e.closePath()}drawItem({name:e,x:t,y:a,width:l,height:i,rotate:n,image:s,xOverturn:o,yOverturn:r,opacity:d,handleImage:u}){const{ctx:c,zoomRatio:h,drawX:m,drawY:v}=this;if(l||i){if(t*=h,a*=h,t+=m,a+=v,l*=h,i*=h,c.beginPath(),c.save(),c.lineWidth=2,c.fillStyle="#222",c.translate(t+l/2,a+i/2),c.scale(o?-1:1,r?-1:1),c.globalAlpha=d,n&&c.rotate(n),s){const e=u||s;c.drawImage(e,-l/2,-i/2,l,i)}else c.rect(-l/2,-i/2,l,i),c.stroke(),c.fill();n&&c.rotate(-n),c.globalAlpha=1,c.scale(o?-1:1,r?-1:1),c.translate(-(t+l/2),-(a+i/2)),c.restore(),c.closePath()}}clearOther(){const{drawX:e,drawY:t,zoomRatio:a,realWidth:l,realHeight:i,ctx:n,canvasDom:s}=this;n.beginPath(),n.clearRect(0,0,e,s.height),n.clearRect(e,t+i*a,s.width,s.height),n.clearRect(0,0,s.width,t),n.clearRect(e+l*a,0,s.width,s.height),n.closePath()}drawTextItem({x:e,y:t,width:a,height:l,rotate:i,fontSetting:n,xOverturn:s,yOverturn:o,opacity:r}){const{content:d,font_color:u,font_size:c,fontFamily:h}=n,{ctx:m,zoomRatio:v,drawX:p,drawY:g}=this;e*=v,t*=v,e+=p,t+=g,a*=v,l*=v,m.beginPath(),m.save(),m.translate(e+a/2,t+l/2),m.scale(s?-1:1,o?-1:1),m.globalAlpha=r,i&&m.rotate(i),m.font=`${c*v}px ${h}`,m.fillStyle=tt(u);const y=m.measureText(d).width;m.fillText(d,-y/2,c*v/2),m.stroke(),i&&m.rotate(-i),m.scale(s?-1:1,o?-1:1),m.globalAlpha=1,m.translate(-(e+a/2),-(t+l/2)),m.restore(),m.closePath()}selectedElement(e){this.toSelectedElement(e)}checkIsInItem({x:e,y:t,width:a,height:l,rotate:i=0,tileType:n},s){const{offsetX:o,offsetY:r}=s,{ctx:d,zoomRatio:u,realWidth:c,realHeight:h,drawX:m,drawY:v}=this;e*=u,t*=u,e+=m,t+=v,a*=u,l*=u,"tile_x"===n?(e=m,a=c*u,i=0):"tile_y"===n?(t=v,l=h*u,i=0):"tile_xy"===n&&(e=m,a=c*u,t=v,l=h*u,i=0),d.beginPath(),d.save(),d.translate(e+a/2,t+l/2),i&&d.rotate(i),d.rect(-a/2,-l/2,a,l),d.translate(-(e+a/2),-(t+l/2)),i&&d.rotate(-i);let p=!!d.isPointInPath(o,r)&&"main";return d.restore(),d.closePath(),p}drawHandleArea({x:e,y:t,width:a,height:l,rotate:i,type:n,tileType:s}){const{zoomRatio:o,ctx:r,realHeight:d,realWidth:u,drawX:c,drawY:h}=this;e*=o,t*=o,e+=c,t+=h,a*=o,l*=o,"statics"!==n&&"colors"!==n||("tile_x"===s?(e=c,a=u*o,i=0):"tile_y"===s?(t=h,l=d*o,i=0):"tile_xy"===s&&(e=c,a=u*o,t=h,l=d*o,i=0));const m=10,v=10,p=[[0-a/2,-10-l/2,a,2],[a+5+5-a/2-1,0-l/2,2,l],[-10-a/2,0-l/2,2,l],[0-a/2,l+5+5-l/2-1,a,2]];[[-15-a/2,-15-l/2],[+a+5-a/2,-15-l/2],[+a+5-a/2,+l+5-l/2],[-15-a/2,+l+5-l/2]].forEach((n=>{this.drawHandlePoint(n,{x:e,y:t,width:a,height:l,rotate:i},v)})),p.forEach((n=>{this.drawHandleLine(n,{x:e,y:t,width:a,height:l,rotate:i})})),s&&s.includes("tile")||this.drawRotateArea({x:e,y:t,width:a,height:l,rotate:i},m)}drawRotateArea({x:e,y:t,width:a,height:l,rotate:i},n){const{rotateImage:s,ctx:o}=this;o.beginPath(),o.save(),o.translate(e+a/2,t+l/2),i&&o.rotate(i),o.drawImage(s,-10,-l/2-2*n-20,20,20),o.translate(-(e+a/2),-(t+l/2)),i&&o.rotate(-i),o.translate(-(e+a/2),-(t+l/2)),o.restore(),o.closePath()}drawHandlePoint([e,t],a,l){const{ctx:i}=this;i.beginPath(),i.save(),i.fillStyle="#fff",i.translate(a.x+a.width/2,a.y+a.height/2),a.rotate&&i.rotate(a.rotate),i.rect(e,t,l,l),i.translate(-(a.x+a.width/2),-(a.y+a.height/2)),a.rotate&&i.rotate(-a.rotate),i.stroke(),i.fill(),i.restore(),i.closePath()}drawHandleLine([e,t,a,l],i){const{ctx:n}=this;n.beginPath(),n.save(),n.fillStyle="#fff",n.translate(i.x+i.width/2,i.y+i.height/2),i.rotate&&n.rotate(i.rotate),n.rect(e,t,a,l),n.translate(-(i.x+i.width/2),-(i.y+i.height/2)),i.rotate&&n.rotate(-i.rotate),n.stroke(),n.fill(),n.restore(),n.closePath()}checkIsInHandleArea({x:e,y:t,width:a,height:l,rotate:i,type:n,tileType:s},o){const{zoomRatio:r,canvasDom:d,drawX:u,drawY:c,realWidth:h,realHeight:m}=this;e*=r,t*=r,e+=u,t+=c,a*=r,l*=r,"tile_xy"===s?(e=u,a=h*r,i=0):"tile_y"===s?(t=c,l=m*r,i=0):"tile_xy"===s&&(e=u,a=h*r,t=c,l=m*r,i=0);const v=10,p=10,g=[[-15-a/2,-15-l/2,"left-top"],[+a+5-a/2,-15-l/2,"right-top"],[+a+5-a/2,+l+5-l/2,"right-bottom"],[-15-a/2,+l+5-l/2,"left-bottom"]],y=[[0-a/2,-10-l/2,a,2,"top"],[a+5+5-a/2-1,0-l/2,2,l,"right"],[-10-a/2,0-l/2-1,2,l,"left"],[0-a/2,l+5+5-l/2,a,2,"bottom"]];let f=!1;if(f=this.checkIsInRotateArea({x:e,y:t,width:a,height:l,rotate:i},v,o),f||"texts"===n)return f;for(let w of g)if(f=this.checkIsInHandlePoint(w,{x:e,y:t,width:a,height:l,rotate:i},p,o),f)break;if(f)return f;for(let w of y)if(f=this.checkIsInHanleLine(w,{x:e,y:t,width:a,height:l,rotate:i},o),f)break;return f}checkIsInHandlePoint([e,t,a],l,i,{offsetX:n,offsetY:s}){const{ctx:o}=this;o.beginPath(),o.save(),o.fillStyle="#fff",o.translate(l.x+l.width/2,l.y+l.height/2),l.rotate&&o.rotate(l.rotate),o.rect(e,t,i,i),o.translate(-(l.x+l.width/2),-(l.y+l.height/2)),l.rotate&&o.rotate(-l.rotate);let r=!!o.isPointInPath(n,s)&&a;return o.restore(),o.closePath(),r}checkIsInHanleLine([e,t,a,l,i],n,{offsetX:s,offsetY:o}){const{ctx:r}=this;r.beginPath(),r.save(),r.fillStyle="#fff",r.translate(n.x+n.width/2,n.y+n.height/2),n.rotate&&r.rotate(n.rotate),r.rect(e,t,a,l),r.translate(-(n.x+n.width/2),-(n.y+n.height/2)),n.rotate&&r.rotate(-n.rotate);let d=!!r.isPointInPath(s,o)&&i;return r.restore(),r.closePath(),d}checkIsInRotateArea({x:e,y:t,width:a,height:l,rotate:i},n,{offsetX:s,offsetY:o}){const{ctx:r}=this;r.beginPath(),r.save(),r.translate(e+a/2,t+l/2),i&&r.rotate(i),r.rect(-10,-l/2-2*n-20,20,20),r.translate(-(e+a/2),-(t+l/2)),i&&r.rotate(-i),r.translate(-(e+a/2),-(t+l/2)),r.restore();let d=!!r.isPointInPath(s,o)&&"rotate";return r.closePath(),d}getData(){return{name:this.name,realWidth:this.realWidth,realHeight:this.realHeight,drawType:this.drawType,points:this.points,template_level:this.template_level,template_filter:this.template_filter,hue:this.hue,edgeFeather:this.edgeFeather}}getRealCanvas(){this.zoomRatio=1}setViewType(e){this.viewType=e,"editor"===e&&(this.resize(),this.reDraw())}getTextWidth({content:e,fontFamily:t,font_size:a}){const{ctx:l}=this;l.beginPath(),l.save(),l.font=`${a}px ${t}`;var i=l.measureText(e).width;return l.restore(),l.closePath(),i}drawMeshLine(){const{canvasDom:e,zoomRatio:t}=this,{width:a,height:l}=e,{outerWidth:i}=ct,n=Math.ceil(a/t/i),s=Math.ceil(l/t/i),o={x:new Array(n),y:new Array(s)};this.drawMeshLineItem(o)}drawMeshLineItem(e){const{ctx:t,canvasDom:a,zoomRatio:l}=this,{outerWidth:i}=ct,{width:n,height:s}=a,{x:o,y:r}=e;for(let d=0;d<o.length;d++)t.beginPath(),t.save(),t.strokeStyle="#e0e0e0",t.moveTo(d*i*l,0),t.lineTo(d*i*l,s),t.stroke(),t.restore(),t.closePath(),this.drawMeshMin(d*i*l,0,0);for(let d=0;d<r.length;d++)t.beginPath(),t.save(),t.strokeStyle="#e0e0e0",t.moveTo(0,d*i*l),t.lineTo(n,d*i*l),t.stroke(),t.restore(),t.closePath(),this.drawMeshMin(0,d*i*l,1)}drawMeshMin(e,t,a=0){const{ctx:l,canvasDom:i,zoomRatio:n}=this,{width:s,height:o}=i,{innerWidth:r,outerWidth:d}=ct,u=Math.ceil(d/r);if(!(d*n<20))for(let c=0;c<u;c++)if(0!==c){switch(l.beginPath(),l.save(),l.strokeStyle="#e9e9e9",a){case 0:l.moveTo(e+c*r*n,0),l.lineTo(e+c*r*n,o);break;case 1:l.moveTo(0,t+c*r*n),l.lineTo(s,t+c*r*n)}l.stroke(),l.restore(),l.closePath()}}drawTileImage(e,t="tile_xy"){const{image:a}=e;if(!a)return void this.drawTileColor(e,t);const{zoomRatio:l,ctx:i,drawX:n,drawY:s,realWidth:o,realHeight:r}=this,{width:d,height:u}=a,c="tile_y"===t?1:Math.floor(o*l/d/l),h="tile_x"===t?1:Math.floor(r*l/u/l);let m=o*l/c,v=r*l/h;m="tile_y"===t?e.width*l:m,v="tile_x"===t?e.height*l:v;const p="tile_y"===t?e.x*l:0,g="tile_x"===t?e.y*l:0;i.beginPath();for(let y=0;y<c;y++)for(let e=0;e<h;e++)i.drawImage(a,n+p+y*m,s+g+e*v,m+1,v+1);i.closePath()}drawTileColor(e,t="tile_xy"){const a=e.color||[0,0,0,1],{canvasDom:l,zoomRatio:i,ctx:n,realWidth:s,realHeight:o,drawX:r,drawY:d}=this;let u=s*i,c=o*i;u="tile_y"===t?e.width*i:s*i,c="tile_x"===t?e.height*i:o*i;const h="tile_y"===t?e.x*i:0,m="tile_x"===t?e.y*i:0;n.beginPath(),n.save(),n.fillStyle=tt(a),n.fillRect(h+r,m+d,u,c),n.fill(),n.restore(),n.closePath()}}function mt(e){return/^data:image\/\w+;base64,/.test(e)}function vt(e){return new Promise((t=>{const a=function(e){const t=e.split("/")[e.split("/").length-1].split(".")[0];return`font-${t}`}(e);let l=document.getElementById(a)||document.createElement("style");if(l.id)return void t(a);l.id=a;const i=new u(a);l.innerText=`@font-face {\n      font-family: ${a};\n      src: url('${e}');\n    }`,document.head.appendChild(l),i.load().then((()=>{t(a)}),(e=>{}))}))}function pt(e){const t=document.createElement("canvas"),a=t.getContext("2d");return t.width=e.width,t.height=e.height,{canvas:t,ctx:a}}async function gt(e,t){const{canvas:a,ctx:l}=pt(e);l.drawImage(e,0,0);let i=l.getImageData(0,0,a.width,a.height),n=new ImageData(new Uint8ClampedArray(i.data),a.width,a.height),s=n.data;for(let o=0;o<s.length;o+=4){let e=(s[o]+s[o+1]+s[o+2])/3;s[o]=e,s[o+1]=e,s[o+2]=e}return function(e,t){let a=e.data;for(let l=0;l<a.length;l+=4){let e=3*a[l];a[l]=t[e],a[l+1]=t[e+1],a[l+2]=t[e+2]}}(n,function(e,t=256){let a=new Uint8ClampedArray(3*t);for(let l=0;l<t;l++){let i=Math.round(e[0]+(255-e[0])*(l/(t-1))),n=Math.round(e[1]+(255-e[1])*(l/(t-1))),s=Math.round(e[2]+(255-e[2])*(l/(t-1)));a[3*l]=i,a[3*l+1]=n,a[3*l+2]=s}return a}(t)),l.putImageData(n,0,0),a.toDataURL()}const yt=[[-1,0,1],[-2,0,2],[-1,0,1]],ft=[[-1,-2,-1],[0,0,0],[1,2,1]];function wt(e,t){const{data:a,width:l,height:i}=e,n=t.length,s=Math.floor(n/2),o=new Float32Array(l*i);for(let r=0;r<i;r++)for(let e=0;e<l;e++){let d=0;for(let o=0;o<n;o++)for(let u=0;u<n;u++){const n=r+o-s,c=e+u-s;n>=0&&n<i&&c>=0&&c<l&&(d+=a[n*l+c]*t[o][u])}o[r*l+e]=d}return{data:o,width:l,height:i}}const bt=(e,t=null,a=!0)=>{const l=(e=>{const{ctx:t}=pt(e);return t.drawImage(e,0,0),t.getImageData(0,0,e.width,e.height)})(e);if(!t&&a){const e=function(e){const t=e.data,a=e.width,l=e.height,i=new Uint8Array(a*l);for(let n=0;n<t.length;n+=4)i[n/4]=t[n+3];return{data:i,width:a,height:l}}(l),a=function(e,t){const{data:a,width:l,height:i}=e,{data:n}=t,s=new Float32Array(l*i);for(let o=0;o<s.length;o++)s[o]=Math.sqrt(a[o]**2+n[o]**2);return{data:s,width:l,height:i}}(wt(e,yt),wt(e,ft)),i=function(e,t){const{data:a,width:l,height:i}=e;let n=0;for(let r=0;r<a.length;r++)n=Math.max(a[r],n);const s=t*n,o=new Uint8Array(l*i);for(let r=0;r<a.length;r++)o[r]=a[r]>s?1:0;return{data:o,width:l,height:i}}(a,.1);t=function(e){const{data:t,width:a,height:l}=e,i=new Float32Array(a*l),n=[];for(let o=0;o<t.length;o++)1===t[o]?(i[o]=0,n.push(o)):i[o]=1/0;const s=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(;n.length>0;){const e=n.shift(),t=e%a,o=Math.floor(e/a);for(const r of s){const s=t+r.dx,d=o+r.dy;if(s>=0&&s<a&&d>=0&&d<l){const t=d*a+s,l=i[e]+1;l<i[t]&&(i[t]=l,n.push(t))}}}return{data:i,width:a,height:l}}(i)}return{imageData:l,transformedDistance:t}},xt={image:"u_plus_image",image_info:"u_plus_image_info",message:"u_plus_message",message_info:"u_plus_message_info",message_data:"u_plus_message_data"};const Dt=new class{constructor(){this.SQL_NAME="u_plus",this.DB_NAME_LIST=["u_plus_image","u_plus_image_info","u_plus_message","u_plus_message_info","u_plus_message_data"],this.db={},this.request=null,this.init()}init(){const{SQL_NAME:e,DB_NAME_LIST:t}=this;return new Promise(((a,l)=>{this.request=window.indexedDB.open(e,1),this.request.onerror=e=>{l(e)},this.request.onsuccess=e=>{a(e.target.result),this.db=e.target.result},this.request.onupgradeneeded=e=>{this.db=e.target.result,t.forEach((e=>{if(!this.db.objectStoreNames.contains(e)){this.db.createObjectStore(e,{keyPath:"uuid",unique:!0}).createIndex("content","content",{unique:!1})}}))}}))}async get(e,t){const a=xt[e];return new Promise(((e,l)=>{const i=this.db.transaction([a],"readonly").objectStore(a).get(t);i.onsuccess=function(){e(i.result)},i.onerror=l}))}async add(e,t){const a=xt[e],{uuid:l}=t;return new Promise(((e,i)=>{const n=this.db.transaction([a],"readwrite").objectStore(a).add({uuid:l,content:t});n.onsuccess=t=>{e(t.target.result)},n.onerror=i}))}async update(e,t){const a=xt[e],{uuid:l}=t;return new Promise(((e,i)=>{const n=this.db.transaction([a],"readwrite").objectStore(a).put({uuid:l,content:t});n.onsuccess=t=>{e(t.target.result)},n.onerror=i}))}async getAll(e){const t=xt[e];return new Promise(((e,a)=>{const l=this.db.transaction([t],"readonly"),i=l.objectStore(t),n=[];i.openCursor().onsuccess=function(t){const a=t.target.result;a?(n.push(a.value.content),a.continue()):e(n)},l.oncomplete=function(){},l.onerror=function(){}}))}};class kt{constructor(e,t,a=!0){this.uuid=e,this.image=null,this.handleImage=null,this.init(t,a),this.hasDB=!1}init(e){this.image=e,this.handleImage=e}async grayToColor(e=[255,0,0]){const t=await gt(this.image,e),a=await qe(t);return this.handleImage=a,a}async edgeFeather(e=0){const{uuid:t,image:a}=this;if(!a)return a;const l=await Dt.get("image",t);let i=null;if(l){const{content:e}=l;if(e.image!==a.src);else{const e=await Dt.get("image_info",t);e&&(i=e.content.transformedDistance)}}else;let{imageRes:n,transformedDistance:s}=await(async(e,t,a=null)=>{const l=new Worker(new URL("/assets/imageProcessor.worker-MA1ShGEa.js",import.meta.url));t+=.01;const i=bt(e,a),n=i.imageData;return a=i.transformedDistance,new Promise((e=>{l.postMessage({transformedDistance:a,originalImageData:n,spreadFactor:t}),l.onmessage=({data:t})=>{const{canvas:i,ctx:n}=pt(t),s=n,o=new ImageData(t.data,t.width,t.height);s.putImageData(o,0,0);const r=Je(i.toDataURL());e({imageRes:r,transformedDistance:a}),l.terminate()}}))})(this.handleImage,e,i);if(i=null,l){const{content:e}=l;e.image!==a.src&&(await Dt.update("image",{uuid:t,image:a.src}),await Dt.update("image_info",{uuid:t,transformedDistance:s}))}else await Dt.add("image",{uuid:t,image:a.src}),await Dt.add("image_info",{uuid:t,transformedDistance:s});return s=null,n}}const It=s(),Ct="layouts";function Tt(e,t,a,l=0,i=0){const n=[[-e/2,-t/2],[e/2,-t/2],[e/2,t/2],[-e/2,t/2]].map((([e,t])=>{const n=Math.cos(a),s=Math.sin(a);return[l+(e*n-t*s),i+(e*s+t*n)]}));let s=1/0,o=-1/0,r=1/0,d=-1/0;return n.forEach((([e,t])=>{s=Math.min(s,e),o=Math.max(o,e),r=Math.min(r,t),d=Math.max(d,t)})),{width:o-s,height:d-r}}function Et([e,t],[a,l]){return e>0&&e<a&&t>0&&t<l}const Lt=new class{constructor(){this.dataController=o(new _e),this.canvasController=o(new ht),this.generationController=o(new be),this.dataController.reDraw=this.reDraw.bind(this),this.canvasController.clearAllData=this.clearAllData.bind(this),this.canvasController.reDraw=this.reDraw.bind(this),this.canvasController.toDraw=this.toDraw.bind(this),this.canvasController.sendElement=this.sendElement.bind(this),this.canvasController.toSelectedElement=this.toSelectedElement.bind(this),this.canvasController.checkMove=this.checkMove.bind(this),this.canvasController.setElementMovingData=this.setElementMovingData.bind(this),this.canvasController.moveEnd=this.moveEnd.bind(this),this.canvasController.checkContextMenu=this.checkContextMenu.bind(this),this.canvasController.changeElementImage=this.changeElementImage.bind(this),this.canvasController.toImageGenerateView=this.toImageGenerateView.bind(this),this.canvasController.reGenerateElement=this.reGenerateElement.bind(this),this.canvasController.deleteElement=this.deleteElement.bind(this),this.canvasController.generateElement=this.generateElement.bind(this),this.canvasController.getLayerImage=this.getLayerImage.bind(this),this.canvasController.toTextEdit=this.toTextEdit.bind(this),this.canvasController.copyData=this.copyData.bind(this),this.canvasController.toElementSetting=this.toElementSetting.bind(this),this.movedElementUuid=null}save(e=0){return new Promise(((t,a)=>{const l=oe.currentRoute;if("/generateImage"===l.value.path&&!e)return void t();const i=P();this.getSaveData().then((({jsonFile:e,preview:n,code:s,message:o})=>{if(200===s){const s=new FormData;s.append("file",e),"/generateImage"===l.value.path||"/galleryUpdate"===l.value.path?this.saveOrUpdateArtWork(s,e.name.replace(".json",""),n).then((()=>{i.close()})).catch((e=>{450===e.code&&It.error("模板名称重复"),i.close(),a(e)})):this.saveOrUpdateTemplate(s,e.name.replace(".json",""),n).then((()=>{i.close(),t()})).catch((e=>{450===e.code&&It.error("模板名称重复"),i.close(),a(e)}))}else i.close(),It.error(o)}))}))}saveOrUpdateTemplate(e,t,i){const{templateId:n,template_level:s,template_filter:o,points:r}=this.canvasController;return new Promise(((d,u)=>{n?l(n,e,Ct,t,i,s,o,r).then((e=>{It.success("保存成功"),d()})):a(e,Ct,t,i,s,o,r).then((e=>{this.canvasController.templateId=e.info.template_id,It.success("保存成功"),d()})).catch((e=>{u(e)}))}))}saveOrUpdateArtWork(e,t,a){const{templateId:l,template_level:i,template_filter:n,points:s}=this.canvasController;return new Promise((o=>{"/generateImage"===oe.currentRoute.value.path?ElMessageBox.prompt("请输入作品名称","作品名称",{confirmButtonText:"确认",cancelButtonText:"取消"}).then((({value:t})=>{(function(e,t,a,l="normal",i="normal",n=1){return se.post(`/teai/upload_artwork?artwork_name=${t}&preview=${a}&artwork_filter=${i}&artwork_level=${l}&points=${n}`,e)})(e,t,a,i,n,s).then((e=>{It.success("保存成功"),o(),oe.replace({path:"/galleryUpdate",query:{file_name:t,artwork_id:e.info.artwork_id}})})).catch((e=>{reject(e)}))})).catch((()=>{It({type:"info",message:"取消保存"})})):function(e,t,a,l,i="normal",n="normal",s=1){return se.post(`/teai/update_artwork?artwork_id=${e}&artwork_name=${a}&preview=${l}&artwork_filter=${n}&artwork_level=${i}&points=${s}`,t)}(l,e,t,a,i,n,s).then((()=>{It.success("保存成功")})).catch((e=>{})),o()}))}async getSaveData(){const e=this.canvasController.getData(),t=this.dataController.getData(),a=JSON.parse(JSON.stringify(t));if(!e.name)return{code:500,message:"请设置文件名称后操作"};const l=r(),i=new Map;for(let r in a)for(let e in t[r])if("groups"!==r&&"texts"!==t[r][e].type&&(delete a[r][e].fontSetting,delete a[r][e].handleImage),"colors"!==r&&"texts"!==t[r][e].type&&delete a[r][e].color,"elements"===r&&(delete a[r][e].virtuallyElements,delete a[r][e].zIndex,delete a[r][e].children),t[r][e].image&&mt(t[r][e].image.src))if(i.get(t[r][e].image.src)){const l=i.get(t[r][e].image.src);await this.setImage(r,e,l),a[r][e].image=l}else{const l=$e(t[r][e].image.src,e),n=new FormData;n.append("file",l);const s=(await this.saveImage(e,n)).data;i.set([t[r][e].image.src,s]),await this.setImage(r,e,s),a[r][e].image=s}else t[r][e].image&&t[r][e].image.src?a[r][e].image=t[r][e].image.src:a[r][e].image=null;const n=$e(await this.getCanvasImage(),l),s=new FormData;s.append("file",n);const o=await this.saveImage(l,s),d={viewData:e,layerData:a};for(let r in t){const e=t[r];if("elements"===r)break;for(let t in e)Object.assign(d,{[t]:{prompts:e[t].prompts,statics:e[t].statics,colors:e[t].colors,texts:e[t].texts}})}return{jsonFile:Ke(d,e.name),preview:o.data,code:200}}saveImage(e,t){return new Promise((a=>{de(e,t).then((e=>{a(e)}))}))}setImage(e,t,a){return new Promise((l=>{const i=new Image;i.crossOrigin="Anonymous",i.onload=()=>{this.dataController[e][t].setData({image:i}),l()},i.onerror=()=>{l()},i.src=a}))}clearAllData(){this.dataController.clearAllData(),this.reDraw()}reDraw(e=null){const t=this.dataController.elements,a=this.dataController.groups,l=this.dataController.layers,i=new Set;Object.keys(t).forEach((e=>{this.recomputationPosition(t[e])})),Object.keys(a).forEach((e=>{a[e].children.forEach((e=>{l[e].children.forEach((e=>{t[e].isShow&&i.add(e)}))}))})),Object.keys(l).forEach((e=>{l[e].children.forEach((e=>{t[e].isShow&&i.add(e)}))}));let n=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&n.push(t)}))}))}else{this.dataController.findData("layer",t).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&n.push(t)}))}})),e&&(e.image=this.dataController.findData("layer",this.dataController.selectedMap.layer).image,n.push(e)),this.canvasController.clearAll(),n.forEach((e=>{this.drawItem(e)}));const s=this.dataController.selectedMap.element;if(t&&s&&t[s].isShow){this.canvasController.drawHandleArea(t[s]);const{virtuallyElements:e}=t[s];e&&e.length&&e.forEach((e=>{const[a,l]=e,{width:i,height:n,rotate:o,image:r,type:d,tileType:u}=t[s],c={x:a,y:l,width:i,height:n,rotate:o,image:r,type:d,tileType:u};this.canvasController.drawHandleArea(c)}))}this.canvasController.clearOther(),this.canvasController.ctx.globalCompositeOperation="destination-over",this.canvasController.drawMeshLine(),this.canvasController.ctx.globalCompositeOperation="source-over"}drawItem(e){const{virtuallyElements:t,type:a,color:l,tileType:i}=e;switch(a){case"colors":switch(i){case"tile_xy":case"tile_x":case"tile_y":this.canvasController.drawTileColor(e,i);break;default:this.canvasController.drawTileColor(e,"tile_xy")}break;case"texts":this.canvasController.drawTextItem(e),t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:i,height:n,rotate:s,fontSetting:o,type:r,tileType:d}=e,u={x:a,y:l,width:i,height:n,rotate:s,fontSetting:o,type:r,tileType:d};this.drawItem(u)}));break;case"statics":switch(i){case"tile_xy":case"tile_x":case"tile_y":this.canvasController.drawTileImage(e,i);break;default:this.canvasController.drawItem(e)}t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:i,height:n,rotate:s,image:o,type:r,tileType:d}=e,u={x:a,y:l,width:i,height:n,rotate:s,image:o,type:r,tileType:d};this.drawItem(u)}));break;default:this.canvasController.drawItem(e),t&&t.length&&t.forEach((t=>{const[a,l]=t,{width:i,height:n,rotate:s,image:o,type:r,tileType:d,handleImage:u,xOverturn:c,yOverturn:h,opacity:m}=e,v={x:a,y:l,width:i,height:n,rotate:s,image:o,type:r,tileType:d,handleImage:u,xOverturn:c,yOverturn:h,opacity:m};this.drawItem(v)}))}}sendElement(e){const t=this.dataController.selectedMap.layer,a=this.dataController.findData("layer",t),{type:l}=a;if("texts"===l){const t=JSON.parse(JSON.stringify(a.fontSetting)),l=Mt.getTextWidth(t);e=Object.assign(e,{x:e.x+e.width/2-l/2,y:e.y+e.height/2-t.font_size/2,width:l,height:t.font_size,fontSetting:t})}this.dataController.add("element",t,null,e),this.reDraw()}toDraw(e){const t=this.dataController.selectedMap.layer;if(!t)return void It.error("请在选中图层后操作");const a=this.dataController.findData("layer",t);a&&a.tileType||this.canvasController.startDraw(e)}checkClickIsIn(e,t=!0){const a=this.dataController.elements,l=this.dataController.groups,i=this.dataController.layers,n=this.dataController.findData("element",this.dataController.selectedMap.element);let s=null;if(n&&t){if(this.canvasController.checkIsInItem(n,e))return{handleType:"main",data:n};if(s=this.canvasController.checkIsInHandleArea(n,e),s)return{handleType:s,data:n};const{virtuallyElements:t}=n;if(t&&t.length)for(let a of t){const[t,l]=a,{width:i,height:o,rotate:r,image:d,type:u,tileType:c}=n,h={x:t,y:l,width:i,height:o,rotate:r,image:d,type:u,tileType:c};if(s=this.canvasController.checkIsInHandleArea(h,e),s)return{handleType:s,data:n}}}const o=new Set;Object.keys(l).forEach((e=>{l[e].children.forEach((e=>{i[e].children.forEach((e=>{a[e].isShow&&o.add(e)}))}))})),Object.keys(i).forEach((e=>{i[e].children.forEach((e=>{a[e].isShow&&o.add(e)}))}));let r=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&r.push(t)}))}))}else{this.dataController.findData("layer",t).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&r.push(t)}))}})),r=r.reverse();for(let d of r){const{virtuallyElements:t,type:a}=d,l=this.canvasController.checkIsInItem(d,e);if(t&&t.length)for(let i of t){const[t,a]=i,{width:l,height:n,rotate:o,image:r}=d,u={x:t,y:a,width:l,height:n,rotate:o,image:r};if(s=this.canvasController.checkIsInItem(u,e),s)return{handleType:"main",data:d}}if(l)return s="main",{handleType:s,data:d}}return{handleType:null,data:null}}toSelectedElement(e){const{data:t}=this.checkClickIsIn(e,!1);if(!t)return this.dataController.selectedMap={group:null,layer:null,element:null},void this.reDraw();const a=this.dataController.findData("layer",t.parentUuid),l=a?this.dataController.findData("group",a.parentUuid):null,i=[l?l.uuid:null,a.uuid||null,t.uuid];this.dataController.changeSelected(i),this.reDraw()}checkMove(e){const t=this.checkClickIsIn(e),a=t.data,l=t.handleType;a&&a.uuid===this.dataController.selectedMap.element&&(this.movedElementUuid=a.uuid,this.canvasController.startMove(e,l))}checkContextMenu(e,t=!1){const a=this.checkClickIsIn(e),l=a.data;if(!l)return;const i=a.handleType,n=l.uuid,s=l.parentUuid,o=this.dataController.findData("layer",s).parentUuid||null;this.dataController.changeSelected([o,s,n]),l&&"main"===i&&(t?"texts"!==l.type&&"prompts"!==l.type||this.canvasController.contextMenu(e,l,l.type):this.canvasController.contextMenu(e,l))}setElementMovingData({xFloat:e,yFloat:t,rotateFloat:a,moveType:l},i){const n=this.dataController.elements[this.movedElementUuid],s=n.rotate,o=Math.cos(-s),r=Math.sin(-s);let{width:d,height:u}=n,c=e*o-e*r,h=e*r+t*o;switch(d=Math.round(100*d)/100,u=Math.round(100*u)/100,c=Math.round(100*c)/100,h=Math.round(100*h)/100,l){case"main":this.mainMove(n,e,t);break;case"left-top":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100}this.leftTopMove(n,c,h);break;case"top":if(i){let e=d/u;e=Math.round(100*e)/100,c=h*e,c=Math.round(100*c)/100,c=-c}else c=0;this.rightTopMove(n,c,h);break;case"right-top":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}this.rightTopMove(n,c,h);break;case"right":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*c)/100}else h=0;this.rightBottomMove(n,c,h);break;case"right-bottom":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100}this.rightBottomMove(n,c,h);break;case"bottom":if(i){let e=d/u;e=Math.round(100*e)/100,c=h*e,c=Math.round(100*c)/100}else c=0;this.rightBottomMove(n,c,h);break;case"left-bottom":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}this.leftBottomMove(n,c,h);break;case"left":if(i){let e=d/u;e=Math.round(100*e)/100,h=c/e,h=Math.round(100*h)/100,h=-h}else h=0;this.leftBottomMove(n,c,h);break;case"rotate":this.rotateMove(n,e,t,a)}this.reDraw()}moveEnd(){this.movedElementUuid=null}mainMove(e,t,a){e.setData({x:e.x+t,y:e.y+a}),this.recomputationPosition(e)}leftTopMove(e,t,a){let{width:l,height:i,x:n,y:s}=e;l-t<0||(l-=t,i-=a/2,n+=t,s+=a/2),i-a<0||(i-=a/2,s+=a/2),e.setData({x:n,y:s,width:l,height:i})}topMove(e,t,a){let{height:l,y:i}=e;l-a<0||(l-=a,i+=a),e.setData({y:i,height:l})}rightTopMove(e,t,a){let{width:l,height:i,y:n}=e;l+t<0||(l+=t),i-a<0||(i-=a,n+=a),e.setData({width:l,height:i,y:n})}rightMove(e,t,a){let{width:l}=e;l+t<0||(l+=t),e.setData({width:l})}rightBottomMove(e,t,a){let{width:l,height:i}=e;l+t<0||(l+=t),i+a<0||(i+=a),e.setData({width:l,height:i})}bottomMove(e,t,a){let{height:l}=e;l+a<0||(l+=a),e.setData({height:l})}leftBottomMove(e,t,a){let{width:l,height:i,x:n}=e;l-t<0||(l-=t,n+=t),i+a<0||(i+=a),e.setData({width:l,height:i,x:n})}leftMove(e,t,a){let{width:l,x:i}=e;l-t<0||(l-=t,i+=t),e.setData({x:i,width:l})}rotateMove(e,t,a,l){const{x:i,y:n,width:s,height:o,rotate:r}=e;let d=function([e,t],[a,l],[i,n]){const s=a-e,o=l-t,r=i-e,d=n-t;let u=(s*r+o*d)/(Math.sqrt(s*s+o*o)*Math.sqrt(r*r+d*d));if(isNaN(u))return 0;let c=Math.acos(u);return s*d-o*r<0&&(c=-c),isNaN(c)?Math.PI/1800:Number(c.toFixed(2))}([i+s/2,n+o/2],l,[l[0]+t,l[1]+a]);e.setData({rotate:r+d})}recomputationPosition(e){const{drawType:t}=this.canvasController,{realWidth:a,realHeight:l}=this.canvasController;switch(t){case ot:e.virtuallyElements=[],this.recomputationMainPosition(a,l,e);break;case rt:e.virtuallyElements=[],this.recomputationAgentXPosition(width,e),this.recomputationMainPosition(a,l,e);break;case dt:e.virtuallyElements=[],this.recomputationAgentYPosition(height,e),this.recomputationMainPosition(a,l,e);break;case ut:e.virtuallyElements=[],this.recomputationAgentFPosition(a,l,e),this.recomputationMainPosition(a,l,e)}}recomputationMainPosition(e,t,a){const{virtuallyElements:l,x:i,y:n,width:s,height:o}=a;let r=JSON.parse(JSON.stringify(l));r.length&&(Et([i+s/2,n+o/2],[e,t])||r.forEach(((l,d)=>{const[u,c]=l;Et([u+s/2,c+o/2],[e,t])&&(r[d]=[i,n],a.setData({x:u,y:c,virtuallyElements:r}))})))}recomputationAgentXPosition(e,t){const{x:a,y:l,virtuallyElements:i,width:n,height:s,rotate:o}=t;let r=n;o&&(r=Tt(n,s,o).width),a+n/2+r/2>e?i.push([a-e,l]):a+n/2-r/2<0&&i.push([e+a,l]),t.setData({virtuallyElements:i})}recomputationAgentYPosition(e,t){const{x:a,y:l,virtuallyElements:i,width:n,height:s,rotate:o}=t;let r=s;o&&(r=Tt(n,s,o).height),l+s/2+r/2>e?i.push([a,l-e]):l+s/2-r/2<0&&i.push([a,e+l]),t.setData({virtuallyElements:i})}recomputationAgentFPosition(e,t,a){this.recomputationAgentXPosition(e,a),this.recomputationAgentYPosition(t,a);const{virtuallyElements:l,x:i,drawY:n,width:s,height:o}=a;2===l.length&&(i===l[0][0]?l.push([l[1][0],l[0][1]]):l.push([l[0][0],l[1][1]])),a.setData({virtuallyElements:l})}deleteElement(e){this.dataController.delete("element",e),this.reDraw()}reGenerateElement(e){}toImageGenerateView(e){}toElementSetting(e){this.toElementSetting(e)}async changeElementImage(e,t){const a=this.dataController.findData("element",e);let l=new kt(e,t,Boolean(a.edgeFeather)),i=null;a.hue&&Array.isArray(a.hue)&&(i=await l.grayToColor(a.hue)),a.edgeFeather&&(i=await l.edgeFeather(a.edgeFeather/100)),l=null,this.dataController.elements[e].setData({image:t,handleImage:i}),this.reDraw()}async getCanvasImage(){await this.canvasController.resize();const{zoomRatio:e,realWidth:t,realHeight:a,drawX:l,drawY:i}=this.canvasController;this.reDraw();const n=this.dataController.elements,s=this.dataController.groups,o=this.dataController.layers,r=new Set;Object.keys(n).forEach((e=>{this.recomputationPosition(n[e])})),Object.keys(s).forEach((e=>{s[e].children.forEach((e=>{o[e].children.forEach((e=>{n[e].isShow&&r.add(e)}))}))})),Object.keys(o).forEach((e=>{o[e].children.forEach((e=>{n[e].isShow&&r.add(e)}))}));let d=[];this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{this.dataController.findData("layer",e).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&d.push(t)}))}))}else{this.dataController.findData("layer",t).children.forEach((e=>{const t=this.dataController.findData("element",e);t.isShow&&d.push(t)}))}})),this.canvasController.clearAll(),d.forEach((e=>{this.drawItem(e)}));const u=t*e,c=a*e,h=this.canvasController.ctx.getImageData(l,i,u,c),{canvas:m,ctx:v}=pt({width:u,height:c});v.putImageData(h,0,0);const p=m.toDataURL("image/png");return this.canvasController.resize().then((()=>{this.reDraw()})),p}async generateAll(){const e=P(),t=Object.keys(this.dataController.groups).map((e=>this.dataController.groups[e])),a=this.dataController.layers,l=Object.keys(a).filter((e=>!this.dataController.layers[e].parentUuid)).map((e=>this.dataController.layers[e])),i=[];if(!t.length&&!l.length)return e.close(),void It.error("请在添加图层后生成");if(t.length&&t.forEach((e=>{i.push({type:"Group",name:e.name,generateUuid:e.uuid,children:e.children,uuid:e.uuid})})),l.length){for(let e of l)i.push({type:"Layer",name:e.name,generateUuid:e.uuid,uuid:e.uuid});const{templateId:t,name:a}=this.canvasController;Ce.addTask(t,a,"All",i),e.close(),It.success("生成任务已提交")}}async setGroupGenerateResult(e){const t=Object.keys(e);for(let a=0;a<t.length;a++)await this.setLayerGenerateResult({[t[a]]:e[t[a]]})}async setLayerGenerateResult(e){const t=Object.keys(e);for(let a=0;a<t.length;a++){const l=this.dataController.findData("layer",t[a]),{type:i}=l;if(!e[t[a]])break;switch(i){case"texts":await this.setResultText(l,e[t[a]].task_result);break;case"colors":this.setResultColor(l,e[t[a]].task_result);break;default:await this.setResultImage(l,e[t[a]].task_result)}}this.reDraw()}async setElemenyGenerateResult(e,t){const a=Object.keys(e);for(let l=0;l<a.length;l++){const i=this.dataController.findData("element",t),{type:n}=i;switch(n){case"texts":const n=e[a[l]].task_result,s=await vt(n.font);n.fontFamily=s;const o={fontSetting:n,width:this.canvasController.getTextWidth(n),height:n.font_size};i.setData(o);break;case"colors":i.setData({color:e[a[l]].task_result});break;default:const r=await qe(e[a[l]].task_result);if(i.setData({image:r}),i.hue&&Array.isArray(i.hue)){const e=new kt(t,r),a=await e.grayToColor(i.hue);i.setData({handleImage:a})}}}this.reDraw()}async setResultImage(e,t){const{uuid:a}=e,l=await qe(t);this.dataController.layers[a].setData({image:l});for(let i=0;i<e.children.length;i++){const t=e.children[i],a=this.dataController.findData("element",t);if(a.setData({image:l}),a.hue&&Array.isArray(a.hue)){const e=new kt(t,l),i=await e.grayToColor(a.hue);a.setData({handleImage:i})}}}async setResultText(e,t){const a=t,l=await vt(a.font);a.fontFamily=l,e.setData({fontSetting:a}),e.children.forEach((e=>{const t=this.dataController.elements[e],l={fontSetting:a,width:this.canvasController.getTextWidth(a),height:a.font_size};t.setData(l)}))}setResultColor(e,t){e.children.forEach((e=>{this.dataController.elements[e].setData({color:t})}))}async generateGroup(e){await this.save();const t=P(),a=this.dataController.findData("group",e),l=[];l.push({type:"Group",name:a.name,generateUuid:a.uuid,uuid:a.uuid,children:a.children});const{templateId:i,name:n}=this.canvasController;Ce.addTask(i,n,"Group",l),this.reDraw(),t.close()}async generateLayer(e){await this.save();const t=P(),a=this.dataController.findData("layer",e),l=[];l.push({type:"Layer",name:a.name,generateUuid:a.uuid,uuid:a.uuid});const{templateId:i,name:n}=this.canvasController;Ce.addTask(i,n,"Layer",l),this.reDraw(),t.close()}async generateElement(e){await this.save();const t=this.dataController.findData("element",e),a=this.dataController.findData("layer",t.parentUuid),l=P(),i=[];i.push({type:"Element",name:t.name,generateUuid:a.uuid,uuid:t.uuid});const{templateId:n,name:s}=this.canvasController;Ce.addTask(n,s,"Element",i),this.reDraw(),l.close()}toImageGenerateView(e,t){const a=this.dataController.findData("element",e),{image:l,uuid:i}=a;this.toImageGenerateView({image:l.src,uuid:i},t)}async getLayerImage(e=!1){await this.canvasController.resize();const{zoomRatio:t,realWidth:a,realHeight:l,drawX:i,drawY:n}=this.canvasController;this.reDraw(),e&&this.canvasController.getRealCanvas();const s=this.dataController.elements,o=this.dataController.groups,r=this.dataController.layers,d=new Set;Object.keys(s).forEach((e=>{this.recomputationPosition(s[e])})),Object.keys(o).forEach((e=>{o[e].children.forEach((e=>{r[e].isShow&&d.add(e)}))})),Object.keys(r).forEach((e=>{r[e].children.forEach((t=>{r[e].isShow&&d.add(e)}))}));const u=[];let c=[];return this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{const t=this.dataController.findData("layer",e);t.isShow&&c.push(t)}))}else{const e=this.dataController.findData("layer",t);if(!e.isShow)return;c.push(e)}})),c.forEach((e=>{this.canvasController.clearAll(),e.children.forEach((e=>{const t=s[e];this.drawItem(t)}));const o=a*t,r=l*t,d=this.canvasController.ctx.getImageData(i,n,o,r),{canvas:c,ctx:h}=pt({width:o,height:r});h.putImageData(d,0,0),u.push({name:e.name,uuid:e.uuid,image:c.toDataURL("image/png")})})),"editor"===this.canvasController.viewType&&await this.canvasController.resize(),this.reDraw(),u.reverse()}async getAllImage(){this.canvasController.getRealCanvas();const{zoomRatio:e,realWidth:t,realHeight:a,drawX:l,drawY:i,canvasDom:n}=this.canvasController;this.reDraw();const s=Math.floor(Math.min(n.width,n.height)),o=this.dataController.elements,r=this.dataController.groups,d=this.dataController.layers,u=new Set;Object.keys(o).forEach((e=>{this.recomputationPosition(o[e])})),Object.keys(r).forEach((e=>{r[e].children.forEach((e=>{d[e].isShow&&u.add(e)}))})),Object.keys(d).forEach((e=>{d[e].children.forEach((t=>{d[e].isShow&&u.add(e)}))}));const c=[];let h=[];return this.dataController.getAllList().forEach((({type:e,uuid:t})=>{if("group"===e){const e=this.dataController.findData("group",t),a=[];e.children.forEach((e=>{const t=this.dataController.findData("layer",e);a[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}})),a.forEach((({uuid:e})=>{const t=this.dataController.findData("layer",e);t.isShow&&h.push(t)}))}else{const e=this.dataController.findData("layer",t);if(!e.isShow)return;h.push(e)}})),h.forEach((e=>{const l=[];for(let i=0;i<Math.ceil(t/s);i++){this.canvasController.drawX=-i*s,l[i]=[];let n=s;s*(i+1)>t&&(n=t%s);for(let t=0;t<Math.ceil(a/s);t++){this.canvasController.drawY=-t*s;let r=s;s*(t+1)>a&&(r=a%s),this.canvasController.clearAll(),e.children.forEach((e=>{const t=o[e];this.drawItem(t)}));const d=this.canvasController.ctx.getImageData(0,0,n,r),{canvas:u,ctx:c}=pt({width:n,height:r});c.putImageData(d,0,0),l[i].push(u.toDataURL("image/png"))}}c.push({name:e.name,uuid:e.uuid,image:l})})),await this.canvasController.resize(),this.reDraw(),c.reverse()}toTextEdit(e,t="text"){const a=this.dataController.findData("element",e);this.toTextEditView(a,t)}copyData(e){this.dataController.copyData(e,"element")}},_t=o(Lt.dataController),Mt=o(Lt.canvasController),St=o(Lt.generationController),At={class:"element-item"},zt=["title"],Ot={class:"element-handle-area"},Rt=G({__name:"elementLayers",props:{data:{},editorType:{},editorLayersDom:{},groupUuid:{default:null},layerUuid:{default:null}},emits:["toLayerInfo"],setup(e,{emit:t}){const a=c(_t),l=c(Lt),i=c(Mt),n=e,s=t,o=(...e)=>{s("toLayerInfo",...e)};return(t,r)=>(h(),m("div",At,[v("div",{class:g(["element-title",{selected:a.value.isSelected("element",n.data.uuid)}]),onContextmenu:r[3]||(r[3]=e=>((e,t,l)=>{const s=a.value.findData(e,t),{pageX:r,pageY:d}=l;i.value.handleController.setHandle(s,{x:r,y:d},e,Boolean(s.image),n.editorLayersDom).then((l=>{const{name:n}=l;switch(e){case"element":i.value.contextmenuCallBack(l);break;case"layer":switch(n){case He:a.value.delete(e,t);break;case Ge:o(s);break;case Xe:a.value.copyData(t,e)}break;case"group":switch(n){case Ye:a.value.delete(e,t);break;case We:a.value.copyData(t,e)}}}))})("element",n.data.uuid,e)),onClick:r[4]||(r[4]=e=>a.value.changeSelected([n.groupUuid,n.layerUuid,n.data.uuid]))},[v("div",{class:"element-name",title:a.value.elements[n.data.uuid].name},p(a.value.elements[n.data.uuid].name),9,zt),v("div",Ot,["gallery"!==e.editorType?(h(),m("div",{key:0,class:g(["pointer icon bi",y(F)]),onClick:r[0]||(r[0]=f((e=>((...e)=>{l.value.generateElement(...e)})(n.data.uuid)),["stop"]))},null,2)):w("",!0),v("div",{class:g(["pointer icon bi",a.value.elements[n.data.uuid].isShow?y(W):y(B)]),onClick:r[1]||(r[1]=f((()=>{a.value.handleIsShow("element",n.data.uuid,a.value.elements[n.data.uuid].isShow?"hide":"show"),s("setDiagramImage")}),["stop"]))},null,2),"edit"===n.editorType?(h(),m("div",{key:1,class:g(["pointer icon bi",y($)]),onClick:r[2]||(r[2]=f((e=>a.value.delete("element",n.data.uuid)),["stop"]))},null,2)):w("",!0)])],34)]))}},[["__scopeId","data-v-d056df0d"]]),Ut={class:"layer-list"},Pt=["id"],Gt=["title"],jt={class:"layer-handle-area"},Nt=G({__name:"layerLayers",props:{data:{},editorType:{},editorLayersDom:{},groupUuid:{default:null},isLast:{},dropType:{default:"layer"}},emits:["toLayerInfo","setChildLength"],setup(e,{emit:t}){const a=c(_t),l=c(Lt),i=c(Mt),n=c(!1),s=c(null),o=e,r=c(!1),d=c(!1),u=t,C=()=>{const{uuid:e}=o.data;if(!e)return[];const t=a.value.findData("layer",e),l=[];t.children.forEach((e=>{const t=a.value.findData("element",e);l[t.zIndex-1]={name:t.name,uuid:t.uuid,zIndex:t.zIndex}}));for(let a=0;a<l.length;a++)if(!l[a])return[];return u("setChildLength",{uuid:o.data.uuid,length:T(l)}),l},T=e=>a.value.isShowMapShow("layer",o.data.uuid)?e.length:0,E=(...e)=>{u("toLayerInfo",...e)},L=(e,t,l,i=null)=>{l.preventDefault(),r.value=!1,d.value=!1,n.value=!1,window.dragDomId=null;const s=JSON.parse(l.dataTransfer.getData("text/plain")),o={uuid:e,type:t};a.value.bindGroup({fromData:s,toData:o,zIndex:i})};return(t,c)=>(h(),m("div",Ut,[v("div",{class:g(["drop-to-line",{droped:r.value}]),onDragover:c[0]||(c[0]=f((e=>r.value=!0),["prevent"])),onDragleave:c[1]||(c[1]=f((e=>r.value=!1),["prevent"])),onDrop:c[2]||(c[2]=f((e=>L(o.data.uuid,o.data.type,e,o.data.zIndex)),["stop"]))},null,34),v("div",{class:g(["layer-title",{selected:a.value.isSelected("layer",o.data.uuid)&&!n.value,dropover:n.value}]),ref_key:"dropOverDom",ref:s,id:`${o.data.type}_${o.data.uuid}`,onClick:c[7]||(c[7]=e=>a.value.changeSelected([o.groupUuid,o.data.uuid,null])),onDragover:c[8]||(c[8]=f((e=>(o.data.uuid,o.data.type,void(s.value.id!==window.dragDomId&&(n.value=!0)))),["prevent"])),onDragleave:c[9]||(c[9]=f((e=>n.value=!1),["prevent"])),onContextmenu:c[10]||(c[10]=e=>((e,t,l)=>{const n=a.value.findData(e,t),{pageX:s,pageY:r}=l;i.value.handleController.setHandle(n,{x:s,y:r},e,Boolean(n.image),o.editorLayersDom).then((l=>{const{name:s}=l;switch(e){case"element":i.value.contextmenuCallBack(l);break;case"layer":switch(s){case He:a.value.delete(e,t);break;case Ge:E(n);break;case Xe:a.value.copyData(t,e)}break;case"group":switch(s){case Ye:a.value.delete(e,t);break;case We:a.value.copyData(t,e)}}}))})("layer",o.data.uuid,e)),onDrop:c[11]||(c[11]=f((e=>L(o.data.uuid,o.data.type,e)),["stop"])),draggable:"true",onDragstart:c[12]||(c[12]=e=>{return t=o.data.uuid,a=o.data.type,l=e,window.dragDomId=s.value.id,void l.dataTransfer.setData("text/plain",JSON.stringify({uuid:t,type:a}));var t,a,l})},[v("div",{class:"layer-name",title:a.value.layers[o.data.uuid].name},[v("div",{class:g(["icon bi",`${y(Z)} ${a.value.isShowMapShow("layer",o.data.uuid)?"selected":""}`]),onClick:c[3]||(c[3]=f((()=>{a.value.handleShowMap("layer",o.data.uuid)}),["stop"]))},null,2),b(" "+p(a.value.layers[o.data.uuid].name),1)],8,Gt),v("div",jt,["gallery"!==e.editorType?(h(),m("div",{key:0,class:g(["pointer icon bi",y(F)]),onClick:c[4]||(c[4]=f((e=>((...e)=>{l.value.generateLayer(...e)})(o.data.uuid)),["stop"]))},null,2)):w("",!0),v("div",{class:g(["pointer icon bi",a.value.layers[o.data.uuid].isShow?y(W):y(B)]),onClick:c[5]||(c[5]=f((()=>{a.value.handleIsShow("layer",o.data.uuid,a.value.layers[o.data.uuid].isShow?"hide":"show"),u("setDiagramImage")}),["stop"]))},null,2),"edit"===o.editorType?(h(),m("div",{key:1,class:g(["pointer icon bi",y($)]),onClick:c[6]||(c[6]=f((e=>a.value.delete("layer",o.data.uuid)),["stop"]))},null,2)):w("",!0)])],42,Pt),v("div",{class:"child-list",style:I({maxHeight:a.value.isShowMapShow("layer",o.data.uuid)?1.1*C().length+"rem":"0rem"})},[(h(!0),m(x,null,D(C(),(e=>(h(),k(Rt,{layerUuid:o.data.uuid,groupUuid:o.groupUuid,onToLayerInfo:E,editorType:o.editorType,editorLayersDom:o.editorLayersDom,data:e,key:e.uuid},null,8,["layerUuid","groupUuid","editorType","editorLayersDom","data"])))),128))],4),o.isLast?(h(),m("div",{key:0,class:g(["drop-to-line",{droped:d.value}]),onDragover:c[13]||(c[13]=f((e=>d.value=!0),["prevent"])),onDragleave:c[14]||(c[14]=f((e=>d.value=!1),["prevent"])),onDrop:c[15]||(c[15]=f((e=>L(o.data.uuid,o.data.type,e,0)),["stop"]))},null,34)):w("",!0)]))}},[["__scopeId","data-v-e8dcd246"]]),Vt={class:"group-list"},Ht=["id"],Yt=["title"],Ft={class:"group-handle-area"},Xt=G({__name:"groupLayers",props:{data:{},editorType:{},editorLayersDom:{},isLast:{}},emits:["toLayerInfo"],setup(e,{emit:t}){const a=c(_t),l=c(Lt),i=c(Mt),n=c(!1),s=c(!1),o=e,r=c(new Map),d=c(!1),u=c(null),C=t,T=()=>{const{uuid:e}=o.data;if(!e)return[];const t=a.value.findData("group",e),l=[];return t.children.forEach((e=>{const t=a.value.findData("layer",e);l[t.zIndex-1]={type:"layer",uuid:t.uuid,zIndex:t.zIndex}})),l},E=({uuid:e,length:t})=>{r.value.set(e,t)},L=e=>{if(!a.value.isShowMapShow("group",o.data.uuid))return 0;let t=e.length;for(let[a,l]of r.value)t+=l;return t},_=(e,t,l,i=null)=>{l.preventDefault(),n.value=!1,s.value=!1,d.value=!1,window.dragDomId=null;const o=JSON.parse(l.dataTransfer.getData("text/plain")),r={uuid:e,type:t};a.value.bindGroup({fromData:o,toData:r,zIndex:i})},M=(...e)=>{C("toLayerInfo",...e)};return(t,r)=>(h(),m("div",Vt,[v("div",{class:g(["drop-to-line",{droped:n.value}]),onDragover:r[0]||(r[0]=f((e=>n.value=!0),["prevent"])),onDragleave:r[1]||(r[1]=f((e=>n.value=!1),["prevent"])),onDrop:r[2]||(r[2]=f((e=>_(o.data.uuid,o.data.type,e,o.data.zIndex)),["stop"]))},null,34),v("div",{class:g(["group-title",{selected:a.value.isSelected("group",o.data.uuid)&&!d.value,dropover:d.value}]),ref_key:"dropOverDom",ref:u,id:`${o.data.type}_${o.data.uuid}`,onDragover:r[7]||(r[7]=f((e=>(o.data.uuid,o.data.type,void(u.value.id!==window.dragDomId&&(d.value=!0)))),["prevent"])),onDragleave:r[8]||(r[8]=f((e=>d.value=!1),["prevent"])),onContextmenu:r[9]||(r[9]=e=>((e,t,l)=>{const n=a.value.findData(e,t),{pageX:s,pageY:r}=l;i.value.handleController.setHandle(n,{x:s,y:r},e,Boolean(n.image),o.editorLayersDom).then((l=>{const{name:s}=l;switch(e){case"element":i.value.contextmenuCallBack(l);break;case"layer":switch(s){case He:a.value.delete(e,t);break;case Ge:M(n);break;case Xe:a.value.copyData(t,e)}break;case"group":switch(s){case Ye:a.value.delete(e,t);break;case We:a.value.copyData(t,e)}}}))})("group",o.data.uuid,e)),onDrop:r[10]||(r[10]=f((e=>_(o.data.uuid,"group",e)),["stop"])),onClick:r[11]||(r[11]=e=>a.value.changeSelected([o.data.uuid,null,null])),draggable:"true",onDragstart:r[12]||(r[12]=e=>{return t=o.data.uuid,a=o.data.type,l=e,window.dragDomId=u.value.id,void l.dataTransfer.setData("text/plain",JSON.stringify({uuid:t,type:a}));var t,a,l})},[v("div",{class:"group-name",title:a.value.groups[o.data.uuid].name},[v("div",{class:g(["icon bi",`${y(Z)} ${a.value.isShowMapShow("group",o.data.uuid)?"selected":""}`]),onClick:r[3]||(r[3]=f((()=>{a.value.handleShowMap("group",o.data.uuid)}),["stop"]))},null,2),b(" "+p(a.value.groups[o.data.uuid].name),1)],8,Yt),v("div",Ft,["gallery"!==e.editorType?(h(),m("div",{key:0,class:g(["pointer icon bi",y(F)]),onClick:r[4]||(r[4]=f((e=>((...e)=>{l.value.generateGroup(...e)})(o.data.uuid)),["stop"]))},null,2)):w("",!0),v("div",{class:g(["pointer icon bi",a.value.groups[o.data.uuid].isShow?y(W):y(B)]),onClick:r[5]||(r[5]=f((()=>{a.value.handleIsShow("group",o.data.uuid,a.value.groups[o.data.uuid].isShow?"hide":"show"),C("setDiagramImage")}),["stop"]))},null,2),"edit"===o.editorType?(h(),m("div",{key:1,class:g(["pointer icon bi",y($)]),onClick:r[6]||(r[6]=f((e=>a.value.delete("group",o.data.uuid)),["stop"]))},null,2)):w("",!0)])],42,Ht),v("div",{class:"child-list",style:I({maxHeight:1.1*L(T())+"rem"})},[(h(!0),m(x,null,D(T(),((e,t)=>(h(),k(Nt,{groupUuid:o.data.uuid,onToLayerInfo:M,onSetChildLength:E,editorType:o.editorType,editorLayersDom:o.editorLayersDom,isLast:t===T().length-1,data:e,key:t},null,8,["groupUuid","editorType","editorLayersDom","isLast","data"])))),128))],4),o.isLast?(h(),m("div",{key:0,class:g(["drop-to-line",{droped:s.value}]),onDragover:r[13]||(r[13]=f((e=>s.value=!0),["prevent"])),onDragleave:r[14]||(r[14]=f((e=>s.value=!1),["prevent"])),onDrop:r[15]||(r[15]=f((e=>_(o.data.uuid,o.data.type,e,0)),["stop"]))},null,34)):w("",!0)]))}},[["__scopeId","data-v-3585483b"]]),Wt={class:"editor-layers-title"},Bt=G({__name:"editorLayers",props:{viewType:{type:String,default:"编辑器"},typeList:{type:Array,default:()=>[]},groupList:{type:Array,default:()=>[]},editorType:{}},emits:["toLayerInfo","setSelectedLayer","deleteGroup","deleteLayer","deleteElement","setGroup","hideLayer","reGenerateGroup","reGenerateLayer","reGenerateElement","setDiagramImage"],setup(e,{expose:t,emit:a}){const l=c(_t);c(Lt),c(Mt);const i=e,n=a,s=c(null),o=(...e)=>{n("toLayerInfo",...e)};return t({setSelectedElement:e=>{const t=i.typeList.find((t=>new Set(Object.keys(t.layerInfo)).has(e))),a=t?t.uuid:null,l=i.groupList.find((e=>new Set(e.layers).has(a))),n=l?l.uuid:null;selectedElement(e,a,n)}}),(t,a)=>{const n=C("el-scrollbar");return h(),m("div",{class:"editor-layers",ref_key:"editorLayersDom",ref:s},[v("div",Wt,[a[3]||(a[3]=v("div",{class:"title-name"},[v("i",{class:"bi bi-layers"}),b(" 图层 ")],-1)),"generate"!==e.editorType&&"gallery"!==e.editorType?(h(),m("i",{key:0,class:g(["pointer icon bi",y(J)]),onClick:a[0]||(a[0]=e=>o())},null,2)):w("",!0)]),v("div",{class:"list-outer",onDragover:a[1]||(a[1]=f((()=>{}),["prevent"])),onDrop:a[2]||(a[2]=e=>(e=>{e.preventDefault();const t=JSON.parse(e.dataTransfer.getData("text/plain")),{type:a,uuid:i}=t;if(l.value.findData(a,i).parentUuid)l.value.unbindGroup(t);else{const e=l.value.getAllList().reverse();l.value.bindGroup({fromData:t,toData:e[e.length-1],zIndex:e[e.length-1].zIndex+1})}})(e))},[T(n,null,{default:E((()=>[(h(!0),m(x,null,D(l.value.getAllList().reverse(),((e,t)=>(h(),m(x,null,[e&&"group"===e.type?(h(),k(Xt,{isFirst:0===t,isLast:t===l.value.getAllList().length-1,onToLayerInfo:o,editorType:i.editorType,data:e,key:e?e.uuid:t},null,8,["isFirst","isLast","editorType","data"])):w("",!0),e&&"layer"===e.type?(h(),k(Nt,{isFirst:0===t,isLast:t===l.value.getAllList().length-1,onToLayerInfo:o,editorType:i.editorType,data:e,key:e?e.uuid:t},null,8,["isFirst","isLast","editorType","data"])):w("",!0)],64)))),256))])),_:1})],32)],512)}}},[["__scopeId","data-v-5cb57652"]]),$t={class:"menu-icon"},Zt=["src"],Jt={class:"menu-all"},Qt=["onClick"],qt={class:"menu-icon"},Kt={class:"menu-name"},ea=G({__name:"editorHandle",props:["editorType"],emits:["changeHandleType","exportImage","changeViewType","toGenrateGroup","toAdvancedSettingDom","save"],setup(e,{emit:t}){const a=s(),{publicStore:l}=re(),i=c(Mt),n=c(Lt),o=L();_();const d=c([]),u=c(null),f=c(0),w=c(0),b=e,k=t,I=()=>{const e=S(),t=A();return[].concat(e,t)},S=()=>i.value.handleState===ce&&"edit"===b.editorType?[{name:"绘制模式",icon:Q,click(){i.value.changeHandleType(he),_t.selectedMap.element=null,Mt.reDraw()}}]:i.value.handleState===he&&"edit"===b.editorType?[{name:"操作模式",icon:q,click(){i.value.changeHandleType(ce)}}]:[],A=()=>{let e=[{name:"下载图片",icon:K,async click(){(await n.value.getAllImage()).forEach((({name:e,image:t})=>{const a=`${r()}`;"aaaaa"!==e&&t.forEach(((t,l)=>{t.forEach(((t,i)=>{const n=Ze(t),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=`${a}_${e}_${l}_${i}.png`,document.body.appendChild(o),o.click(),URL.revokeObjectURL(n),document.body.removeChild(o)}))}))}))}},{name:"/generateImage"===o.path?"作品保存":"模板保存",icon:ee,click(){if(!i.value.name)return a.error("请在设置模板名称后操作"),void k("toCanvasSetting");n.value.save(1)}},{name:"效果调节",icon:N,click(){k("toAdvancedSettingDom")}},{name:"测试生成",icon:w.value?F:te,click(){if(!i.value.name)return a.error("请在设置模板名称后操作"),void k("toCanvasSetting");w.value++,n.value.save().then((()=>{n.value.generateAll()}))}},{name:"分层展示",icon:ae,click(){k("changeViewType")}}];if("edit"===b.editorType&&(e=e.concat([{name:"画板设置",icon:le,click(){k("toCanvasSetting")}}])),"gallery"===b.editorType){const t=e.findIndex((e=>"测试生成"===e.name));e.splice(t,1)}return e};return M((()=>{u.value=o.path,d.value=[]})),(e,t)=>{const a=C("el-icon");return h(),m("div",{class:g(["left-bar-body",{expand:f.value}])},[v("div",{class:"menu-title",onClick:t[0]||(t[0]=e=>(f.value=Number(!f.value),void l.setLeftBarShowType(f.value)))},[v("div",$t,[T(a,{class:"icon"},{default:E((()=>[v("img",{src:y(ue)},null,8,Zt)])),_:1})]),t[1]||(t[1]=v("div",{class:"menu-name"},null,-1))]),v("div",Jt,[(h(!0),m(x,null,D(I(),((e,t)=>(h(),m("div",{class:"menu-item",key:t,onClick:t=>e.click()},[v("div",qt,[v("i",{class:g(["bi icon",e.icon])},null,2)]),v("div",Kt,p(e.name),1)],8,Qt)))),128))])],2)}}},[["__scopeId","data-v-7739d750"]]),ta={class:"editor-draw-board-setting-box"},aa={class:"editor-draw-board-setting-title"},la={class:"editor-draw-board-setting-handle-area"},ia={class:"setting-item"},na={class:"setting-item-value"},sa={class:"setting-item"},oa={class:"setting-item-value"},ra={class:"setting-item-value"},da={class:"setting-item"},ua={class:"setting-item-value"},ca={class:"setting-item"},ha={class:"setting-item-value"},ma={class:"setting-item"},va={class:"setting-item-value"},pa={class:"setting-item"},ga={class:"setting-item-value"},ya=G({__name:"editorDrawBoardSetting",props:["editorType"],setup(e,{expose:t}){const a=s(),l=L(),i=e,n="/modelMainEditor"===l.path,o=c(!1);c(null);const r=c({}),d=c(Mt),u=c(St),p=[{name:"普通",key:"normal"},{name:"高级",key:"high"},{name:"顶级",key:"top"}],f=[{name:"普通",key:"normal"},{name:"高级",key:"high"},{name:"顶级",key:"top"}],w=()=>{o.value=!1};return t({show:e=>{o.value?w():(r.value=Mt.getData(),o.value=!0)}}),(e,t)=>{const l=C("el-input"),s=C("el-input-number"),c=C("el-option"),I=C("el-select");return h(),m("div",{class:g(["editor-draw-board-setting",{show:o.value}])},[v("div",ta,[v("div",aa,[t[9]||(t[9]=b(" 画板设置 ")),v("div",la,[v("div",{class:"editor-draw-board-setting-handle",onClick:t[0]||(t[0]=e=>w())},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{class:"editor-draw-board-setting-handle",onClick:t[1]||(t[1]=e=>{r.value.points?(o.value=!1,d.value.setData(r.value,"edit"),u.value.setName(r.value.name)):a.error("请输入售卖点数后操作")})},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",ia,[t[10]||(t[10]=v("div",{class:"setting-item-label"},"模板名称",-1)),v("div",na,[T(l,{modelValue:r.value.name,"onUpdate:modelValue":t[2]||(t[2]=e=>r.value.name=e),disabled:"edit"!==i.editorType||!n},null,8,["modelValue","disabled"])])]),v("div",sa,[t[11]||(t[11]=v("div",{class:"setting-item-label"},"宽度W",-1)),v("div",oa,[T(s,{style:{width:"2rem"},disabled:"edit"!==i.editorType,modelValue:r.value.realWidth,"onUpdate:modelValue":t[3]||(t[3]=e=>r.value.realWidth=e),controls:!1},null,8,["disabled","modelValue"])]),t[12]||(t[12]=v("div",{class:"setting-item-label"},"高度H",-1)),v("div",ra,[T(s,{style:{width:"2rem"},disabled:"edit"!==i.editorType,modelValue:r.value.realHeight,"onUpdate:modelValue":t[4]||(t[4]=e=>r.value.realHeight=e),controls:!1},null,8,["disabled","modelValue"])])]),v("div",da,[t[13]||(t[13]=v("div",{class:"setting-item-label"},"绘制方式",-1)),v("div",ua,[T(I,{modelValue:r.value.drawType,"onUpdate:modelValue":t[5]||(t[5]=e=>r.value.drawType=e),disabled:"edit"!==i.editorType},{default:E((()=>[(h(!0),m(x,null,D(Object.keys(y(me)),(e=>(h(),k(c,{key:e,value:y(me)[e],label:y(me)[e]},null,8,["value","label"])))),128))])),_:1},8,["modelValue","disabled"])])]),v("div",ca,[t[14]||(t[14]=v("div",{class:"setting-item-label"},"模板分类",-1)),v("div",ha,[T(I,{modelValue:r.value.template_filter,"onUpdate:modelValue":t[6]||(t[6]=e=>r.value.template_filter=e),disabled:"edit"!==i.editorType},{default:E((()=>[(h(),m(x,null,D(f,(e=>T(c,{key:e.key,value:e.key,label:e.name},null,8,["value","label"]))),64))])),_:1},8,["modelValue","disabled"])])]),v("div",ma,[t[15]||(t[15]=v("div",{class:"setting-item-label"},"模板等级",-1)),v("div",va,[T(I,{modelValue:r.value.template_level,"onUpdate:modelValue":t[7]||(t[7]=e=>r.value.template_level=e),disabled:"edit"!==i.editorType},{default:E((()=>[(h(),m(x,null,D(p,(e=>T(c,{key:e.key,value:e.key,label:e.name},null,8,["value","label"]))),64))])),_:1},8,["modelValue","disabled"])])]),v("div",pa,[t[16]||(t[16]=v("div",{class:"setting-item-label"},"售卖点数",-1)),v("div",ga,[T(s,{style:{width:"100%","text-align":"left"},precision:0,step:1,controls:!1,modelValue:r.value.points,"onUpdate:modelValue":t[8]||(t[8]=e=>r.value.points=e),min:1},null,8,["modelValue"])])])])],2)}}},[["__scopeId","data-v-1d787472"]]),fa={class:"editor-layer-setting-box"},wa={class:"editor-layer-setting-title"},ba={class:"editor-layer-setting-handle-area"},xa={class:"setting-value-box"},Da={key:0,class:"setting-item"},ka={class:"setting-item-value"},Ia={class:"setting-item",style:{"justify-content":"space-between"}},Ca=["label","onClick","value"],Ta={key:1,class:"setting-item"},Ea={class:"setting-item-value"},La={key:2,class:"setting-item"},_a={class:"setting-item-value"},Ma={key:3,class:"setting-item"},Sa={class:"setting-item-value"},Aa={key:4,class:"setting-item"},za={class:"setting-item-value"},Oa={key:5,class:"setting-item"},Ra={class:"setting-item-value"},Ua=G({__name:"editorLayerSetting",props:{staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]}},emits:["save"],setup(e,{expose:t,emit:a}){const l=s(),i=c(_t),n=e,o=c(!1),r=c(null),d=c([]),u=c([]),L=c([]),_=c([]),M=c(null),S=c(null),A=c(null),z=c("layer"),O=c(null),R=()=>{o.value=!1},U=()=>{S.value=null,A.value=null},P=e=>{if("image/png"!==e.type)return void l.error("请上传png格式图片");const t=new FileReader;return t.onload=({target:e})=>{const t=new Image;t.src=e.result,t.onload=()=>{A.value=t,S.value=e.result}},t.readAsDataURL(e),!1},G=()=>{let e=[];const t=d.value.map((e=>n.staticsList.find((t=>e===t.template_name)).template_name)).join("");if(d.value.length&&t.includes("tile")){let a="";t.includes("tile_xy")?a="tile_xy":t.includes("tile_x")?a="tile_x":t.includes("tile_y")&&(a="tile_y"),e=n.staticsList.filter((e=>e.template_name.includes(a)))}else e=d.value.length&&!t.includes("tile")?n.staticsList.filter((e=>!e.template_name.includes("tile"))):n.staticsList;return e};return t({show:(e=null)=>{o.value?R():(o.value=!0,r.value=e?e.name:"",d.value=e?e.statics:[],u.value=e?e.prompts:[],_.value=e?e.texts:[],L.value=e?e.colors:[],M.value=e?e.uuid:null,A.value=e?e.image:null,O.value=e?e.type:"statics",S.value=A.value?A.value.src:null)}}),(e,t)=>{const a=C("el-input"),s=C("el-option"),c=C("el-select"),j=C("el-button"),N=C("el-image"),V=C("el-upload"),H=C("el-scrollbar");return h(),m("div",{class:g(["editor-layer-setting",{show:o.value}]),style:I({height:"layer"===z.value?"9.3rem":"7rem"})},[v("div",fa,[v("div",wa,[b(p("layer"===z.value?"图层":"组")+"设置 ",1),v("div",ba,[v("div",{class:"editor-layer-setting-handle",onClick:t[0]||(t[0]=e=>R())},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{class:"editor-layer-setting-handle",onClick:t[1]||(t[1]=e=>(async()=>{if(!r.value&&"layer"===z.value)return void l.error("请输入图层名称后保存");if(!O.value)return void l.error("请选择图层类型后操作");if(!(d.value.length||u.value.length||L.value.length||_.value.length))return void l.error("请选择模板后操作");let e="";const t=d.value.length?d.value[0]:"",a=L.value.length?L.value[0]:"";if(t.includes("tile_xy")?e="tile_xy":t.includes("tile_x")?e="tile_x":t.includes("tile_y")&&(e="tile_y"),a.includes("tile_xy")?e="tile_xy":a.includes("tile_x")?e="tile_x":a.includes("tile_y")&&(e="tile_y"),o.value=!1,M.value){const t=i.value.findData("layer",M.value),{children:a}=t,l={prompts:u.value,statics:d.value,colors:L.value,texts:_.value,type:O.value,name:r.value,tileType:e};A.value&&(l.image=A.value),t.setData(l),delete l.name,a.forEach(((n,s)=>{e&&s?t.children.splice(s,a.length-1):i.value.findData("element",n).setData(l)})),i.value.reDraw()}else{const t={prompts:u.value,statics:d.value,colors:L.value,texts:_.value,type:O.value,name:r.value,tileType:e};A.value&&(t.image=A.value);const a=await i.value.add("layer",null,r.value,t);i.value.changeSelected([null,a,null]),i.value.reDraw()}})())},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",xa,[T(H,null,{default:E((()=>["layer"===z.value?(h(),m("div",Da,[t[7]||(t[7]=v("div",{class:"setting-item-label"},"图层名称",-1)),v("div",ka,[T(a,{modelValue:r.value,"onUpdate:modelValue":t[2]||(t[2]=e=>r.value=e)},null,8,["modelValue"])])])):w("",!0),v("div",Ia,[(h(!0),m(x,null,D(Object.keys(y(ge)),(e=>(h(),m("div",{class:g(["setting-item-value",{selected:e===O.value}]),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"},key:e,label:y(ge)[e],onClick:t=>{return a=e,void(M.value?l.error("图层类型不可改变"):(d.value=[],L.value=[],_.value=[],u.value=[],S.value=null,A.value=null,O.value=a));var a},value:e},[b(p(y(ge)[e])+" ",1),t[8]||(t[8]=v("i",{class:"bi bi-bookmark-check",style:{"margin-left":"0.1rem"}},null,-1))],10,Ca)))),128)),v("div",{class:"setting-item-selected",style:I({left:2.1*Object.keys(ge).findIndex((e=>e===O.value))+"rem"})},null,4)]),"statics"===O.value?(h(),m("div",Ta,[t[9]||(t[9]=v("div",{class:"setting-item-label"},"模板选择",-1)),v("div",Ea,[T(c,{multiple:"",modelValue:d.value,"onUpdate:modelValue":t[3]||(t[3]=e=>d.value=e)},{default:E((()=>[(h(!0),m(x,null,D(G(),(e=>(h(),k(s,{key:e.template_id,label:e.template_name,value:e.template_name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])):w("",!0),"prompts"===O.value?(h(),m("div",La,[t[10]||(t[10]=v("div",{class:"setting-item-label"},"模板选择",-1)),v("div",_a,[T(c,{multiple:"",modelValue:u.value,"onUpdate:modelValue":t[4]||(t[4]=e=>u.value=e)},{default:E((()=>[(h(!0),m(x,null,D(n.promptsList,(e=>(h(),k(s,{key:e.template_id,label:e.template_name,value:e.template_name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])):w("",!0),"colors"===O.value?(h(),m("div",Ma,[t[11]||(t[11]=v("div",{class:"setting-item-label"},"模板选择",-1)),v("div",Sa,[T(c,{multiple:"",modelValue:L.value,"onUpdate:modelValue":t[5]||(t[5]=e=>L.value=e)},{default:E((()=>[(h(!0),m(x,null,D(n.colorsList,(e=>(h(),k(s,{key:e.template_id,label:e.template_name,value:e.template_name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])):w("",!0),"texts"===O.value?(h(),m("div",Aa,[t[12]||(t[12]=v("div",{class:"setting-item-label"},"模板选择",-1)),v("div",za,[T(c,{multiple:"",modelValue:_.value,"onUpdate:modelValue":t[6]||(t[6]=e=>_.value=e)},{default:E((()=>[(h(!0),m(x,null,D(n.textsList,(e=>(h(),k(s,{key:e.template_id,label:e.template_name,value:e.template_name},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])])):w("",!0),"statics"===O.value||"prompts"===O.value?(h(),m("div",Oa,[t[14]||(t[14]=v("div",{class:"setting-item-label"},"图片",-1)),v("div",Ra,[T(V,{style:{width:"100%"},"before-upload":P,accept:".png","show-file-list":!1,action:""},{default:E((()=>[S.value?w("",!0):(h(),k(j,{key:0,style:{width:"6.8rem",height:"3.5rem",padding:"0"}},{default:E((()=>t[13]||(t[13]=[b("上传图片")]))),_:1})),S.value?(h(),k(j,{key:1,style:{width:"6.8rem",height:"3.5rem",padding:"0",position:"relative"}},{default:E((()=>[T(N,{fit:"cover",style:{width:"6.8rem",height:"3.5rem"},src:S.value},null,8,["src"]),v("div",{class:"remove-image-btn",onClick:f(U,["stop"])},[v("div",{class:g(["bi",y($)])},null,2)])])),_:1})):w("",!0)])),_:1})])])):w("",!0)])),_:1})])])],6)}}},[["__scopeId","data-v-375875bd"]]);const Pa=G({},[["render",function(e,t){return h(),m("div")}]]),Ga={class:"image-like"},ja={class:"slider-area"},Na={class:"slider-handle"},Va={class:"image-area"},Ha={class:"image-item"},Ya=["src"],Fa={class:"image-item"},Xa=["src"],Wa=G({__name:"imageLike",props:{imageUrl:{type:String,default:""},uuid:{type:Number,default:0},generateImageReviewUrl:{type:String,default:null}},emits:["setNewImageUrl"],setup(e,{emit:t}){s();const a=e,l=c(50),i=c(null),n=()=>{const{templateId:e,name:t}=Mt;Ce.addTask(e,t,"element",[{imageUrl:a.imageUrl,similarity:l.value/100,uuid:a.uuid}],Ie)};return(t,s)=>{const o=C("el-slider");return h(),m("div",Ga,[v("div",ja,[s[1]||(s[1]=v("div",{class:"slider-name"},"相似度",-1)),v("div",Na,[T(o,{modelValue:l.value,"onUpdate:modelValue":s[0]||(s[0]=e=>l.value=e),min:0,max:100},null,8,["modelValue"])]),v("div",{class:"slider-btn-area"},[v("div",{onClick:n},"生成")])]),v("div",Va,[v("div",Ha,[v("img",{src:a.imageUrl},null,8,Ya)]),v("div",Fa,[v("img",{src:i.value||e.generateImageReviewUrl},null,8,Xa)])])])}}},[["__scopeId","data-v-d1ab31bc"]]);const Ba=G({},[["render",function(e,t){return h(),m("div")}]]),$a={class:"image-generate-setting-handle-area"},Za={class:"change-setting-type-area"},Ja=["onClick"],Qa={class:"handle-btn-area"},qa={class:"image-generate-setting-component-area"},Ka=G({__name:"imageGenerate",emits:["replaceImage"],setup(e,{expose:t,emit:a}){const l=[{name:"相似生成",component:Wa},{name:"融合图像",component:Pa},{name:"文本控制",component:Ba}],i=c(0),n=c(_t),s=c(Lt),o=c(!1),r=c(null),d=c(null),u=c(null),b=c(null),C=c("element"),T=c(!1),E=()=>{T.value=!1,setTimeout((()=>{o.value=!1}),200)},L=e=>{u.value=e};return t({init:(e,t=null,a="element")=>{if(mt(e.image)){const l=$e(e.image,`element_${e.uuid}`),i=new FormData;i.append("file",l),de(`element_${e.uuid}`,i).then((l=>{r.value=l,d.value=e.uuid,C.value=a,b.value=t,u.value=null,o.value=!0,A((()=>{T.value=!0}))}))}else r.value=e.image,d.value=e.uuid,C.value=a,b.value=t,u.value=null,o.value=!0,A((()=>{T.value=!0}))}}),(e,t)=>o.value?(h(),m("div",{key:0,class:"image-generate-outer",onClick:t[3]||(t[3]=e=>E())},[v("div",{class:g(["image-generate show_start",{show_end:T.value}]),onClick:t[2]||(t[2]=f((()=>{}),["stop"]))},[v("div",$a,[v("div",Za,[v("div",{class:"component-selected",style:I({left:3.2*i.value+.05+"rem"})},null,4),(h(),m(x,null,D(l,((e,t)=>v("div",{class:"component-item",onClick:e=>i.value=t,key:e.name},p(e.name),9,Ja))),64))]),v("div",Qa,[v("div",{class:"handle-btn",onClick:t[0]||(t[0]=e=>E())},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{class:"handle-btn",onClick:t[1]||(t[1]=e=>(async()=>{o.value=!1;const e=await Je(b.value);n.value.findData(C.value,d.value).setData({image:e}),s.value.reDraw()})())},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",qa,[o.value?(h(),k(S(l[i.value].component),{key:0,imageUrl:r.value,uuid:d.value,generateImageReviewUrl:b.value,onSetNewImageUrl:L,ref:"componentDom"},null,40,["imageUrl","uuid","generateImageReviewUrl"])):w("",!0)])],2)])):w("",!0)}},[["__scopeId","data-v-04dec247"]]),el={class:"editor-text-setting-title"},tl={class:"editor-text-setting-close-area"},al={class:"editor-text-setting-inner"},ll={class:"editor-text-setting"},il={class:"editor-text-setting-value"},nl={class:"editor-text-setting"},sl={class:"editor-text-setting-value"},ol={class:"editor-text-setting"},rl={class:"editor-text-setting-value"},dl=G({__name:"editorTextSetting",setup(e,{expose:t}){const a=c(!1),l=c(_t),i=c(null),n=c({}),s=c(!1),o=()=>{s.value=!1,setTimeout((()=>{a.value=!1}),200)};return t({init:e=>{const{fontSetting:t}=e;i.value=e.uuid,a.value=!0;const l=JSON.parse(JSON.stringify(t));l.font_color=tt(l.font_color),n.value=l,A((()=>{s.value=!0}))}}),(e,t)=>{const r=C("el-input"),d=C("el-color-picker"),u=C("el-input-number");return a.value?(h(),m("div",{key:0,class:"editor-text-setting-outer",onClick:t[6]||(t[6]=e=>o())},[v("div",{class:g(["editor-text-setting-box show_start",{show_end:s.value}]),onClick:t[5]||(t[5]=f((()=>{}),["stop"]))},[v("div",el,[t[7]||(t[7]=v("div",{class:"editor-text-setting-content"},"编辑文本",-1)),v("div",tl,[v("div",{onClick:t[0]||(t[0]=e=>o())},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{onClick:t[1]||(t[1]=e=>(()=>{const e=l.value.findData("element",i.value),t=JSON.parse(JSON.stringify(n.value));t.font_color=et(t.font_color);const a=Mt.getTextWidth(t);e.setData({x:e.x+e.width/2-a/2,width:a,height:t.font_size,fontSetting:t}),l.value.reDraw(),o()})())},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",al,[v("div",ll,[t[8]||(t[8]=v("div",{class:"editor-text-setting-name"},"文本内容",-1)),v("div",il,[T(r,{modelValue:n.value.content,"onUpdate:modelValue":t[2]||(t[2]=e=>n.value.content=e)},null,8,["modelValue"])])]),v("div",nl,[t[9]||(t[9]=v("div",{class:"editor-text-setting-name"},"文本颜色",-1)),v("div",sl,[T(d,{style:{width:"100%"},"color-format":"rgba","show-alpha":"",modelValue:n.value.font_color,"onUpdate:modelValue":t[3]||(t[3]=e=>n.value.font_color=e)},null,8,["modelValue"])])]),v("div",ol,[t[11]||(t[11]=v("div",{class:"editor-text-setting-name"},"文本字号",-1)),v("div",rl,[T(u,{controls:!1,modelValue:n.value.font_size,"onUpdate:modelValue":t[4]||(t[4]=e=>n.value.font_size=e)},null,8,["modelValue"]),t[10]||(t[10]=b(" px "))])])])],2)])):w("",!0)}}},[["__scopeId","data-v-ccddb983"]]),ul={class:"editor-text-setting-title"},cl={class:"editor-text-setting-close-area"},hl={class:"editor-text-setting-inner"},ml={class:"editor-text-setting"},vl={class:"editor-text-setting-value"},pl=G({__name:"editorColorSetting",setup(e,{expose:t}){const a=c(!1),l=c(_t),i=c(null),n=c({}),s=c(!1),o=()=>{s.value=!1,setTimeout((()=>{a.value=!1}),200)};return t({init:e=>{const{color:t}=e;i.value=e.uuid,a.value=!0;const l={color:tt(t)};n.value=l,A((()=>{s.value=!0}))}}),(e,t)=>{const r=C("el-color-picker");return a.value?(h(),m("div",{key:0,class:"editor-text-setting-outer",onClick:t[4]||(t[4]=e=>o())},[v("div",{class:g(["editor-text-setting-box show_start",{show_end:s.value}]),onClick:t[3]||(t[3]=f((()=>{}),["stop"]))},[v("div",ul,[t[5]||(t[5]=v("div",{class:"editor-text-setting-content"}," 编辑颜色 ",-1)),v("div",cl,[v("div",{onClick:t[0]||(t[0]=e=>o())},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{onClick:t[1]||(t[1]=e=>(()=>{const e=l.value.findData("element",i.value),t=JSON.parse(JSON.stringify(n.value));t.color=et(t.color),e.setData(t),l.value.reDraw(),o()})())},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",hl,[v("div",ml,[t[6]||(t[6]=v("div",{class:"editor-text-setting-name"}," 纯色层颜色 ",-1)),v("div",vl,[T(r,{style:{width:"100%"},"color-format":"rgba","show-alpha":"",modelValue:n.value.color,"onUpdate:modelValue":t[2]||(t[2]=e=>n.value.color=e)},null,8,["modelValue"])])])])],2)])):w("",!0)}}},[["__scopeId","data-v-dc979a78"]]),gl={class:"editor-layer-setting-box"},yl={class:"editor-layer-setting-title"},fl={class:"editor-layer-setting-handle-area"},wl={class:"setting-value-box"},bl={class:"setting-item",style:{"justify-content":"space-between"}},xl={class:"setting-item",style:{border:"none",margin:"0"}},Dl={class:"setting-item-value"},kl={class:"setting-item-value"},Il={class:"setting-item",style:{border:"none",margin:"0"}},Cl={class:"setting-item-value"},Tl={class:"setting-item-value"},El={class:"setting-item"},Ll={class:"setting-item-value",style:{padding:"0 0.4rem"}},_l={class:"setting-item"},Ml={class:"setting-item-value"},Sl={class:"setting-item-value"},Al={class:"setting-item"},zl={class:"setting-item-value",style:{padding:"0 0.4rem"}},Ol=G({__name:"editorElementSetting",emits:["save"],setup(e,{expose:t,emit:a}){s();const l=c(_t),i=c(!1),n=c(null);c([]);const o=c(null),r=c(0),d=c(0),u=c(0),p=c(0),f=c(100),w=c(0),x=c(!1),D=c(!1),k=c(new Me),I=c(null),L=c(null),_=c(null),M=c(null),S=c(null),A=c(0),O=c(null);let R=null;z(L,(async e=>{i.value&&(await P(),V())}));const U=e=>{L.value=e},P=async()=>{let e=null;L.value&&(e=await S.value.grayToColor(et(L.value))),A.value&&(e=await S.value.edgeFeather(A.value/1e3)),M.value=e,V()},G=(e="right")=>{"right"===e?w.value+=Math.PI/2:w.value-=Math.PI/2,V()},j=(e="x")=>{"x"===e?x.value=!x.value:D.value=!D.value,V()},N=()=>{const e={name:R.name,uuid:R.uuid,x:R.x,y:R.y,width:R.width,height:R.height,opacity:R.opacity,rotate:R.rotate,xOverturn:R.xOverturn,yOverturn:R.yOverturn,hue:R.hue,handleImage:R.handleImage,edgeFeather:R.edgeFeather};l.value.findData("element",o.value).setData(e),l.value.reDraw(),R=null},V=()=>{const e={name:n.value,uuid:o.value,x:r.value,y:d.value,width:u.value,height:p.value,opacity:f.value/100,rotate:w.value,xOverturn:x.value,yOverturn:D.value,hue:L.value?et(L.value):null,handleImage:M.value,edgeFeather:A.value};l.value.findData("element",o.value).setData(e),l.value.reDraw()};return t({show:(e=null)=>{const t=l.value.findData("element",e);o.value&&o.value!==e&&N(),R||(R=JSON.parse(JSON.stringify(t)),R.image=t.image,R.handleImage=t.handleImage),i.value=!0,n.value=t?t.name:"",O.value=t.hue?at(t.hue):null,o.value=t?t.uuid:null,r.value=t.x||0,d.value=t.y||0,u.value=t.width||0,p.value=t.height||0,f.value=100*t.opacity,w.value=t.rotate||0,x.value=t.xOverturn||!1,D.value=t.yOverturn||!1,A.value=t.edgeFeather||0,L.value=t.hue?at(t.hue):null,_.value=t.image,M.value=t.handleImage,S.value=new kt(o.value,t.image)}}),(e,t)=>{const a=C("el-input-number"),l=C("el-slider"),n=C("el-color-picker"),s=C("el-scrollbar");return h(),m("div",{class:g(["editor-layer-setting",{show:i.value}])},[v("div",gl,[v("div",yl,[t[23]||(t[23]=b(" 参数调节 ")),v("div",fl,[v("div",{class:"editor-layer-setting-handle",onClick:t[0]||(t[0]=e=>(S.value=null,N(),o.value=null,void(i.value=!1)))},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{class:"editor-layer-setting-handle",onClick:t[1]||(t[1]=e=>(V(),i.value=!1,o.value=null,void(R=null)))},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",wl,[T(s,null,{default:E((()=>[v("div",bl,[v("div",{class:"setting-item-value handle-btn",onClick:t[2]||(t[2]=e=>G("left")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[24]||(t[24]=[b(" 左转 "),v("i",{class:"bi bi-arrow-90deg-left",style:{"margin-left":"0.1rem"}},null,-1)])),v("div",{class:"setting-item-value handle-btn",onClick:t[3]||(t[3]=e=>G("right")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[25]||(t[25]=[b(" 右转 "),v("i",{class:"bi bi-arrow-90deg-right",style:{"margin-left":"0.1rem"}},null,-1)])),v("div",{class:"setting-item-value handle-btn",onClick:t[4]||(t[4]=e=>j("x")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[26]||(t[26]=[b(" 水平翻转 "),v("i",{class:"bi bi-arrows-expand-vertical",style:{"margin-left":"0.1rem"}},null,-1)])),v("div",{class:"setting-item-value handle-btn",onClick:t[5]||(t[5]=e=>j("y")),style:{flex:"none","align-items":"center","justify-content":"center",cursor:"pointer"}},t[27]||(t[27]=[b(" 垂直翻转 "),v("i",{class:"bi bi-arrows-expand",style:{"margin-left":"0.1rem"}},null,-1)]))]),v("div",xl,[v("div",{class:g(["setting-item-min",{handing:"x"===I.value,handingLock:I.value}]),onMousedown:t[8]||(t[8]=e=>(e=>{let t=e.pageX;k.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX?r.value--:t<e.pageX&&r.value++,t=e.pageX,V()})),I.value="x",k.value.addListener(document.documentElement,"mouseup",(e=>{k.value.removeAllListeners(),I.value=null}))})(e))},[t[28]||(t[28]=v("div",{class:"setting-item-label"},"位置X",-1)),v("div",Dl,[T(a,{style:{width:"2rem"},modelValue:r.value,"onUpdate:modelValue":t[6]||(t[6]=e=>r.value=e),onChange:t[7]||(t[7]=e=>V()),precision:0,step:1,controls:!1},null,8,["modelValue"])])],34),v("div",{class:g(["setting-item-min",{handing:"y"===I.value,handingLock:I.value}]),onMousedown:t[11]||(t[11]=e=>(e=>{let t=e.pageX;k.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX?d.value--:t<e.pageX&&d.value++,t=e.pageX,V()})),I.value="y",k.value.addListener(document.documentElement,"mouseup",(e=>{k.value.removeAllListeners(),I.value=null}))})(e))},[t[29]||(t[29]=v("div",{class:"setting-item-label"},"位置Y",-1)),v("div",kl,[T(a,{style:{width:"2rem"},modelValue:d.value,"onUpdate:modelValue":t[9]||(t[9]=e=>d.value=e),onChange:t[10]||(t[10]=e=>V()),precision:0,step:1,controls:!1},null,8,["modelValue"])])],34)]),v("div",Il,[v("div",{class:g(["setting-item-min",{handing:"width"===I.value,handingLock:I.value}]),onMousedown:t[14]||(t[14]=e=>(e=>{let t=e.pageX;k.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX&&u.value>1?u.value--:t<e.pageX&&u.value>1&&u.value++,t=e.pageX,V()})),I.value="width",k.value.addListener(document.documentElement,"mouseup",(e=>{k.value.removeAllListeners(),I.value=null}))})(e))},[t[30]||(t[30]=v("div",{class:"setting-item-label"},"宽度W",-1)),v("div",Cl,[T(a,{style:{width:"2rem"},modelValue:u.value,"onUpdate:modelValue":t[12]||(t[12]=e=>u.value=e),onChange:t[13]||(t[13]=e=>V()),precision:0,step:1,controls:!1},null,8,["modelValue"])])],34),v("div",{class:g(["setting-item-min",{handing:"height"===I.value,handingLock:I.value}]),onMousedown:t[17]||(t[17]=e=>(e=>{let t=e.pageX;k.value.addListener(document.documentElement,"mousemove",(e=>{t>e.pageX&&p.value>1?p.value--:t<e.pageX&&p.value>1&&p.value++,t=e.pageX,V()})),I.value="height",k.value.addListener(document.documentElement,"mouseup",(e=>{k.value.removeAllListeners(),I.value=null}))})(e))},[t[31]||(t[31]=v("div",{class:"setting-item-label"},"高度H",-1)),v("div",Tl,[T(a,{style:{width:"2rem"},modelValue:p.value,"onUpdate:modelValue":t[15]||(t[15]=e=>p.value=e),onChange:t[16]||(t[16]=e=>V()),precision:0,step:1,controls:!1},null,8,["modelValue"])])],34)]),v("div",El,[t[32]||(t[32]=v("div",{class:"setting-item-label"},"透明度",-1)),v("div",Ll,[T(l,{onInput:t[18]||(t[18]=e=>V()),style:{"--el-slider-button-size":"0.5rem","--el-slider-button-wrapper-size":"0.8rem",height:"0.8rem","--el-slider-button-wrapper-offset":"-0.3rem"},max:100,min:0,modelValue:f.value,"onUpdate:modelValue":t[19]||(t[19]=e=>f.value=e)},null,8,["modelValue"])])]),t[35]||(t[35]=v("div",{class:"setting-item",style:{border:"none",margin:"0"}},[v("div",{class:"editor-layer-setting-title"},"高级参数")],-1)),v("div",_l,[v("div",Ml,[t[33]||(t[33]=v("div",{class:"setting-item-label",style:{width:"1.5rem"}},"单色相",-1)),v("div",Sl,[T(n,{style:{flex:"1","margin-top":"-0.25rem"},"color-format":"rgb",modelValue:O.value,"onUpdate:modelValue":t[20]||(t[20]=e=>O.value=e),onActiveChange:U},null,8,["modelValue"])])])]),v("div",Al,[t[34]||(t[34]=v("div",{class:"setting-item-label",style:{width:"1.5rem"}},"边缘羽化",-1)),v("div",zl,[T(l,{onInput:t[21]||(t[21]=e=>P()),style:{"--el-slider-button-size":"0.5rem","--el-slider-button-wrapper-size":"0.8rem",height:"0.8rem","--el-slider-button-wrapper-offset":"-0.3rem"},max:100,min:0,modelValue:A.value,"onUpdate:modelValue":t[22]||(t[22]=e=>A.value=e)},null,8,["modelValue"])])])])),_:1})])])],2)}}},[["__scopeId","data-v-1a140a48"]]),Rl={class:"editor-layer-setting-box"},Ul={class:"editor-layer-setting-title"},Pl={class:"editor-layer-setting-handle-area"},Gl={class:"setting-value-box"},jl={class:"setting-item"},Nl={class:"setting-item-value"},Vl={class:"setting-item-value"},Hl={class:"setting-item"},Yl={class:"setting-item-value",style:{padding:"0 0.4rem"}},Fl=G({__name:"editorAdvancedSetting",emits:["save"],setup(e,{expose:t,emit:a}){s(),c(_t);const l=c(!1);c(null),c(null),c(100),c(new Me),c(null);const i=c(null);c(null),c(null);const n=c(0),o=c(null);let r=null,d={};const u=async(e=!1)=>{const t=Object.keys(d);for(let a=0;a<t.length;a++){const l=t[a],s=d[l],o=s.colorHandle;let r=null;i.value&&(r=await o.grayToColor(et(i.value))),n.value&&(r=await o.edgeFeather(n.value/100));const u=_t.findData("element",l);e&&delete s.colorHandle,u.setData({handleImage:r,hue:i.value?et(i.value):null,edgeFeather:n.value})}Mt.edgeFeather=n.value,Mt.hue=i.value?et(i.value):null,Mt.reDraw()};z(i,(async e=>{l.value&&u()}));const p=e=>{i.value=e},f=()=>{const e=Object.keys(d);for(let t=0;t<e.length;t++){const a=e[t],l=d[a];delete l.colorHandle;const{image:i,handleImage:n,hue:s,edgeFeather:o}=l;_t.findData("element",a).setData({image:i,handleImage:n,hue:s,edgeFeather:o})}Mt.edgeFeather=r.edgeFeather,Mt.hue=r.hue,Mt.reDraw()};return t({show:()=>{l.value=!0,r=Mt.getData(),i.value=r.hue?at(r.hue):null,o.value=i.value,n.value=r.edgeFeather,Object.keys(_t.elements).forEach((e=>{const t=_t.findData("element",e);"texts"!==t.type&&(d[e]={image:t.image,hue:t.hue,handleImage:t.handleImage,edgeFeather:t.edgeFeather,colorHandle:new kt(e,t.image,Boolean(t.edgeFeather))})}))}}),(e,t)=>{const a=C("el-color-picker"),i=C("el-slider"),s=C("el-scrollbar");return h(),m("div",{class:g(["editor-layer-setting",{show:l.value}])},[v("div",Rl,[v("div",Ul,[t[5]||(t[5]=b(" 参数调节 ")),v("div",Pl,[v("div",{class:"editor-layer-setting-handle",onClick:t[0]||(t[0]=e=>(f(),void(l.value=!1)))},[v("i",{class:g(`bi ${y(ie)}`)},null,2)]),v("div",{class:"editor-layer-setting-handle",onClick:t[1]||(t[1]=e=>(u(!0),void(l.value=!1)))},[v("i",{class:g(`bi ${y(ne)}`)},null,2)])])]),v("div",Gl,[T(s,null,{default:E((()=>[v("div",jl,[v("div",Nl,[t[6]||(t[6]=v("div",{class:"setting-item-label",style:{width:"1.5rem"}},"单色相",-1)),v("div",Vl,[T(a,{style:{flex:"1","margin-top":"-0.25rem"},onActiveChange:p,"color-format":"rgb",modelValue:o.value,"onUpdate:modelValue":t[2]||(t[2]=e=>o.value=e)},null,8,["modelValue"])])])]),v("div",Hl,[t[7]||(t[7]=v("div",{class:"setting-item-label",style:{width:"1.5rem"}},"边缘羽化",-1)),v("div",Yl,[T(i,{onInput:t[3]||(t[3]=e=>u()),style:{"--el-slider-button-size":"0.5rem","--el-slider-button-wrapper-size":"0.8rem",height:"0.8rem","--el-slider-button-wrapper-offset":"-0.3rem"},max:100,min:0,modelValue:n.value,"onUpdate:modelValue":t[4]||(t[4]=e=>n.value=e)},null,8,["modelValue"])])])])),_:1})])])],2)}}},[["__scopeId","data-v-9b968087"]]),Xl=["onClick"],Wl={key:0,class:"explosion-line-1"},Bl={class:"explosion-prompt-item"},$l={class:"explosion-item-name"},Zl={class:"explosion-prompt-edit-btn"},Jl={key:0,class:"explosion-prompt-info"},Ql={key:1,class:"explosion-prompt-info"},ql={class:"explosion-diagram-item"},Kl={key:0,class:"explosion-name"},ei=["onClick"],ti={class:"explosion-image"},ai=["src"],li=G({__name:"explosionDiagram",props:{data:{type:Array,default:()=>[]},widthPrompt:{type:Boolean,default:()=>!1},explosionStyle:{type:Object,default:()=>({width:"5rem",height:"7rem"})}},setup(e,{expose:t}){const a=s(),l=e,i=c(null),n=c(null),o=c(null),r=c(null),d=c(null),u=c(""),y={COMMENCE:"commence",INCORPORATION:"incorporation"},k=c(y.INCORPORATION),L=e=>{y.hasOwnProperty(e)||"CHANGE"===e?(n.value=null,"CHANGE"===e?k.value===y.COMMENCE?k.value=y.INCORPORATION:k.value=y.COMMENCE:k.value=y[e]):a.error("非法参数")},_=e=>k.value===y.COMMENCE?Object.assign({left:2*e-l.data.length+"rem",top:-.5*e+.5+"rem",zIndex:l.data.length-e-1},l.explosionStyle):Object.assign({left:"0rem",top:"0rem",transform:"skewY(0deg)",zIndex:l.data.length-e-1,backgroundColor:e===l.data.length-1?"var(--t-sub-color)":"transparent"},l.explosionStyle),S=e=>o.value===e?{hiding:!0}:r.value===e?{showing:!0}:i.value===e?{show:!0}:i.value!==e?{hide:!0}:void 0;return M((()=>{l.data.length&&(i.value=0),setTimeout((()=>{L("COMMENCE")}))})),t({changeExplosionType:L}),(t,a)=>{const s=C("el-icon"),c=C("t-button");return h(),m("div",{class:"explosion-diagram-body",style:I({paddingTop:(k.value,y.COMMENCE,0)+"rem"})},[v("div",{class:"explosion-all",style:I(l.explosionStyle)},[(h(!0),m(x,null,D(l.data,((t,D)=>(h(),m(x,null,[n.value===D||k.value===y.COMMENCE||!n.value&&0!==n.value&&k.value===y.INCORPORATION?(h(),m("div",{class:g(["explosion-item",{selected:k.value===y.COMMENCE&&i.value===D}]),key:t.uuid,onClick:e=>(e=>new Promise((t=>{k.value===y.COMMENCE&&i.value!==e?(d.value=null,null!==i.value&&(o.value=i.value),r.value=e,setTimeout((()=>{i.value=r.value,r.value=null})),setTimeout((()=>{o.value=null,t()}),200)):t()})))(D),style:I(_(D))},[k.value===y.COMMENCE||null!==n.value?(h(),m("div",{key:0,class:g(["explosion-diagram-handle-area",Object.assign(S(D),{nomal:null!==n.value})])},[e.widthPrompt?(h(),m("div",Wl)):w("",!0),e.widthPrompt?(h(),m("div",{key:1,class:"explosion-line-2",style:I({width:1.5*(k.value===y.COMMENCE||null===n.value?l.data.length-D:1)+"rem"})},null,4)):w("",!0),e.widthPrompt?(h(),m("div",{key:2,class:"explosion-prompt-area",style:I({left:1.5*(k.value===y.COMMENCE||null===n.value?l.data.length-D:1)+1+"rem"})},[v("div",Bl,[v("div",$l,[b(p(t.name)+" ",1),v("div",Zl,[T(s,{class:"explosion-prompt-edit-item",onClick:f((e=>(e=>{u.value=l.data[e].prompt,d.value=e})(D)),["stop"])},null,8,["onClick"])])]),d.value!==D?(h(),m("div",Jl,p(t.prompt),1)):w("",!0),d.value===D?(h(),m("div",Ql,[O(v("textarea",{"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e)},null,512),[[R,u.value]])])):w("",!0),v("div",{class:"explosion-prompt-save-handle-area",style:I({height:d.value===D?"0.8rem":"0rem"})},[T(c,{type:"info",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"},onClick:a[1]||(a[1]=e=>d.value=null)},{default:E((()=>a[2]||(a[2]=[b("取消")]))),_:1}),T(c,{type:"success",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"}},{default:E((()=>a[3]||(a[3]=[b("生成")]))),_:1})],4)])],4)):w("",!0)],2)):w("",!0),v("div",ql,[k.value===y.COMMENCE?(h(),m("div",Kl,p(t.name),1)):w("",!0),null!==n.value||k.value===y.COMMENCE?(h(),m("div",{key:1,class:"show-explosion-item-handle-btn",onClick:f((e=>(e=>{null===n.value&&k.value===y.COMMENCE?(L("INCORPORATION"),n.value=e):null!==n.value&&(L("COMMENCE"),n.value=null),i.value=e})(D)),["stop"]),style:I({top:(k.value===y.COMMENCE?"1.2":"0.2")+"rem"})},p(null!==n.value?"隐藏":"展示"),13,ei)):w("",!0),v("div",ti,[v("img",{src:t.image},null,8,ai)])])],14,Xl)):w("",!0)],64)))),256))],4)],4)}}},[["__scopeId","data-v-bcc73a27"]]),ii={class:"model-draw-board"},ni={key:0,class:"model-draw-area"},si={class:"model-handle-area"},oi=G({__name:"modelDrawBoard",props:{setting:{},staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]},templateId:{type:Number,default:null},info:{type:Object,default:()=>({template_filter:"normal",template_level:"normal",points:1})},layerData:{},editorType:{}},emits:["setTypeList","setGroupList","setSelectedElement","layerData"],setup(e,{expose:t,emit:a}){s();const l=e,i=a,n=c(null),o=c(null),r=c(null),d=c(null),u=c(null),p=c(null),g=c(null),f=c(null),b=c(null),x=c(null);c("editor");const D=c([]),k=c({width:0,height:0}),I=c(null),C=c(Mt),E=c(_t),L=c(Lt);c(Object.assign({name:l.setting.name},l.setting.canvasData));const _=c(null),S=()=>{x.value.show()},A=async()=>{C.value.viewType===ve?(C.value.setViewType(pe),await z()):(d.value.changeExplosionType("INCORPORATION"),C.value.setViewType(ve),await z()),k.value={width:C.value.realWidth*C.value.zoomRatio*.8+"px",height:C.value.realHeight*C.value.zoomRatio*.8+"px"}},z=async()=>{D.value=await L.value.getLayerImage()},R=e=>{_.value=I.value.changeHandleType(e)},G=()=>{o.value.show()},j=()=>{I.value.exportImage()},N=(e,t)=>{switch(t){case"text":g.value.init(e);break;case"color":f.value.init(e)}},V=async()=>{const e=["groups","layers","elements"];for(let t of e)for(let e in l.layerData[t]){const a=l.layerData[t][e];if(a.image){const l=await qe(a.image);if(a.image=l,"elements"===t){let t=null,l=new kt(e,a.image,Boolean(a.edgeFeather));a.hue&&Array.isArray(a.hue)&&(t=await l.grayToColor(a.hue)),a.edgeFeather&&(t=await l.edgeFeather(a.edgeFeather/100)),l=null,a.handleImage=t}}if("texts"===a.type&&a.fontSetting&&a.fontSetting.font){const e=await vt(a.fontSetting.font);a.fontSetting.fontFamily=e}E.value.add(t.slice(0,-1),a.parentUuid,a.name,a,e,a.zIndex),E.value.reDraw()}},H=(e=null)=>{e=e||I.value.setTypeList();const t=Object.keys(e).map((t=>({uuid:t,name:e[t].name,image:e[t].image,loraInfo:e[t].loraInfo,layerInfo:e[t].layerInfo})));i("setTypeList",t)},Y=e=>{i("setGroupList",e)},F=(...e)=>{u.value.init(...e)},X=(e,t,a)=>{const l=P();qe(e).then((e=>{I.value.elementsList[t].setImage(e),I.value.reDraw(),l.close()}))},W=e=>{const{uuid:t}=e;delete e.uuid,t||I.value.addType({name:e.name,prompts:e.prompts,statics:e.statics,image:e.image}).then((e=>{H(e)}))},B=()=>{E.value.clearAllData(),L.value.toTextEditView=N,L.value.toImageGenerateView=F,L.value.toElementSetting=$,L.value.generationController.setName(l.setting.name),C.value.init(n.value,l.setting,l.editorType,l.templateId,l.info).then((()=>{V().then((()=>{L.value.reDraw(),Ce.setTaskResult()}))}))},$=(...e)=>{b.value.show(...e)};return M((()=>{B()})),t({toSettingLayer:(...e)=>{r.value.show(...e)},setSelectedLayer:(...e)=>{I.value.setTypeUuid(...e)},deleteGroup:e=>{I.value.deleteGroup(e)},deleteLayer:e=>{I.value.deleteType(e).then((({typeList:e,groups:t})=>{Y(t),H(e)}))},deleteElement:e=>{I.value.deleteElement(e),H(typeList)},setGroup:e=>{const{layerUuids:t,groupUuid:a}=e;if(a){if(1===t.length&&a){const e=I.value.getGroupItem(a).layers.concat(t),l=I.value.updateGroup(a,{layers:[...new Set(e)]});Y(l)}}else p.value.show(null,"group",e)},hideLayer:e=>{I.value.setHideLayer(e),new Promise((e=>{I.value.getAllLayerImage().then((t=>{D.value=Object.keys(t).map((e=>Object.assign({uuid:e,imageSrc:t[e].imageBase64},t[e]))).reverse(),e()}))}))},setDiagramImage:z}),(e,t)=>(h(),m("div",ii,[O(v("div",{class:"model-draw-area",ref_key:"modelEditorDom",ref:n,tabindex:"0"},null,512),[[U,"editor"===y(Mt).viewType]]),"explosion"===y(Mt).viewType?(h(),m("div",ni,[T(li,{explosionStyle:k.value,data:D.value,ref_key:"explosionDiagramDom",ref:d},null,8,["explosionStyle","data"])])):w("",!0),v("div",si,[T(ea,{handleType:_.value,onToCanvasSetting:G,onChangeHandleType:R,onExportImage:j,onChangeViewType:A,onToAdvancedSettingDom:S,editorType:l.editorType},null,8,["handleType","editorType"])]),T(ya,{ref_key:"editorDrawBoardSettingDom",ref:o,editorType:l.editorType},null,8,["editorType"]),T(Ua,{ref_key:"editorLayerSettingDom",ref:r,staticsList:l.staticsList,promptsList:l.promptsList,colorsList:l.colorsList,textsList:l.textsList,onSave:W},null,8,["staticsList","promptsList","colorsList","textsList"]),T(Ka,{onReplaceImage:X,ref_key:"imageGenerateDom",ref:u},null,512),T(dl,{ref_key:"editorTextSettingDom",ref:g},null,512),T(pl,{ref_key:"editorColorSettingDom",ref:f},null,512),T(Ol,{ref_key:"editorElementSettingDom",ref:b},null,512),T(Fl,{ref_key:"editorAdvancedSettingDom",ref:x},null,512)]))}},[["__scopeId","data-v-6e48476c"]]),ri={class:"model-editor"},di=G({__name:"index",props:{setting:{},staticsList:{type:Array,default:()=>[]},promptsList:{type:Array,default:()=>[]},colorsList:{type:Array,default:()=>[]},textsList:{type:Array,default:()=>[]},templateId:{type:Number,default:null},info:{type:Object,default:()=>({template_filter:"normal",template_level:"normal",points:1})},layerData:{},editorType:{}},setup(e){c(_t);const t=e,a=c(null),l=c(null),i=c([]),n=c([]),s=e=>{i.value=e},o=(...e)=>{a.value.setSelectedLayer(...e)},r=e=>{n.value=e},d=(...e)=>{a.value.toSettingLayer(...e)},u=e=>{a.value.deleteGroup(e)},v=e=>{a.value.deleteLayer(e)},p=e=>{a.value.deleteElement(e)},g=e=>{a.value.setGroup(e)},y=e=>{a.value.hideLayer(e)},f=(...e)=>{a.value.reGenerateGroup(...e)},w=(...e)=>{a.value.reGenerateLayer(...e)},b=(...e)=>{a.value.reGenerateElement(...e)},x=(...e)=>{l.value.setSelectedElement(...e)},D=()=>{a.value.setDiagramImage()};return(c,k)=>(h(),m("div",ri,[T(oi,{staticsList:t.staticsList,promptsList:t.promptsList,colorsList:t.colorsList,textsList:t.textsList,ref_key:"modelDrawBoardDom",ref:a,onSetTypeList:s,onSetGroupList:r,onSetSelectedElement:x,setting:t.setting,editorType:t.editorType,layerData:t.layerData,templateId:e.templateId},null,8,["staticsList","promptsList","colorsList","textsList","setting","editorType","layerData","templateId"]),T(Bt,{ref_key:"editorLayersDom",ref:l,typeList:i.value,groupList:n.value,onToLayerInfo:d,onSetSelectedLayer:o,onDeleteGroup:u,onDeleteLayer:v,onDeleteElement:p,onSetGroup:g,onHideLayer:y,onReGenerateGroup:f,onReGenerateLayer:w,onReGenerateElement:b,onSetDiagramImage:D,editorType:t.editorType},null,8,["typeList","groupList","editorType"])]))}},[["__scopeId","data-v-e5170316"]]),ui={__name:"index",setup(e){const t=L(),a=c([]),l=c([]),s=c([]),o=c([]),r=c({template_filter:"nomal",template_level:"nomal",points:1}),d=c(!1),u=c(t.query.template_id?Number(t.query.template_id):null),m=c({canvasData:{name:t.query.file_name||"",width:2048,height:2048}}),v=c({groups:{},layers:{},elements:{}});z((()=>t.query.template_id),((e,t)=>{u.value=e,d.value=!1,A((()=>{d.value=!0}))}));const p=()=>{window.loading||(window.loading=P()),Promise.all([new Promise((e=>{i("colors").then((t=>{s.value=t.data,e()}))})),new Promise((e=>{i("texts").then((t=>{o.value=t.data,e()}))})),new Promise((e=>{i("prompts").then((t=>{a.value=t.data,e()}))})),new Promise((e=>{i("statics").then((t=>{l.value=t.data,e()}))})),new Promise((e=>{m.value.canvasData.name?n(u.value,"layouts",m.value.canvasData.name).then((t=>{m.value=Object.assign(m.value,t.data.viewData),v.value=t.data.layerData,r.value=t.info,e()})):e()}))]).then((()=>{d.value=!0,window.loading.close(),window.loading=null}))};return M((()=>{p()})),(e,t)=>d.value?(h(),k(di,{key:0,colorsList:s.value,textsList:o.value,editorType:"edit",promptsList:a.value,staticsList:l.value,setting:m.value,layerData:v.value,templateId:u.value,info:r.value},null,8,["colorsList","textsList","promptsList","staticsList","setting","layerData","templateId","info"])):w("",!0)}};export{ui as default};
