import{$ as t,N as e,a0 as s,r as i,o as a,z as n,e as h,c as r,g as l,F as o,B as d,h as c,n as m,b as u,q as p,A as y,j as g,w as v,u as w,i as L,T as f,a1 as T,a2 as E}from"./lib.5034c038.js";import{T as P,_ as k}from"./index.8c6e66d9.js";class b{constructor(){this.listeners={}}addListener(e,s,i){e.addEventListener(s,i);const a=t();return this.listeners[a]={element:e,eventType:s,listener:i},a}removeAllListeners(){for(var t in this.listeners)this.removeListenter(t);this.listeners={}}removeListenter(t){var e=this.listeners[t];e.element.removeEventListener(e.eventType,e.listener),delete this.listeners[t]}}class S{constructor(){this.typeList={}}add({name:e,image:s}){const i=t();return new Promise((t=>{if(s){const a=new Image;a.src=s,a.crossOrigin="Anonymous",a.onload=()=>{this.typeList[i]={name:e,image:a,imageBase64:s,layerInfo:{},loraInfo:{prompts:[],statics:[]}},t(this.typeList)}}else this.typeList[i]={name:e,image:null,imageBase64:null,layerInfo:{},loraInfo:{prompts:[],statics:[]}},t(this.typeList)}))}delete(t){return new Promise(((e,s)=>{try{delete this.typeList[t],e(this.typeList)}catch(i){s()}}))}edit(t,e){return new Promise((s=>{this.typeList[t]=e,s(this.typeList)}))}changeImage(t,e){return new Promise((s=>{const i=new Image;i.src=e,i.crossOrigin="Anonymous",i.onload=()=>{this.typeList[t].image=i,s(i)}}))}get(t){return this.typeList[t]}getAll(){return this.typeList}bindElement(t,{elementUuid:e}){return new Promise((s=>{this.typeList[t].layerInfo[e]=null}))}unBindElement(t,{elementUuid:e}){return new Promise(((s,i)=>{try{delete this.typeList[t].layerInfo[e],s(this.typeList)}catch(a){i()}}))}getSaveData(){let t=JSON.parse(JSON.stringify(this.typeList));return Object.keys(t).forEach((e=>{delete t[e].image})),t}setData(t){return this.typeList=t,new Promise((e=>{let s=0;const i=Object.keys(t);i.forEach((a=>{if(t[a].imageBase64){const n=new Image;n.src=t[a].imageBase64,n.crossOrigin="Anonymous",n.onload=()=>{s++,this.typeList[a].image=n,s===i.length&&e(this.typeList)}}else s++,s===i.length&&e(this.typeList)}))}))}bindLora(t,e,s="prompts"){this.typeList[t].loraInfo[s]=e}}class C{constructor(){this.groupList={}}add(){const e=t();return this.groupList[e]={loraInfo:{prompts:[],statics:[]},layers:[]},this.getAll()}update(t,e){return delete(e=JSON.parse(JSON.stringify(e))).uuid,this.groupList[t]=e,this.getAll()}getAll(){return Object.keys(this.groupList).map((t=>Object.assign({uuid:t},this.groupList[t])))}delete(t){return delete this.groupList[t],this.getAll()}getSaveData(){return this.groupList}setData(t){this.groupList=t}deleteLayer(t){const{groupList:e}=this;return Object.keys(e).forEach((s=>{const i=new Set(e[s].layers);i.has(t)&&(i.delete(t),this.groupList[s].layers=[...i])})),this.getAll()}}const I="start",x="finish",M={HANDLE:"操作",DRAWING:"绘制"},O={NOMAL:"定位花",AGENT_X:"横向二方连续",AGENT_Y:"纵向二方连续",AGENT_F:"四方连续"};function A(t,e,s,i=0,a=0){const n=[[-t/2,-e/2],[t/2,-e/2],[t/2,e/2],[-t/2,e/2]].map((([t,e])=>{const n=Math.cos(s),h=Math.sin(s);return[i+(t*n-e*h),a+(t*h+e*n)]}));let h=1/0,r=-1/0,l=1/0,o=-1/0;return n.forEach((([t,e])=>{h=Math.min(h,t),r=Math.max(r,t),l=Math.min(l,e),o=Math.max(o,e)})),{width:r-h,height:o-l}}function N([t,e],[s,i]){return t>0&&t<s&&e>0&&e<i}class D{constructor(e,s,i,{x:a,y:n},h){this.uuid=t(),this.ctx=e,this.typeUuid=s,this.width=0,this.height=0,this.x=a,this.y=n,this.drawX=0,this.drawY=0,this.rotate=0,this.image=i,this.drawType=h,this.status=I,this.handleType=null,this.handleSetting={},this.virtuallyElements=[],this.draw()}setImage(t){this.image=t}setElementPosition(t){const{x:e,y:s}=t;this.x=e,this.y=s,this.width=t.width||this.width,this.height=t.height||this.height}setElementSize({newX:t,newY:e}){const{x:s,y:i}=this;let a=s>t?{startX:t,finishX:s}:{startX:s,finishX:t},n=i>e?{startY:e,finishY:i}:{startY:i,finishY:e};const{startX:h,finishX:r}=a,{startY:l,finishY:o}=n;this.drawX=h,this.drawY=l,this.width=r-h,this.height=o-l}finishSetting(){this.status=x,this.x=this.drawX,this.y=this.drawY}draw(){const{virtuallyElements:t,drawX:e,drawY:s}=this;this.drawItem(e,s),t.forEach((([t,e])=>{this.drawItem(t,e)}))}drawItem(t,e){const{ctx:s,width:i,height:a,image:n,rotate:h}=this;(i||a)&&(s.beginPath(),s.save(),s.lineWidth=1,s.fillStyle="#222",s.translate(t+i/2,e+a/2),h&&s.rotate(h),n?s.drawImage(n,-i/2,-a/2,i,a):(s.rect(-i/2,-a/2,i,a),s.stroke(),s.fill()),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath())}checkPointIsIn({clickX:t,clickY:e}){const{virtuallyElements:s,drawX:i,drawY:a}=this;let n=!1;if(n=this.checkPointIsInItem({clickX:t,clickY:e},i,a),n)return n;for(let h of s){const[s,i]=h;if(n=this.checkPointIsInItem({clickX:t,clickY:e},s,i),n)break}return n}checkPointIsInItem({clickX:t,clickY:e},s,i){const{ctx:a,width:n,height:h,rotate:r}=this;a.beginPath(),a.save(),a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.rect(-n/2,-h/2,n,h),a.translate(-(s+n/2),-(i+h/2)),r&&a.rotate(-r);let l=!!a.isPointInPath(t,e)&&"main";return a.restore(),a.closePath(),l}checkHandle({handleX:t,handleY:e}){const{virtuallyElements:s,drawX:i,drawY:a}=this;if(this.checkHandleItem({handleX:t,handleY:e},i,a),this.handleType)return this.handleType;for(let n of s){const[s,i]=n;if(this.checkHandleItem({handleX:t,handleY:e},s,i),this.handleType)break}return this.handleType}checkHandleItem({handleX:t,handleY:e},s,i){const{ctx:a,width:n,height:h,rotate:r}=this;a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(5,-h/2-25),a.arc(0,-h/2-25,5,0,2*Math.PI),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2));let l=a.isPointInPath(t,e);return l&&(this.handleType="rotate"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(-n/2-5,-h/2-10),a.arc(-n/2-10,-h/2-10,5,0,2*Math.PI),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="left-top"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(n/2+15,-h/2-10),a.arc(n/2+10,-h/2-10,5,0,2*Math.PI),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="right-top"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(n/2+15,h/2+10),a.arc(n/2+10,h/2+10,5,0,2*Math.PI),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="right-bottom"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(-n/2-5,h/2+10),a.arc(-n/2-10,h/2+10,5,0,2*Math.PI),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="left-bottom"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.rect(-n/2-5,-h/2-12,n+10,5),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="top"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.rect(n/2+8,-h/2-5,5,h+10),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="right"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.rect(-n/2-5,h/2+8,n+10,5),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="bottom"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.rect(-n/2-12,-h/2-5,5,h+10),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),l=a.isPointInPath(t,e),l&&(this.handleType="left"),a.restore(),a.closePath(),a.beginPath(),a.save(),a.lineWidth=1,a.strokeStyle="#000",a.translate(s+n/2,i+h/2),r&&a.rotate(r),a.moveTo(0,-h/2-10),a.lineTo(0,-h/2-20),a.stroke(),r&&a.rotate(-r),a.translate(-(s+n/2),-(i+h/2)),a.restore(),a.closePath(),l=this.checkPointIsIn({clickX:t,clickY:e}),l&&(this.handleType="main"),this.handleType}drawHandleArea(){const{virtuallyElements:t,drawX:e,drawY:s}=this;this.drawHandleAreaItem(e,s),t.forEach((([t,e])=>{this.drawHandleAreaItem(t,e)}))}drawHandleAreaItem(t,e){const{ctx:s,width:i,height:a,image:n,rotate:h}=this;s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(5,-a/2-25),s.arc(0,-a/2-25,5,0,2*Math.PI),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(-i/2-5,-a/2-10),s.arc(-i/2-10,-a/2-10,5,0,2*Math.PI),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(i/2+15,-a/2-10),s.arc(i/2+10,-a/2-10,5,0,2*Math.PI),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(i/2+15,a/2+10),s.arc(i/2+10,a/2+10,5,0,2*Math.PI),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(-i/2-5,a/2+10),s.arc(-i/2-10,a/2+10,5,0,2*Math.PI),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(i/2+5,-a/2-10),s.lineTo(-i/2-5,-a/2-10),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(i/2+10,-a/2-5),s.lineTo(i/2+10,a/2+5),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(-i/2-5,a/2+10),s.lineTo(i/2+5,a/2+10),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(-i/2-10,-a/2-5),s.lineTo(-i/2-10,a/2+5),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath(),s.beginPath(),s.save(),s.lineWidth=1,s.strokeStyle="#000",s.translate(t+i/2,e+a/2),h&&s.rotate(h),s.moveTo(0,-a/2-10),s.lineTo(0,-a/2-20),s.stroke(),h&&s.rotate(-h),s.translate(-(t+i/2),-(e+a/2)),s.restore(),s.closePath()}getUuid(){return this.uuid}clearHandleType(){this.handleType=null}handleStart({x:t,y:e}){this.handleSetting={x:t,y:e}}handleMove({x:t,y:e}){switch(this.handleType){case"main":this.mainMove(t,e);break;case"left-top":this.leftTopMove(t,e);break;case"top":this.topMove(t,e);break;case"right-top":this.rightTopMove(t,e);break;case"right":this.rightMove(t,e);break;case"right-bottom":this.rightBottomMove(t,e);break;case"bottom":this.bottomMove(t,e);break;case"left-bottom":this.leftBottomMove(t,e);break;case"left":this.leftMove(t,e);break;case"rotate":this.rotateMove(t,e)}}handleEnd({x:t,y:e}){this.handleMove({x:t,y:e}),this.x=this.drawX,this.y=this.drawY,this.clearHandleType()}mainMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t,n=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.drawX-=a,this.drawY-=n}leftTopMove(t,e){const{x:s,y:i,rotate:a}=this.handleSetting;let n=s-t,h=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.width+n<0||(this.width+=n,this.drawX-=n),this.height+h<0||(this.height+=h,this.drawY-=h)}topMove(t,e){const{x:s,y:i}=this.handleSetting,a=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.height+a<0||(this.height+=a,this.drawY-=a)}rightTopMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t,n=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.width-a<0||(this.width-=a),this.height+n<0||(this.height+=n,this.drawY-=n)}rightMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t;this.handleSetting.x=t,this.handleSetting.y=e,this.width-a<0||(this.width-=a)}rightBottomMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t,n=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.width-a<0||(this.width-=a),this.height-n<0||(this.height-=n)}bottomMove(t,e){const{x:s,y:i}=this.handleSetting,a=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.height-a<0||(this.height-=a)}leftBottomMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t,n=i-e;this.handleSetting.x=t,this.handleSetting.y=e,this.width+a<0||(this.width+=a,this.drawX-=a),this.height-n<0||(this.height-=n)}leftMove(t,e){const{x:s,y:i}=this.handleSetting,a=s-t;this.handleSetting.x=t,this.handleSetting.y=e,this.width+a<0||(this.width+=a,this.drawX-=a)}rotateMove(t,e){const{x:s,y:i}=this.handleSetting;this.handleSetting.x=t,this.handleSetting.y=e;let a=function([t,e],[s,i],[a,n]){const h=s-t,r=i-e,l=a-t,o=n-e;let d=(h*l+r*o)/(Math.sqrt(h*h+r*r)*Math.sqrt(l*l+o*o));if(isNaN(d))return 0;let c=Math.acos(d);return h*o-r*l<0&&(c=-c),isNaN(c)?Math.PI/1800:Number(c.toFixed(2))}([this.x+this.width/2,this.y+this.height/2],[s,i],[t,e]);this.rotate+=a}getSaveData(){return{width:this.width,height:this.height,x:this.x,y:this.y,rotate:this.rotate,uuid:this.uuid,typeUuid:this.typeUuid}}setData(t,e){const{uuid:s,image:i,width:a,height:n,x:h,y:r,rotate:l,typeUuid:o}=t;this.uuid=s,this.image=i,this.width=a*e,this.height=n*e,this.x=h*e,this.drawX=h*e,this.y=r*e,this.drawY=r*e,this.rotate=l,this.typeUuid=o,this.status=x}setDrawType(t,e,s){this.drawType=t,this.recomputationPosition({width:e,height:s})}recomputationPosition({width:t,height:e}){const{drawType:s}=this;switch(s){case O.NOMAL:this.virtuallyElements=[],this.recomputationMainPosition(t,e);break;case O.AGENT_X:this.virtuallyElements=[],this.recomputationAgentXPosition(t),this.recomputationMainPosition(t,e);break;case O.AGENT_Y:this.virtuallyElements=[],this.recomputationAgentYPosition(e),this.recomputationMainPosition(t,e);break;case O.AGENT_F:this.virtuallyElements=[],this.recomputationAgentFPosition(t,e),this.recomputationMainPosition(t,e)}}recomputationMainPosition(t,e){const{virtuallyElements:s,drawX:i,drawY:a,width:n,height:h}=this;s.length&&(N([i+n/2,a+h/2],[t,e])||JSON.parse(JSON.stringify(s)).forEach(((s,i)=>{const[a,r]=s;N([a+n/2,r+h/2],[t,e])&&(this.virtuallyElements[i]=[this.drawX,this.drawY],this.drawX=a,this.drawY=r)})))}recomputationAgentXPosition(t){const{drawX:e,drawY:s,width:i,height:a,rotate:n}=this;let h=i;n&&(h=A(i,a,n).width),e+i/2+h/2>t?this.virtuallyElements.push([e-t,s]):e+i/2-h/2<0&&this.virtuallyElements.push([t+e,s])}recomputationAgentYPosition(t){const{drawX:e,drawY:s,width:i,height:a,rotate:n}=this;let h=a;n&&(h=A(i,a,n).height),s+a/2+h/2>t?this.virtuallyElements.push([e,s-t]):s+a/2-h/2<0&&this.virtuallyElements.push([e,t+s])}recomputationAgentFPosition(t,e){this.recomputationAgentXPosition(t),this.recomputationAgentYPosition(e);const{virtuallyElements:s,drawX:i,drawY:a,width:n,height:h}=this;2===s.length&&(i===s[0][0]?this.virtuallyElements.push([s[1][0],s[0][1]]):this.virtuallyElements.push([s[0][0],s[1][1]]))}resize(t){this.width*=t,this.height*=t,this.x*=t,this.drawX*=t,this.y*=t,this.drawY*=t}}function Y(t,e,s){const i=t.split(";base64,"),a=i[0].split(":")[1],n=atob(i[1]);let h=n.length;const r=new Uint8Array(h);for(;h--;)r[h]=n.charCodeAt(h);const l=X(t,e,s);return new File([l],`${e}${o=s||a,{"image/jpeg":".jpg","image/png":".png","image/gif":".gif","application/pdf":".pdf"}[o]||".bin"}`,{type:s||a,lastModified:Date.now()});var o}function X(t,e,s){const i=t.split(";base64,"),a=i[0].split(":")[1],n=atob(i[1]);let h=n.length;const r=new Uint8Array(h);for(;h--;)r[h]=n.charCodeAt(h);return new Blob([r],{type:s||a})}function j(t,s){const i=Object.keys(t).some((e=>t[e]===s));return i||e.error("非法value"),i}class U{constructor(t,{width:e,height:s,name:i},a=null){this.canvasOuterDom=t,this.width=e,this.height=s,this.rootFont=window.rootFont,this.realWidth=e,this.realHeight=s,this.name=i,this.proportion=1,this.editorTypeController=new S,this.editorGroupController=new C,this.listeners=new b,this.handleType=M.HANDLE,this.elementsList={},this.selectedElement=null,this.hideLayerList=[],this.drawType=O.NOMAL,this.initCanvas(),this.addListener()}addListener(){this.listeners.addListener(this.canvas,"mousedown",(t=>{this.mousedown(t)})),this.listeners.addListener(this.canvas,"mousemove",(t=>{this.mousemove(t)})),this.listeners.addListener(this.canvas,"mouseup",(t=>{this.mouseup(t)})),this.listeners.addListener(this.canvas,"mouseleave",(t=>{this.mouseup(t)})),this.listeners.addListener(this.canvas,"dblclick",(t=>{this.mouseclick(t)})),this.listeners.addListener(window,"resize",(()=>{this.windowResize()}))}removeListener(){this.listeners.removeAllListeners()}initCanvas(){const{canvasOuterDom:t}=this;this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.margin="auto",this.canvas.style.left="0",this.canvas.style.top="0",this.canvas.style.right="0",this.canvas.style.bottom="0",this.canvas.style.backgroundColor="var(--t-sub-color)",t.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.setCanvasSize(this)}setCanvasSize({width:t,height:e,name:s}){const{canvasOuterDom:i}=this;this.realWidth=t,this.realHeight=e,this.name=s;let a=i.clientWidth,n=i.clientHeight;t/e>a/n?(e=e*a/t,this.proportion=t/a,t=a):(t=t*n/e,this.proportion=e/n,e=n),this.canvas.width=t,this.canvas.height=e,this.canvas.style.width=t/window.rootFont+"rem",this.canvas.style.height=e/window.rootFont+"rem",this.width=t,this.height=e,this.initDraw()}mousedown(t){const{offsetX:s,offsetY:i}=t;if(this.handleType===M.DRAWING){if(!this.typeUuid)return e.error("请选择类型后操作"),this.handleType;const t=this.editorTypeController.get(this.typeUuid).image;let a=new D(this.ctx,this.typeUuid,t,{x:s,y:i},this.drawType);const n=a.getUuid();this.elementsList[n]=a,this.editorTypeController.bindElement(this.typeUuid,{elementUuid:n})}else if((this.handleType=M.HANDLE)&&this.selectedElement){this.elementsList[this.selectedElement].checkHandle({handleX:s,handleY:i})&&this.elementsList[this.selectedElement].handleStart({x:s,y:i})}}mousemove(t){const{offsetX:e,offsetY:s}=t,i=Object.keys(this.elementsList);this.handleType===M.DRAWING?i.length&&"start"===this.elementsList[i[i.length-1]].status&&(this.elementsList[i[i.length-1]].setElementSize({newX:e,newY:s}),this.reDraw()):(this.handleType=M.HANDLE)&&this.selectedElement&&this.elementsList[this.selectedElement].handleType&&(this.elementsList[this.selectedElement].handleMove({x:e,y:s}),this.reDraw())}mouseup(t){const{offsetX:e,offsetY:s}=t,i=Object.keys(this.elementsList);this.handleType===M.DRAWING?i.length&&"start"===this.elementsList[i[i.length-1]].status&&(this.elementsList[i[i.length-1]].setElementSize({newX:e,newY:s}),this.elementsList[i[i.length-1]].finishSetting(),this.reDraw()):(this.handleType=M.HANDLE)&&this.selectedElement&&this.elementsList[this.selectedElement].handleType&&this.elementsList[this.selectedElement].handleEnd({x:e,y:s})}mouseclick(t){const{offsetX:e,offsetY:s}=t;if(!(this.handleType!==M.HANDLE||this.selectedElement&&this.elementsList[this.selectedElement].handleType)){const t=this.editorTypeController.getAll(),i=Object.keys(t).reverse();let a=new Set(this.hideLayerList),n=i.map((e=>{if(a.has(e))return[];return Object.keys(t[e].layerInfo)})).flat();this.selectedElement=null;for(let h of n)if(this.elementsList[h].checkPointIsIn({clickX:e,clickY:s})){this.selectedElement=h;break}this.reDraw()}}draw(){const{width:t,height:e}=this;let s=new Set(this.hideLayerList);const i=this.editorTypeController.getAll();Object.keys(i).forEach((a=>{s.has(a)||Object.keys(i[a].layerInfo).forEach((s=>{this.elementsList[s].recomputationPosition({width:t,height:e}),this.elementsList[s].draw()}))})),this.selectedElement&&this.elementsList[this.selectedElement].drawHandleArea()}reDraw(){const{ctx:t,width:e,height:s}=this;t.clearRect(0,0,e,s),this.draw()}initDraw(){this.reDraw()}addType(t){return new Promise((e=>{this.editorTypeController.add(t).then((t=>{e(t)}))}))}getAllType(){return this.editorTypeController.getAll()}getAllLayerImage(){return new Promise((t=>{const e=this.editorTypeController.getAll(),s=this.selectedElement;this.selectedElement=null;const i=Object.keys(e),a=JSON.parse(JSON.stringify(this.hideLayerList));this.getLayerImageItem(i).then((e=>{this.hideLayerList=a,this.selectedElement=s,this.reDraw(),t(e)}))}))}getLayerImageItem(t,e=0,s={}){return new Promise((i=>{if(!t.length)return void i(s);const a=t[e];let n=new Set(JSON.parse(JSON.stringify(t)));n.delete(a),this.hideLayerList=[...n],this.reDraw(),s[a]={name:this.editorTypeController.get(a).name,imageBase64:this.canvas.toDataURL()},++e===t.length?i(s):i(this.getLayerImageItem(t,e,s))}))}changeHandleType(t){return j(M,t)?Object.keys(this.editorTypeController.getAll()).length?(this.selectedElement=null,this.handleType=t,this.reDraw(),this.handleType):(e.error("请设置类型后操作"),this.handleType):this.handleType}getHandleType(){return this.handleType}setTypeUuid(t){this.typeUuid=t}setName(t){this.name=t}hideHandle(t){let e=new Set(this.hideLayerList);return e.has(t)?e.delete(t):(e.add(t),this.selectedElement&&(this.selectedElement=null)),this.hideLayerList=[...e],this.reDraw(),this.hideLayerList}getSaveData(e=!0,i=!1){const{canvas:a}=this;return new Promise((n=>{const h={elementData:Object.keys(this.elementsList).map((t=>this.elementsList[t].getSaveData())),typeData:this.editorTypeController.getSaveData(),canvasData:{width:this.realWidth,height:this.realHeight,drawType:this.drawType,name:this.name,proportion:this.proportion},groupData:this.editorGroupController.getSaveData()};if(!e){const t=a.toDataURL("image/png");return h.preview=t,void n(h)}let r="";if(i){const t=s.lib.WordArray.random(16),e="TEART_SECRET_KEY";r=s.AES.encrypt(JSON.stringify(h),s.enc.Utf8.parse(e),{iv:t}).toString(),r=`${t},${r}`}else r=JSON.stringify(h,null,2);const l=new Blob([r],{type:i?"application/teart-model":"application/json"}),o=URL.createObjectURL(l),d=document.createElement("a");d.href=o,d.download=`${t()}.${i?"trt":"json"}`,document.body.appendChild(d),d.click()}))}setData({elementData:t,typeData:e,canvasData:s,groupData:i}){return new Promise((a=>{this.setCanvasSize(s);const n=s.proportion/this.proportion;this.drawType=s.drawType,this.hideLayerList=[],this.handleType=null,this.selectedElement=null,this.editorGroupController.setData(i);const h=this.editorGroupController.getAll();this.editorTypeController.setData(e).then((e=>{this.elementsList={},t.forEach((t=>{const{typeUuid:s}=t;t.image=e[s].image;const i=new D(this.ctx,s,null,{x:0,y:0},this.drawType);i.setData(t,n);const a=i.getUuid();this.elementsList[a]=i})),this.reDraw(),a({typeList:e,groups:h})}))}))}getCanvasStyle(){return{width:this.width/window.rootFont*.8+"rem",height:this.height/window.rootFont*.8+"rem"}}changeDrawType(t){j(O,t)&&(this.drawType=t,Object.keys(this.elementsList).forEach((e=>{this.elementsList[e].setDrawType(t,this.width,this.height)})),this.reDraw())}getDrawType(){return this.drawType}getTypeList(){return this.editorTypeController.getAll()}bindLora(...t){this.editorTypeController.bindLora(...t)}changeImage(t,e){return new Promise((s=>{this.editorTypeController.changeImage(t,e).then((e=>{const i=this.editorTypeController.get(t).layerInfo;Object.keys(i).forEach((t=>{this.elementsList[t].setImage(e)})),this.reDraw(),s()}))}))}windowResize(){const t=window.rootFont/this.rootFont;this.rootFont=window.rootFont,this.canvas.width*=t,this.canvas.height*=t,this.width=this.canvas.width,this.height=this.canvas.height,Object.keys(this.elementsList).forEach((e=>{this.elementsList[e].resize(t)})),this.reDraw()}exportImage(){const{realWidth:t,realHeight:e,width:s,height:i}=this,a=t/s,n=P();this.canvas.width=t,this.canvas.height=e,this.width=this.canvas.width,this.height=this.canvas.height,Object.keys(this.elementsList).forEach((t=>{this.elementsList[t].resize(a)})),this.reDraw();const h=X(this.canvas.toDataURL("image/png"),this.name),r=URL.createObjectURL(h),l=document.createElement("a");l.href=r,l.download=`${this.name}.png`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(r),setTimeout((()=>{this.width=s,this.height=i,this.canvas.width=s,this.canvas.height=i,Object.keys(this.elementsList).forEach((t=>{this.elementsList[t].resize(1/a)})),this.reDraw(),n.close()}),600)}addGroup(){return this.editorGroupController.add()}updateGroup(t,e){return this.editorGroupController.update(t,e)}deleteGroup(t){return this.editorGroupController.delete(t)}deleteType(t){return new Promise((e=>{const{layerInfo:s}=this.editorTypeController.get(t);Object.keys(s).forEach((t=>{delete this.elementsList[t]})),this.reDraw(),this.editorTypeController.delete(t).then((s=>{const i=this.editorGroupController.deleteLayer(t);e({typeList:s,groups:i})}))}))}}const W=["onClick"],H={key:0,class:"explosion-line-1"},R={class:"explosion-prompt-item"},G={class:"explosion-item-name"},z={class:"explosion-prompt-edit-btn"},F={key:0,class:"explosion-prompt-info"},_={key:1,class:"explosion-prompt-info"},B={class:"explosion-diagram-item"},J={key:0,class:"explosion-name"},$=["onClick"],q={class:"explosion-image"},K=["src"];var V=k({__name:"explosionDiagram",props:{data:{type:Array,default:()=>[]},widthPrompt:{type:Boolean,default:()=>!1},explosionStyle:{type:Object,default:()=>({width:"5rem",height:"7rem"})}},setup(t,{expose:s}){const P=t,k=i(null),b=i(null),S=i(null),C=i(null),I=i(null),x=i(""),M={COMMENCE:"commence",INCORPORATION:"incorporation"},O=i(M.COMMENCE),A=t=>{M.hasOwnProperty(t)||"CHANGE"===t?(b.value=null,"CHANGE"===t?O.value===M.COMMENCE?O.value=M.INCORPORATION:O.value=M.COMMENCE:O.value=M[t]):e.error("非法参数")},N=t=>O.value===M.COMMENCE?Object.assign({left:2*t-P.data.length+"rem",top:-.5*t+"rem",zIndex:P.data.length-t-1},P.explosionStyle):Object.assign({left:"0rem",top:"0rem",transform:"skewY(0deg)",zIndex:P.data.length-t-1,backgroundColor:t===P.data.length-1?"var(--t-sub-color)":"transparent"},P.explosionStyle),D=t=>S.value===t?{hiding:!0}:C.value===t?{showing:!0}:k.value===t?{show:!0}:k.value!==t?{hide:!0}:void 0;return a((()=>{P.data.length&&(k.value=0)})),s({changeExplosionType:A}),(e,s)=>{const i=n("el-icon"),a=n("t-button");return h(),r("div",{class:"explosion-diagram-body",style:m({paddingTop:(O.value===M.COMMENCE?.5*P.data.length:0)+"rem"})},[l("div",{class:"explosion-all",style:m(P.explosionStyle)},[(h(!0),r(o,null,d(P.data,((e,n)=>(h(),r(o,null,[b.value===n||O.value===M.COMMENCE||!b.value&&0!==b.value&&O.value===M.INCORPORATION?(h(),r("div",{class:c(["explosion-item",{selected:O.value===M.COMMENCE&&k.value===n}]),key:e.uuid,onClick:t=>(t=>new Promise((e=>{O.value===M.COMMENCE&&k.value!==t?(I.value=null,null!==k.value&&(S.value=k.value),C.value=t,setTimeout((()=>{k.value=C.value,C.value=null})),setTimeout((()=>{S.value=null,e()}),200)):e()})))(n),style:m(N(n))},[O.value===M.COMMENCE||null!==b.value?(h(),r("div",{key:0,class:c(["explosion-diagram-handle-area",Object.assign(D(n),{nomal:null!==b.value})])},[t.widthPrompt?(h(),r("div",H)):u("",!0),t.widthPrompt?(h(),r("div",{key:1,class:"explosion-line-2",style:m({width:1.5*(O.value===M.COMMENCE||null===b.value?P.data.length-n:1)+"rem"})},null,4)):u("",!0),t.widthPrompt?(h(),r("div",{key:2,class:"explosion-prompt-area",style:m({left:1.5*(O.value===M.COMMENCE||null===b.value?P.data.length-n:1)+1+"rem"})},[l("div",R,[l("div",G,[p(y(e.name)+" ",1),l("div",z,[g(i,{class:"explosion-prompt-edit-item",onClick:L((t=>(t=>{x.value=P.data[t].prompt,I.value=t})(n)),["stop"])},{default:v((()=>[g(w(E))])),_:2},1032,["onClick"])])]),I.value!==n?(h(),r("div",F,y(e.prompt),1)):u("",!0),I.value===n?(h(),r("div",_,[f(l("textarea",{"onUpdate:modelValue":s[0]||(s[0]=t=>x.value=t)},null,512),[[T,x.value]])])):u("",!0),l("div",{class:"explosion-prompt-save-handle-area",style:m({height:I.value===n?"0.8rem":"0rem"})},[g(a,{type:"info",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"},onClick:s[1]||(s[1]=t=>I.value=null)},{default:v((()=>[p("取消")])),_:1}),g(a,{type:"success",size:"min",style:{margin:"0",padding:"0.2rem 0.4rem"}},{default:v((()=>[p("生成")])),_:1})],4)])],4)):u("",!0)],2)):u("",!0),l("div",B,[O.value===M.COMMENCE?(h(),r("div",J,y(e.name),1)):u("",!0),null!==b.value||O.value===M.COMMENCE?(h(),r("div",{key:1,class:"show-explosion-item-handle-btn",onClick:L((t=>(t=>{null===b.value&&O.value===M.COMMENCE?(A("INCORPORATION"),b.value=t):null!==b.value&&(A("COMMENCE"),b.value=null),k.value=t})(n)),["stop"]),style:m({top:(O.value===M.COMMENCE?"1.2":"0.2")+"rem"})},y(null!==b.value?"隐藏":"展示"),13,$)):u("",!0),l("div",q,[l("img",{src:e.imageSrc},null,8,K)])])],14,W)):u("",!0)],64)))),256))],4)],4)}}},[["__scopeId","data-v-1cb1b868"]]);export{O as D,M as H,U as M,Y as b,V as e};
