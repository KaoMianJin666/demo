import{r as e,z as a,e as l,f as t,w as u,j as i,q as o,b as n,M as s,x as d,o as r,c as v,g as m,F as p,B as c,u as y,A as f,S as g,T as h,h as b,i as w,I as _,U as k,V as D,W as C,s as V,t as T}from"./lib.078cc1de.js";import{D as j,M as x,e as S,H as I,b as L}from"./explosionDiagram.4caebe97.js";import{r as U,_ as O,T as A,g as E,s as N}from"./index.51a089e0.js";const B={__name:"addType",emits:["addType"],setup(d,{expose:r,emit:v}){const m=v,p=e(!1),c=e(null),y=e(null),f=()=>{m("addType",{name:c.value,image:y.value}),p.value=!1},g=e=>{if("image/png"!==e.type)return void s.error("请上传png格式图片");const a=new FileReader;return a.onload=({target:e})=>{y.value=e.result},a.readAsDataURL(e),!1};return r({init:e=>{c.value=null,y.value=null,e&&(c.value=e.name,y.value=e.image),p.value=!0}}),(e,s)=>{const d=a("el-input"),r=a("el-form-item"),v=a("el-button"),m=a("el-upload"),h=a("el-image"),b=a("el-form"),w=a("el-dialog");return l(),t(w,{modelValue:p.value,"onUpdate:modelValue":s[1]||(s[1]=e=>p.value=e),title:"图层管理",width:"400px"},{footer:u((()=>[i(v,{onClick:f},{default:u((()=>[o("保存")])),_:1})])),default:u((()=>[i(b,{"label-width":"100px"},{default:u((()=>[i(r,{label:"类型名称",required:""},{default:u((()=>[i(d,{modelValue:c.value,"onUpdate:modelValue":s[0]||(s[0]=e=>c.value=e)},null,8,["modelValue"])])),_:1}),i(r,{label:"类型图片"},{default:u((()=>[i(m,{class:"upload-demo","before-upload":g,accept:".png","show-file-list":!1,action:""},{default:u((()=>[i(v,{type:"primary"},{default:u((()=>[o("上传图片")])),_:1})])),_:1})])),_:1}),y.value?(l(),t(r,{key:0,label:"图片预览"},{default:u((()=>[i(h,{src:y.value,"preview-src-list":[y.value],style:{width:"100px",height:"100px"}},null,8,["src","preview-src-list"])])),_:1})):n("",!0)])),_:1})])),_:1},8,["modelValue"])}}};function F(e,a){return U.post(`/teai/upload?file_id=${e}`,a)}const H=e=>(V("data-v-5b98534c"),e=e(),T(),e),M={class:"model-editor"},R={class:"handle-area"},q={class:"handle-btn-area"},z={class:"model-editor-area"},G={class:"group-list"},J=H((()=>m("div",{class:"group-list-title"},"图层",-1))),W={class:"group-list-info"},$=["onClick"],K=["onClick"],P={key:0,class:"layer-item-image"},Q=["src"],X={class:"layer-item-name"},Y={key:0,class:"lora-info"},Z={class:"lora-info-item"},ee=H((()=>m("div",{class:"lora-info-name"}," 静态层 ",-1))),ae={class:"lora-info-input"},le={class:"lora-info-item"},te=H((()=>m("div",{class:"lora-info-name"}," 提示词 ",-1))),ue={class:"lora-info-input"};var ie=O({__name:"index",setup(V){d();const T=e("explosionDiagramDom"),U=e("modelEditorDom"),O=e("addTypeDom"),H=e(null),ie=e(190),oe=e(220),ne=e(1),se=e([]),de=e(null),re=e(null),ve=e([]),me=e("editor"),pe=e([]),ce=e([]),ye=e(""),fe=e([]),ge=e([]),he=e(new Set),be=()=>{H.value.setName(ye.value)},we="editor",_e="explosion",ke=Object.keys(j).map((e=>({key:e,value:j[e]}))),De=e(j.NOMAL),Ce=e({width:0,height:0}),Ve=()=>{H.value.setCanvasSize({width:ie.value*ne.value,height:oe.value*ne.value}),Ce.value=H.value.getCanvasStyle()},Te=()=>{O.value.init()},je=e=>{H.value.addType(e).then((e=>{Ee(e)}))},xe=()=>{de.value=H.value.changeHandleType(de.value===I.HANDLE?I.DRAWING:I.HANDLE)},Se=()=>{H.value.getSaveData()},Ie=e=>{if("application/json"===e.type)return window.loading=A(),setTimeout((()=>{const a=new FileReader;a.onload=e=>{const a=e.target.result;try{const e=JSON.parse(a);H.value.setData(e).then((({typeList:e})=>{window.loading.close(),Ee(e),De.value=H.value.getDrawType(),Ce.value=H.value.getCanvasStyle(),ye.value=H.value.name}))}catch(l){s.error("无法解析json数据")}},a.readAsText(e)}),1e3),!1;s.error("导入格式有误")},Le=()=>{T.value.changeExplosionType("CHANGE")},Ue=()=>{pe.value=ce.value.filter((({uuid:e})=>!ve.value.find((a=>a===e))))},Oe=()=>{me.value===we?(H.value.removeListener(),H.value.getAllLayerImage().then((e=>{ce.value=Object.keys(e).map((a=>Object.assign({uuid:a,imageSrc:e[a].imageBase64},e[a]))).reverse(),Ue(),me.value=_e}))):(me.value=we,k((()=>{H.value.addListener()})))},Ae=()=>{H.value.changeDrawType(De.value)},Ee=(e=null)=>{e=e||H.value.getTypeList(),se.value=Object.keys(e).map((a=>(se.value.length||(H.value.setTypeUuid(a),re.value=a),{uuid:a,name:e[a].name,image:e[a].image,loraInfo:e[a].loraInfo})))},Ne=(...e)=>{H.value.bindLora(...e)},Be=()=>{E("prompts").then((e=>{const a=e?e.templates:{};fe.value=Object.keys(a)})),E("statics").then((e=>{const a=e?e.templates:{};ge.value=Object.keys(a)}))},Fe=(e,a)=>{const l={viewData:e};Object.keys(e.typeData).forEach((a=>{l[a]={statics:e.typeData[a].loraInfo.statics,prompts:e.typeData[a].loraInfo.prompts}}));const t=JSON.stringify(l),u=new Blob([t],{type:"application/json"}),i=new File([u],`${ye.value}.json`,{type:"application/json",lastModified:Date.now()}),o=new FormData;o.append("file",i),N(o,"layouts",ye.value,a).then((e=>{s.success("保存成功")}))},He=()=>{H.value.getSaveData(!1).then((e=>{let a=0;const l=L(e.preview,ye.value),t=new FormData;t.append("file",l),delete e.preview,F(ye.value,t).then((l=>{const t=l;Object.keys(e.typeData).forEach((l=>{const u=e.typeData[l];if(u.imageBase64&&u.imageBase64.includes("data:image/")){const i=L(u.imageBase64,l),o=new FormData;o.append("file",i),F(l,o).then((u=>{e.typeData[l].imageBase64=u,a+=1,a===Object.keys(e.typeData).length&&(Fe(e,t),H.value.setData(e).then((({typeList:e})=>{Ee(e),De.value=H.value.getDrawType(),Ce.value=H.value.getCanvasStyle()})))}))}else a+=1,a===Object.keys(e.typeData).length&&(Fe(e,t),H.value.setData(e).then((({typeList:e})=>{Ee(e),De.value=H.value.getDrawType(),Ce.value=H.value.getCanvasStyle()})))}))}))}))};return r((()=>{Be(),H.value=new x(U.value,{width:ie.value*ne.value,height:oe.value*ne.value,name:ye.value}),de.value=H.value.getHandleType(),ve.value=H.value.hideLayerList,Ce.value=H.value.getCanvasStyle(),window.loading||(window.loading=A()),setTimeout((()=>{window.loading.close(),window.loading=null}),300)})),(e,s)=>{const d=a("el-input"),r=a("el-form-item"),k=a("el-input-number"),V=a("el-option"),j=a("el-select"),x=a("t-button"),I=a("el-upload"),L=a("el-form"),A=a("el-icon"),E=a("el-scrollbar");return l(),v("div",M,[m("div",R,[m("div",q,[i(L,{inline:""},{default:u((()=>[i(r,{label:"模板名称"},{default:u((()=>[i(d,{style:{width:"3rem"},modelValue:ye.value,"onUpdate:modelValue":s[0]||(s[0]=e=>ye.value=e),onChange:be},null,8,["modelValue"])])),_:1}),i(r,{label:"宽度"},{default:u((()=>[i(k,{style:{width:"3rem"},modelValue:ie.value,"onUpdate:modelValue":s[1]||(s[1]=e=>ie.value=e),onChange:Ve,controls:!1,min:1},null,8,["modelValue"])])),_:1}),i(r,{label:"高度"},{default:u((()=>[i(k,{style:{width:"3rem"},modelValue:oe.value,"onUpdate:modelValue":s[2]||(s[2]=e=>oe.value=e),onChange:Ve,controls:!1,min:1},null,8,["modelValue"])])),_:1}),i(r,{label:"绘制模式"},{default:u((()=>[i(j,{style:{width:"3rem"},modelValue:De.value,"onUpdate:modelValue":s[3]||(s[3]=e=>De.value=e),onChange:Ae},{default:u((()=>[(l(!0),v(p,null,c(y(ke),(e=>(l(),t(V,{key:e.key,value:e.value,label:e.value},null,8,["value","label"])))),128))])),_:1},8,["modelValue"])])),_:1}),i(r,{label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:Te},{default:u((()=>[o("新建图层")])),_:1})])),_:1}),i(r,{label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:xe},{default:u((()=>[o(f(de.value),1)])),_:1})])),_:1}),i(r,{label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:Oe},{default:u((()=>[o(f("explosion"===me.value?"编辑器展示":"爆炸图展示"),1)])),_:1})])),_:1}),"explosion"===me.value?(l(),t(r,{key:0,label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:Le},{default:u((()=>[o("切换爆炸图展示模式")])),_:1})])),_:1})):n("",!0),"editor"===me.value?(l(),t(r,{key:1,label:"","label-width":"0"},{default:u((()=>[i(I,{class:"upload-demo","before-upload":Ie,accept:".json","show-file-list":!1,action:""},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"}},{default:u((()=>[o("导入数据")])),_:1})])),_:1})])),_:1})):n("",!0),"editor"===me.value?(l(),t(r,{key:2,label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:Se},{default:u((()=>[o("导出数据")])),_:1})])),_:1})):n("",!0),i(r,{label:"","label-width":"0"},{default:u((()=>[i(x,{type:"info",style:{height:"1rem",padding:"0.1rem","line-height":"1rem"},onClick:He},{default:u((()=>[o("保存")])),_:1})])),_:1})])),_:1})]),m("div",z,[g(m("div",{class:"model-editor-info",ref_key:"modelEditorDom",ref:U},null,512),[[h,"editor"===me.value]]),"explosion"===me.value?(l(),t(S,{key:0,explosionStyle:Ce.value,data:pe.value,ref_key:"explosionDiagramDom",ref:T},null,8,["explosionStyle","data"])):n("",!0)])]),m("div",G,[J,m("div",W,[i(E,null,{default:u((()=>[(l(!0),v(p,null,c(se.value,(e=>(l(),v("div",{key:e.uuid},[m("div",{class:b(["layer-item",{selected:re.value===e.uuid}]),onClick:a=>{return l=e.uuid,re.value=l,void H.value.setTypeUuid(l);var l}},[m("div",{class:"layer-select-area",onClick:w((a=>{return l=e.uuid,void(he.value.has(l)?he.value.delete(l):he.value.add(l));var l}),["stop"])},f(he.value.has(e.uuid)?"收起":"展开"),9,K),e.image?(l(),v("div",P,[m("img",{src:e.image.src},null,8,Q)])):n("",!0),m("div",X,f(e.name),1),m("div",{class:"layer-item-handle",onClick:s[4]||(s[4]=w((()=>{}),["stop"]))},[i(A,{onClick:a=>{return l=e.uuid,ve.value=H.value.hideHandle(l),void Ue();var l}},{default:u((()=>[(l(),t(_(ve.value.find((a=>a===e.uuid))===e.uuid?y(D):y(C))))])),_:2},1032,["onClick"])])],10,$),he.value.has(e.uuid)?(l(),v("div",Y,[m("div",Z,[ee,m("div",ae,[i(j,{multiple:"",modelValue:e.loraInfo.statics,"onUpdate:modelValue":a=>e.loraInfo.statics=a,onChange:a=>Ne(e.uuid,e.loraInfo.statics,"statics")},{default:u((()=>[(l(!0),v(p,null,c(ge.value,(e=>(l(),t(V,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])]),m("div",le,[te,m("div",ue,[i(j,{multiple:"",modelValue:e.loraInfo.prompts,"onUpdate:modelValue":a=>e.loraInfo.prompts=a,onChange:a=>Ne(e.uuid,e.loraInfo.prompts,"prompts")},{default:u((()=>[(l(!0),v(p,null,c(fe.value,(e=>(l(),t(V,{key:e,label:e,value:e},null,8,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])])])])):n("",!0)])))),128))])),_:1})])]),i(B,{ref_key:"addTypeDom",ref:O,onAddType:je},null,512)])}}},[["__scopeId","data-v-5b98534c"]]);export{ie as default};
